<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />
<meta name="format-detection" content="telephone=no" />
<title>ThromboLogic INR</title>

<style>
  :root{
    --blue:#eaf3ff; --blue-ring:rgba(13,110,253,.25);
    --ylw:#fffef0; --man:#ffe79a; --man-b:#ffc857;
    --card:#fafafa; --border:#e6e6e6; --muted:#666;
    --ok:#1f7a1f; --warn:#a15a00; --bad:#b00020;
    --shadow:0 10px 24px rgba(0,0,0,.05);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    margin:0; color:#111; background:#fff;
    overflow:hidden;
  }

  h1{font-size:19px;margin:0 0 8px}
  h2{font-size:15px;margin:16px 0 6px}
  .small{font-size:12px;color:var(--muted)}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}

  .app{height:100vh;display:flex;flex-direction:column;min-width:0}
  .topbar{
    flex:0 0 auto;
    display:flex;align-items:center;justify-content:space-between;gap:12px;
    padding:12px 14px;
    border-bottom:1px solid var(--border);
    background:#fff;
  }
  .brand{display:flex;align-items:center;gap:10px;min-width:0}
  .brand-title{line-height:1.05;min-width:0}
  .brand-title b{display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .brand-title .small{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  .logoImg{height:34px;width:auto;display:block}
  .logoFallback{
    width:34px;height:34px;border-radius:10px;
    background:linear-gradient(135deg,#0d6efd,#72a7ff);
    box-shadow:0 6px 16px rgba(13,110,253,.22);
    position:relative;overflow:hidden;display:none;
  }
  .logoFallback:before{content:"";position:absolute;inset:-8px;opacity:.22;background:
    radial-gradient(circle at 30% 30%, #fff 0 30%, transparent 31%),
    radial-gradient(circle at 70% 70%, #fff 0 22%, transparent 23%);
  }

  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:flex-end}
  .field{display:flex;flex-direction:column;gap:4px}
  .field label{font-size:12px;color:var(--muted)}
  input, select, textarea, button{
    font:inherit;
    border-radius:10px;
    border:1px solid var(--border);
    padding:8px 10px;
    background:#fff;
    outline:none;
  }
  input:focus, select:focus, textarea:focus{
    border-color:#0d6efd;
    box-shadow:0 0 0 4px var(--blue-ring);
  }
  textarea{min-height:88px;resize:vertical}

  .btn{background:#0d6efd;color:#fff;border:1px solid #0b5ed7;cursor:pointer;user-select:none}
  .btn:active{transform:translateY(1px)}
  .btn.secondary{background:#fff;color:#0d6efd;border-color:#cfe2ff}
  .btn.ghost{background:transparent;border-color:var(--border);color:#111}
  .btn.danger{background:#b00020;border-color:#8d001a}
  .btn.small{padding:6px 10px;border-radius:999px;font-size:12px}
  .sep{height:1px;background:var(--border);margin:10px 0}
  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .tab{padding:7px 10px;border-radius:999px;border:1px solid var(--border);background:#fff;cursor:pointer;font-size:12px}
  .tab.active{background:var(--blue);border-color:#cfe2ff;color:#0d6efd}
  .hint{font-size:12px;color:var(--muted);margin-top:6px}

  .main{
    flex:1 1 auto;
    min-height:0;
    display:grid;
    grid-template-columns:1fr;
    gap:12px;
    padding:12px;
    max-width:100vw;
    overflow:hidden;
  }
  @media (min-width: 980px){ .main{grid-template-columns: 1.1fr .9fr} }

  .card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:14px;
    padding:12px;
    box-shadow:var(--shadow);
    min-width:0;
    min-height:0;
  }
  .leftScroll{overflow:auto;max-height:100%}

  .cal-head{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
  .cal-controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .cal-scroll{
    overflow:auto;
    border-radius:12px;
    border:1px solid var(--border);
    background:#fff;
    padding:8px;
    margin-top:8px;
    max-height:calc(100vh - 230px);
  }
  .cal-grid{
    display:grid;
    grid-template-columns:repeat(7, minmax(140px, 1fr));
    gap:8px;
    min-width:980px;
  }
  .dow{font-size:11px;color:var(--muted);text-align:center}
  .day{
    background:#fff;border:1px solid var(--border);border-radius:12px;
    padding:8px;min-height:118px;display:flex;flex-direction:column;gap:6px;
  }
  .day .date{display:flex;justify-content:space-between;align-items:center;font-size:12px}
  .badge{font-size:10px;padding:2px 6px;border-radius:999px;border:1px solid var(--border);color:#333;background:#f7f7f7}
  .badge.today{background:var(--blue);border-color:#cfe2ff;color:#0d6efd}
  .badge.repeat{background:var(--man);border-color:var(--man-b);color:#5c3b00}
  .mini{display:grid;grid-template-columns:1fr;gap:6px}
  .mini input{padding:6px 8px;font-size:12px;border-radius:10px}
  .mini .lbl{font-size:10px;color:var(--muted);margin-top:-2px}
  .band-ok{background:#f1fff1;border-color:#cfe9cf}
  .band-warn{background:#fff7e6;border-color:#ffe2ad}
  .band-bad{background:#fff0f2;border-color:#ffd0d7}

  .kpi{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .kpi .box{background:#fff;border:1px solid var(--border);border-radius:12px;padding:10px}
  .kpi .big{font-size:18px;font-weight:700}
  .kpi .sub{font-size:12px;color:var(--muted)}
  .kpi .tag{display:inline-flex;align-items:center;gap:6px;font-size:11px;margin-top:6px;color:#333}
  .dot{width:8px;height:8px;border-radius:999px;background:#bbb;display:inline-block}
  .dot.ok{background:var(--ok)} .dot.warn{background:var(--warn)} .dot.bad{background:var(--bad)}

  .pillbox{
    display:flex; flex-wrap:wrap; gap:8px;
    padding:10px; background:#fff; border:1px solid var(--border); border-radius:12px;
  }
  .pill{
    display:inline-flex;align-items:center;gap:6px;font-size:12px;
    padding:6px 10px;border-radius:999px;background:var(--blue);border:1px solid #d7e7ff
  }
  .pill input{width:auto; padding:0; border:none; box-shadow:none}

  .results{
    display:none;
    margin-top:8px;
    border:1px solid var(--border);
    border-radius:12px;
    background:#fff;
    overflow:auto;
    max-height:220px;
  }
  .resultItem{
    padding:10px;
    border-bottom:1px solid var(--border);
    cursor:pointer;
    font-size:13px;
  }
  .resultItem:last-child{border-bottom:none}
  .resultItem:hover{background:#f7f7f7}
  .resultItem .name{font-weight:700}
  .resultItem .meta{color:var(--muted); font-size:12px; margin-top:2px}

  .modal-backdrop{
    position:fixed;inset:0;background:rgba(0,0,0,.35);
    display:none;align-items:center;justify-content:center;padding:16px;z-index:9999;
  }
  .modal{max-width:560px;width:100%;background:#fff;border-radius:16px;border:1px solid var(--border);box-shadow:0 20px 60px rgba(0,0,0,.25);padding:14px}
  .modal h3{margin:0 0 6px;font-size:15px}
  .modal .actions{display:flex;justify-content:flex-end;gap:8px;margin-top:10px;flex-wrap:wrap}

  @media print{
    body{margin:0;overflow:visible}
    .no-print{display:none !important}
    .card{box-shadow:none}
    .day{min-height:auto}
    .cal-scroll{max-height:none; overflow:visible; border:none; padding:0}
    .cal-grid{min-width:0; grid-template-columns:repeat(7, 1fr)}
  }
</style>
</head>

<body>
<div class="app">
  <div class="topbar no-print">
    <div class="brand">
      <img class="logoImg" id="logoImg" src="assets/thrombologic-logo.png" alt="ThromboLogic"
           onerror="this.style.display='none';document.getElementById('logoFallback').style.display='block';">
      <div class="logoFallback" id="logoFallback" aria-hidden="true"></div>

      <div class="brand-title">
        <b>ThromboLogic INR</b>
        <span class="small">INR 7.5.1 (INR-ALT)</span>
      </div>
    </div>
    <div class="row">
      <button class="btn small secondary" id="btnDemo">Load demo history</button>
      <button class="btn small ghost" id="btnClear">Clear all</button>
      <button class="btn small" id="btnPrint">Print / PDF</button>
    </div>
  </div>

  <div class="main">
    <!-- LEFT -->
    <div class="card leftScroll">
      <h1>Patient & INR entry</h1>

      <div class="row no-print">
        <div class="field" style="min-width:260px;flex:1">
          <label>Search (name, DOB, phone, MRN)</label>
          <input id="ptSearch" placeholder="Type at least 2 characters…" autocomplete="off" />
        </div>
        <button class="btn small ghost" id="btnSearch">Search</button>
        <button class="btn small secondary" id="btnSavePt">Save</button>
        <button class="btn small danger" id="btnDeletePt">Delete</button>
      </div>
      <div class="results no-print" id="searchResults"></div>

      <div class="row">
        <div class="field" style="min-width:220px;flex:1">
          <label>Patient name</label>
          <input id="ptName" placeholder="e.g., Jane Doe" autocomplete="off" />
        </div>

        <div class="field" style="width:160px">
          <label>DOB (DD/MM/YYYY)</label>
          <input id="dob" inputmode="numeric" placeholder="DD/MM/YYYY" maxlength="10" autocomplete="off" />
        </div>

        <div class="field" style="width:170px">
          <label>Phone</label>
          <input id="phone" inputmode="tel" placeholder="(###) ###-####" maxlength="14" autocomplete="off" />
        </div>

        <div class="field" style="width:150px">
          <label>MRN</label>
          <input id="mrn" placeholder="MRN" autocomplete="off" />
        </div>
      </div>

      <div class="row">
        <div class="field" style="width:140px">
          <label>Weight (kg)</label>
          <input id="wt" inputmode="decimal" placeholder="e.g., 72" />
        </div>
        <div class="field" style="width:140px">
          <label>CrCl (mL/min)</label>
          <input id="crcl" inputmode="decimal" placeholder="e.g., 55" />
        </div>
      </div>

      <div class="sep"></div>

      <h2 style="margin-top:0">Weekly maintenance regimen (mg)</h2>
      <div class="small">Enter scheduled maintenance doses. Copy will apply starting today (next 28 days).</div>
      <div class="row" id="regimenRow" style="margin-top:8px"></div>
      <div class="row no-print" style="justify-content:flex-end;margin-top:8px">
        <button class="btn small ghost" id="btnClearRegimen">Clear regimen</button>
        <button class="btn small" id="btnCopyRegimen">Copy regimen to calendar</button>
      </div>

      <div class="sep"></div>

      <div class="tabs no-print" id="tabs">
        <button class="tab active" data-tab="rec">Recommendation</button>
        <button class="tab" data-tab="bridge">Bridging</button>
        <button class="tab" data-tab="interact">Interactions</button>
        <button class="tab" data-tab="notes">Provider notes</button>
      </div>

      <!-- Recommendation -->
      <div id="tab-rec">
        <div class="row">
          <div class="field" style="width:170px">
            <label>Target INR range</label>
            <select id="targetRange">
              <option value="2.0-3.0" selected>2.0–3.0 (default)</option>
              <option value="2.5-3.5">2.5–3.5</option>
              <option value="1.8-2.5">1.8–2.5</option>
              <option value="custom">Custom…</option>
            </select>
          </div>
          <div class="field" id="customRangeWrap" style="display:none;width:210px">
            <label>Custom target (L–H)</label>
            <div class="row" style="gap:8px">
              <input id="customL" style="width:90px" inputmode="decimal" placeholder="L" />
              <input id="customH" style="width:90px" inputmode="decimal" placeholder="H" />
            </div>
          </div>

          <div class="field" style="min-width:260px;flex:1">
            <label>Current INR (today)</label>
            <input id="inrToday" inputmode="decimal" placeholder="e.g., 2.4" />
          </div>
        </div>

        <div class="sep"></div>
        <h2 style="margin:0 0 6px">Warfarin tablets on hand</h2>
        <div class="small">Select strengths available. Tablet suggestions allow halves (½ tablet).</div>
        <div class="pillbox" id="pillBox" style="margin-top:8px"></div>

        <div class="hint">
          Dose history below drives the <b>7-day total</b> and <b>lag-weighted dose</b>. You can enter scheduled + actual doses in the calendar.
        </div>

        <div class="sep"></div>

        <div class="kpi">
          <div class="box">
            <div class="big" id="kpiWeekly">—</div>
            <div class="sub">7-day total dose (mg)</div>
            <div class="tag"><span class="dot" id="dotWeekly"></span><span id="kpiWeeklySub">—</span></div>
          </div>
          <div class="box">
            <div class="big" id="kpiWeighted">—</div>
            <div class="sub">Lag-weighted dose (mg)</div>
            <div class="tag"><span class="dot" id="dotStreak"></span><span id="kpiStreak">Stability streak: —</span></div>
          </div>
        </div>

        <div class="sep"></div>

        <div class="card" style="background:#fff">
          <h2 style="margin-top:0">Verbal recommendation</h2>
          <div id="verbal" class="small" style="font-size:13px;color:#111;line-height:1.35"></div>
          <div class="hint" id="repeatLine"></div>
        </div>
      </div>

      <!-- Bridging -->
      <div id="tab-bridge" style="display:none">
        <h2 style="margin-top:10px">Bridging requirement</h2>
        <div class="row">
          <div class="field" style="min-width:260px;flex:1">
            <label>Bridging</label>
            <select id="bridgeNeed">
              <option value="no" selected>No bridging</option>
              <option value="yes">Bridging required</option>
            </select>
          </div>
          <div class="field" style="min-width:260px;flex:1">
            <label>Agent</label>
            <select id="bridgeAgent" disabled>
              <option value="enox" selected>Enoxaparin</option>
              <option value="fonda">Fondaparinux</option>
            </select>
          </div>
        </div>

        <div id="bridgeBox" style="display:none">
          <div class="sep"></div>
          <div class="row">
            <div class="field" style="min-width:220px;flex:1">
              <label>Indication note (optional)</label>
              <input id="bridgeInd" placeholder="e.g., peri-procedural, mechanical valve, VTE..." />
            </div>
            <div class="field" style="width:220px">
              <label>Dosing frequency (enox)</label>
              <select id="enoxFreq">
                <option value="q12" selected>1 mg/kg q12h</option>
                <option value="daily">1.5 mg/kg daily</option>
              </select>
            </div>
          </div>

          <div class="card" style="background:#fff;margin-top:10px">
            <div id="bridgeText" style="font-size:13px;line-height:1.35"></div>
            <div class="hint">Rounding rule: doses ending in <b>5 mg round down</b> to nearest 10; if ending >5, <b>round up</b> to nearest 10.</div>
          </div>
        </div>
      </div>

      <!-- Interactions -->
      <div id="tab-interact" style="display:none">
        <h2 style="margin-top:10px">Warfarin interaction check</h2>
        <div class="hint">Select any active or newly started meds. This can pull the repeat INR earlier.</div>

        <div class="row" style="margin-top:8px">
          <label class="pill"><input type="checkbox" class="intx" value="amio"> Amiodarone</label>
          <label class="pill"><input type="checkbox" class="intx" value="tmp"> TMP-SMX</label>
          <label class="pill"><input type="checkbox" class="intx" value="metro"> Metronidazole</label>
          <label class="pill"><input type="checkbox" class="intx" value="fluc"> Fluconazole/azole</label>
          <label class="pill"><input type="checkbox" class="intx" value="rif"> Rifampin</label>
          <label class="pill"><input type="checkbox" class="intx" value="pheny"> Phenytoin</label>
        </div>

        <div class="card" style="background:#fff;margin-top:10px">
          <div id="intxText" style="font-size:13px;line-height:1.35"></div>
        </div>
      </div>

      <!-- Notes -->
      <div id="tab-notes" style="display:none">
        <h2 style="margin-top:10px">Provider notes</h2>
        <textarea id="providerNotes">Click here to type provider notes before printing.</textarea>
        <div class="hint">Tip: This prints with the PDF. The placeholder clears on first typing.</div>
      </div>

      <div class="sep"></div>
      <div class="small mono" id="versionStamp" style="text-align:right;opacity:.75">—</div>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <div class="cal-head">
        <div>
          <h1 style="margin:0">5-week dosing calendar</h1>
          <div class="small">Today stays centered (middle row). Enter scheduled + actual dose, and INR.</div>
        </div>
        <div class="cal-controls no-print">
          <button class="btn small ghost" id="btnPrev">◀︎ Back</button>
          <button class="btn small ghost" id="btnToday">Today</button>
          <button class="btn small ghost" id="btnNext">Forward ▶︎</button>
        </div>
      </div>

      <div class="cal-scroll" id="calScroll">
        <div class="cal-grid">
          <div class="dow">Sun</div><div class="dow">Mon</div><div class="dow">Tue</div><div class="dow">Wed</div><div class="dow">Thu</div><div class="dow">Fri</div><div class="dow">Sat</div>
        </div>
        <div class="cal-grid" id="cal" style="margin-top:8px"></div>
      </div>

      <div class="sep"></div>
      <div class="small">
        <b>Lag-weighted dose</b> emphasizes recent days more than older days (last 7 days). It’s useful when a change was made mid-week.
      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal-backdrop" id="modal">
  <div class="modal">
    <h3 id="modalTitle">Notice</h3>
    <div id="modalBody" class="small" style="font-size:13px;color:#111;line-height:1.35"></div>
    <div class="actions" id="modalActions">
      <button class="btn secondary" id="modalClose">Close</button>
    </div>
  </div>
</div>

<script>
/* =========================
   ThromboLogic INR 7.5.1 (INR-ALT)
   Updates:
   - MRN duplication popup with next-step actions
   - "Clear all" clears the screen for next search (keeps saved DB)
   ========================= */

const VERSION = "INR 7.5.1 (INR-ALT)";
const BUILD_STAMP = new Date();

const DB_KEYS = {
  PATIENTS: "TL_PATIENTS_V1",
  ACTIVE: "TL_ACTIVE_PATIENT_ID_V1",
  LEGACY: "thrombologic_inr_7_5_1"
};

const DRAFT_ID = "__DRAFT__";

const $ = (id)=>document.getElementById(id);

const modal = {
  el: $("modal"),
  title: $("modalTitle"),
  body: $("modalBody"),
  actions: $("modalActions"),
  open(t,b,buttons){
    this.title.textContent = t || "Notice";
    this.body.innerHTML = b || "";
    this.actions.innerHTML = "";
    const btns = (buttons && buttons.length) ? buttons : [{label:"Close", cls:"btn secondary", onClick:()=>this.close()}];
    btns.forEach(def=>{
      const btn = document.createElement("button");
      btn.className = def.cls || "btn secondary";
      btn.textContent = def.label || "Close";
      btn.onclick = def.onClick || (()=>this.close());
      this.actions.appendChild(btn);
    });
    this.el.style.display = "flex";
  },
  close(){ this.el.style.display = "none"; }
};
$("modalClose").addEventListener("click", ()=>modal.close());
$("modal").addEventListener("click", (e)=>{ if(e.target === $("modal")) modal.close(); });

/* ---- dates ---- */
function pad2(n){ return String(n).padStart(2,"0"); }
function isoLocal(d){
  const x = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  return `${x.getFullYear()}-${pad2(x.getMonth()+1)}-${pad2(x.getDate())}`;
}
function fromIso(iso){
  const [y,m,dd] = iso.split("-").map(Number);
  return new Date(y, m-1, dd);
}
function addDaysLocal(d, n){
  const x = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  x.setDate(x.getDate() + n);
  return x;
}
function fmtMDY(d){
  return `${pad2(d.getMonth()+1)}/${pad2(d.getDate())}/${d.getFullYear()}`;
}
function fmtShort(d){
  return `${pad2(d.getMonth()+1)}/${pad2(d.getDate())}`;
}
function startOfWeekSun(d){
  const x = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const dow = x.getDay();
  x.setDate(x.getDate() - dow);
  return x;
}

/* ---- misc ---- */
function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
}
function toNum(x){
  const v = parseFloat(String(x||"").replace(/[^0-9.\-]/g,""));
  return isFinite(v) ? v : NaN;
}
function round1(x){
  return (Math.round(x*10)/10).toFixed(1).replace(/\.0$/,"");
}
function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); }
function normalizeForSearch(s){ return (s||"").toLowerCase().replace(/\s+/g," ").trim(); }

/* ---- Formatting: DOB + phone ---- */
function formatDOB_DDMMYYYY(rawDigits){
  const v = (rawDigits||"").replace(/[^\d]/g,"").slice(0,8);
  if(v.length<=2) return v;
  if(v.length<=4) return v.slice(0,2)+"/"+v.slice(2);
  return v.slice(0,2)+"/"+v.slice(2,4)+"/"+v.slice(4);
}
function isValidDOB_DDMMYYYY(dmy){
  if(!/^\d{2}\/\d{2}\/\d{4}$/.test(dmy)) return false;
  const [dd,mm,yy] = dmy.split("/").map(Number);
  if(mm<1||mm>12||dd<1||dd>31||yy<1900||yy>2100) return false;
  const d = new Date(yy, mm-1, dd);
  return d.getFullYear()===yy && (d.getMonth()+1)===mm && d.getDate()===dd;
}
function getAgeYearsFromDmy(dmy){
  if(!isValidDOB_DDMMYYYY(dmy)) return null;
  const [dd,mm,yy] = dmy.split("/").map(Number);
  const dob = new Date(yy,mm-1,dd);
  const today = new Date();
  let age = today.getFullYear()-dob.getFullYear();
  const m = today.getMonth()-dob.getMonth();
  if(m<0 || (m===0 && today.getDate()<dob.getDate())) age--;
  return age;
}
function formatPhone(rawDigits){
  const v = (rawDigits||"").replace(/[^\d]/g,"").slice(0,10);
  if(!v) return "";
  if(v.length<=3) return "(" + v;
  if(v.length<=6) return "(" + v.slice(0,3) + ") " + v.slice(3);
  return "(" + v.slice(0,3) + ") " + v.slice(3,6) + "-" + v.slice(6);
}

/* ---- Tablets ---- */
const DEFAULT_TABLETS = [0.5,1,2,2.5,3,4,5,6,7.5,10];

function suggestCombo(targetMg, tablets){
  const goal = Math.round(targetMg*100)/100;
  if(!isFinite(goal) || goal<=0) return {ok:false, msg:"Enter a valid dose."};
  const tabs = (tablets||[]).map(Number).filter(x=>isFinite(x)&&x>0);
  if(!tabs.length) return {ok:false, msg:"No tablet strengths selected."};

  const pieces = [];
  for(const t of tabs){ pieces.push(t); pieces.push(t/2); }
  const uniq = Array.from(new Set(pieces.map(x=>Math.round(x*100)/100))).sort((a,b)=>b-a);

  let best = null;
  function dfs(i, remaining, combo, used){
    remaining = Math.round(remaining*100)/100;
    if(remaining < -0.001) return;
    if(used > 12) return;
    if(Math.abs(remaining) <= 0.01){
      if(!best || used < best.used) best = {used, combo:[...combo]};
      return;
    }
    if(i >= uniq.length) return;
    const v = uniq[i];
    const maxN = Math.floor((remaining + 0.001)/v);
    for(let n=maxN; n>=0; n--){
      if(best && used+n >= best.used) continue;
      if(n>0) combo.push({mg:v, n});
      dfs(i+1, remaining - n*v, combo, used+n);
      if(n>0) combo.pop();
    }
  }
  dfs(0, goal, [], 0);

  if(!best){
    return {ok:false, msg:"Could not match this dose using selected tablets (even with halves). Consider ordering a new Rx strength."};
  }

  const lines = [];
  for(const item of best.combo){
    const mg = item.mg;
    const n = item.n;
    let label = `${mg} mg`;
    const whole = tabs.find(t => Math.abs(t - mg) < 0.001);
    const half = tabs.find(t => Math.abs(t/2 - mg) < 0.001);
    if(whole) label = `${whole} mg`;
    else if(half) label = `½ of ${half} mg`;
    lines.push(`${n} × ${label}`);
  }
  return {ok:true, msg: lines.join(", ")};
}

/* ---- Patient DB ---- */
function loadPatients(){
  try{
    const raw = localStorage.getItem(DB_KEYS.PATIENTS);
    const arr = raw ? JSON.parse(raw) : [];
    return Array.isArray(arr) ? arr : [];
  }catch{ return []; }
}
function savePatients(){ localStorage.setItem(DB_KEYS.PATIENTS, JSON.stringify(patients)); }

function makePatientId(meta){
  const mrn = (meta.mrn||"").trim();
  if(mrn) return `MRN:${mrn}`;
  const nm = normalizeForSearch(meta.ptName||"");
  const dob = (meta.dob||"").trim();
  const ph = (meta.phone||"").trim();
  return `P:${nm}|${dob}|${ph}`.replace(/\s+/g," ");
}
function matchesPatient(p, q){
  const qq = normalizeForSearch(q);
  if(!qq) return false;
  const blob = [p.id, p.meta?.ptName, p.meta?.dob, p.meta?.phone, p.meta?.mrn].map(normalizeForSearch).join(" | ");
  return blob.includes(qq);
}

function blankState(){
  return {
    ptName:"", dob:"", phone:"", mrn:"",
    wt:"", crcl:"",
    targetRange:"2.0-3.0", customL:"", customH:"",
    inrToday:"",
    providerNotes:"Click here to type provider notes before printing.",
    bridgeNeed:"no", bridgeAgent:"enox", bridgeInd:"", enoxFreq:"q12",
    interactions:[],
    regimen:{},
    tablets:[5],
    navOffsetWeeks:0,
    days:{}
  };
}

function loadLegacyState(){
  try{
    const raw = localStorage.getItem(DB_KEYS.LEGACY);
    if(!raw) return null;
    const parsed = JSON.parse(raw);
    if(!parsed || typeof parsed !== "object") return null;
    return parsed;
  }catch{ return null; }
}

let patients = loadPatients();
let activeId = localStorage.getItem(DB_KEYS.ACTIVE) || DRAFT_ID;
let draftState = blankState();

function ensureDB(){
  // Import legacy once if no patients
  if(!patients.length){
    const legacy = loadLegacyState();
    if(legacy){
      const s = Object.assign(blankState(), legacy);
      if(s.days){
        for(const k of Object.keys(s.days)){
          const d = s.days[k] || {};
          if(d.dose !== undefined && d.scheduled === undefined){
            d.scheduled = d.dose; delete d.dose;
          }
          s.days[k] = { scheduled: d.scheduled ?? "", actual: d.actual ?? "", inr: d.inr ?? "" };
        }
      }
      const meta = { ptName: s.ptName || "Imported patient", dob: s.dob || "", phone:"", mrn:"" };
      const id = makePatientId(meta);
      patients = [{ id, meta, state: s }];
      savePatients();
    }
  }
}

function activePatient(){
  if(activeId === DRAFT_ID) return { id:DRAFT_ID, meta:{}, state:draftState, isDraft:true };
  return patients.find(p=>p.id===activeId) || null;
}
function setActive(id){
  activeId = id;
  localStorage.setItem(DB_KEYS.ACTIVE, activeId);
  bindInputs();
  renderAll();
}

function showSearchResults(list){
  const box = $("searchResults");
  box.innerHTML = "";
  if(!list.length){ box.style.display="none"; return; }
  for(const p of list.slice(0,30)){
    const div = document.createElement("div");
    div.className = "resultItem";
    const meta = p.meta || {};
    div.innerHTML = `
      <div class="name">${escapeHtml(meta.ptName || "(No name)")}</div>
      <div class="meta">${escapeHtml([meta.mrn?`MRN ${meta.mrn}`:"", meta.dob?`DOB ${meta.dob}`:"", meta.phone||""].filter(Boolean).join(" • "))}</div>
    `;
    div.onclick = ()=>{
      setActive(p.id);
      box.style.display="none";
    };
    box.appendChild(div);
  }
  box.style.display="block";
}

/* ---- Regimen UI ---- */
function buildRegimenUI(){
  const row = $("regimenRow");
  row.innerHTML = "";
  const labels = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
  for(let i=0;i<7;i++){
    const f = document.createElement("div");
    f.className = "field";
    f.style.flex = "1 1 90px";
    f.style.minWidth = "90px";
    f.innerHTML = `<label>${labels[i]}</label><input id="reg_${i}" placeholder="mg" inputmode="decimal" />`;
    row.appendChild(f);

    f.querySelector(`#reg_${i}`).addEventListener("input", ()=>{
      const p = activePatient(); if(!p) return;
      const s = p.state;
      s.regimen = s.regimen || {};
      const v = toNum(f.querySelector(`#reg_${i}`).value);
      if(isFinite(v)) s.regimen[i] = v;
      else delete s.regimen[i];
      persistState();
    });
  }
}
function syncRegimenUI(){
  const p = activePatient(); if(!p) return;
  const reg = p.state.regimen || {};
  for(let i=0;i<7;i++){
    const el = document.getElementById(`reg_${i}`);
    if(!el) continue;
    const v = reg[i];
    el.value = (v===0 || v) ? String(v) : "";
  }
}

/* ---- Tablet UI ---- */
function buildTabletUI(){
  const box = $("pillBox");
  box.innerHTML = "";
  for(const mg of DEFAULT_TABLETS){
    const lab = document.createElement("label");
    lab.className = "pill";
    lab.innerHTML = `<input type="checkbox" data-mg="${mg}"> ${mg} mg`;
    box.appendChild(lab);
  }
  box.addEventListener("change", ()=>{
    const p = activePatient(); if(!p) return;
    const sels = Array.from(box.querySelectorAll("input[type=checkbox]"))
      .filter(x=>x.checked)
      .map(x=>parseFloat(x.getAttribute("data-mg")))
      .filter(x=>isFinite(x));
    p.state.tablets = sels;
    persistState();
    renderAll();
  });
}
function syncTabletUI(){
  const p = activePatient(); if(!p) return;
  const set = new Set((p.state.tablets || []).map(Number));
  Array.from($("pillBox").querySelectorAll("input[type=checkbox]")).forEach(cb=>{
    const mg = parseFloat(cb.getAttribute("data-mg"));
    cb.checked = set.has(mg);
  });
}

/* ---- persistence ---- */
function upsertPatientIntoDB(meta, state){
  const id = makePatientId(meta);
  const idx = patients.findIndex(p=>p.id===id);
  if(idx>=0){
    patients[idx].meta = Object.assign({}, patients[idx].meta, meta);
    patients[idx].state = Object.assign({}, patients[idx].state, state);
  }else{
    patients.push({ id, meta, state });
  }
  savePatients();
  return id;
}

function persistState(){
  const p = activePatient();
  if(!p) return;

  // Draft stays in-memory only until explicit Save
  if(p.isDraft) return;

  // Non-draft: persist
  const meta = p.meta || {};
  meta.ptName = p.state.ptName || "";
  meta.dob = p.state.dob || "";
  meta.phone = p.state.phone || "";
  meta.mrn = p.state.mrn || "";

  // If MRN newly set and duplicates exist: warn in Save flow (not in every keystroke)
  // So here we just persist to its current record.
  savePatients();
}

/* ---- bind ---- */
function bindInputs(){
  ensureDB();
  const p = activePatient();
  const s = p.state;

  $("ptName").value = s.ptName || "";
  $("dob").value = s.dob || "";
  $("phone").value = s.phone || "";
  $("mrn").value = s.mrn || "";
  $("wt").value = s.wt || "";
  $("crcl").value = s.crcl || "";

  $("targetRange").value = s.targetRange || "2.0-3.0";
  $("customL").value = s.customL || "";
  $("customH").value = s.customH || "";
  $("inrToday").value = s.inrToday || "";

  $("providerNotes").value = s.providerNotes || "";
  $("bridgeNeed").value = s.bridgeNeed || "no";
  $("bridgeAgent").value = s.bridgeAgent || "enox";
  $("bridgeInd").value = s.bridgeInd || "";
  $("enoxFreq").value = s.enoxFreq || "q12";

  document.querySelectorAll(".intx").forEach(cb=>{
    cb.checked = (s.interactions || []).includes(cb.value);
  });

  $("customRangeWrap").style.display = (s.targetRange === "custom") ? "block" : "none";

  const need = s.bridgeNeed === "yes";
  $("bridgeAgent").disabled = !need;
  $("bridgeBox").style.display = need ? "block" : "none";

  $("versionStamp").textContent = `${VERSION} • ${BUILD_STAMP.toLocaleString()}`;

  syncRegimenUI();
  syncTabletUI();
}

/* ---- data per day ---- */
function getDay(iso){
  const p = activePatient(); if(!p) return {scheduled:"", actual:"", inr:""};
  const s = p.state;
  if(!s.days) s.days = {};
  if(!s.days[iso]) s.days[iso] = {scheduled:"", actual:"", inr:""};
  const d = s.days[iso];
  if(d && d.dose !== undefined && d.scheduled === undefined){
    d.scheduled = d.dose; delete d.dose;
  }
  if(d.actual === undefined) d.actual = "";
  if(d.inr === undefined) d.inr = "";
  return s.days[iso];
}
function setDay(iso, patch){
  const p = activePatient(); if(!p) return;
  const s = p.state;
  s.days[iso] = Object.assign({}, getDay(iso), patch);
  if(!p.isDraft) savePatients();
  renderAll();
}

/* ---- calendar today centered ---- */
function calendarWindow(){
  const p = activePatient(); if(!p) return {days:[]};
  const s = p.state;
  const offsetWeeks = s.navOffsetWeeks || 0;
  const anchor = addDaysLocal(new Date(), offsetWeeks * 7);
  const start = addDaysLocal(startOfWeekSun(anchor), -14);
  const days = [];
  for(let i=0;i<35;i++){
    const d = addDaysLocal(start, i);
    days.push({date:d, iso:isoLocal(d)});
  }
  return {start, days, anchor};
}

function renderCalendar(){
  const cal = $("cal");
  cal.innerHTML = "";

  const p = activePatient(); if(!p) return;
  const s = p.state;

  const todayIso = isoLocal(new Date());
  const {days} = calendarWindow();
  const repeatIso = computeRepeatIso();

  days.forEach(({date, iso})=>{
    const cell = document.createElement("div");
    cell.className = "day";

    const isToday = iso === todayIso;
    const isRepeat = repeatIso && iso === repeatIso;

    const head = document.createElement("div");
    head.className = "date";
    head.innerHTML = `<span>${fmtShort(date)}</span>
      <span style="display:flex;gap:6px;align-items:center">
        ${isRepeat ? `<span class="badge repeat">Repeat INR</span>` : ``}
        ${isToday ? `<span class="badge today">Today</span>` : `<span class="badge"> </span>`}
      </span>`;

    const mini = document.createElement("div");
    mini.className = "mini";

    const dayData = getDay(iso);

    const sched = document.createElement("input");
    sched.placeholder = "Scheduled (mg)";
    sched.inputMode = "decimal";
    sched.value = dayData.scheduled ?? "";
    sched.addEventListener("input", ()=> setDay(iso, {scheduled: sched.value}));

    const schedLbl = document.createElement("div");
    schedLbl.className = "lbl";
    schedLbl.textContent = "Scheduled dose";

    const actual = document.createElement("input");
    actual.placeholder = "Actual (mg)";
    actual.inputMode = "decimal";
    actual.value = dayData.actual ?? "";
    actual.addEventListener("input", ()=> setDay(iso, {actual: actual.value}));

    const actualLbl = document.createElement("div");
    actualLbl.className = "lbl";
    actualLbl.textContent = "Actual dose (if different)";

    const inr = document.createElement("input");
    inr.placeholder = "INR";
    inr.inputMode = "decimal";
    inr.step = "0.1";
    inr.value = dayData.inr ?? "";
    inr.addEventListener("input", ()=> setDay(iso, {inr: inr.value}));

    const inrLbl = document.createElement("div");
    inrLbl.className = "lbl";
    inrLbl.textContent = "INR (if checked)";

    mini.appendChild(sched); mini.appendChild(schedLbl);
    mini.appendChild(actual); mini.appendChild(actualLbl);
    mini.appendChild(inr); mini.appendChild(inrLbl);

    cell.appendChild(head);
    cell.appendChild(mini);

    const vToday = toNum(s.inrToday);
    const v = isFinite(vToday) ? vToday : toNum(dayData.inr);
    const {L,H} = getTargetRange();
    if(isFinite(v)){
      if(v>=L && v<=H) cell.classList.add("band-ok");
      else if(v>H && v<=H+1.5) cell.classList.add("band-warn");
      else if(v<L && v>=Math.max(0, L-0.7)) cell.classList.add("band-warn");
      else cell.classList.add("band-bad");
    }

    cal.appendChild(cell);
  });
}

/* ---- computations ---- */
function getTargetRange(){
  const p = activePatient(); if(!p) return {L:2.0,H:3.0,label:"2.0–3.0"};
  const s = p.state;

  if(s.targetRange === "custom"){
    const L = toNum(s.customL);
    const H = toNum(s.customH);
    if(isFinite(L) && isFinite(H) && L>0 && H>L) return {L, H, label:`${L.toFixed(1)}–${H.toFixed(1)}`};
    return {L:2.0, H:3.0, label:"2.0–3.0"};
  }
  const [L,H] = s.targetRange.split("-").map(Number);
  return {L, H, label:`${L.toFixed(1)}–${H.toFixed(1)}`};
}
function last7IsoList(){
  const today = new Date();
  const arr = [];
  for(let i=6;i>=0;i--) arr.push(isoLocal(addDaysLocal(today, -i)));
  return arr;
}
function effectiveDoseForIso(iso){
  const d = getDay(iso);
  const a = toNum(d.actual);
  if(isFinite(a)) return a;
  const s = toNum(d.scheduled);
  return isFinite(s) ? s : NaN;
}
function sum7DayDose(){
  const list = last7IsoList();
  let sum = 0;
  list.forEach(iso=>{
    const v = effectiveDoseForIso(iso);
    if(isFinite(v)) sum += v;
  });
  return sum;
}
function lagWeightedDose(){
  const weights = [0.15,0.20,0.30,0.45,0.65,0.85,1.00];
  const list = last7IsoList();
  let wsum = 0, wtot = 0;
  list.forEach((iso, idx)=>{
    const dose = effectiveDoseForIso(iso);
    if(isFinite(dose)){
      wsum += dose * weights[idx];
      wtot += weights[idx];
    }
  });
  return wtot>0 ? (wsum / wtot) * 7 : 0;
}
function stabilityStreak(){
  const today = new Date();
  let streak = 0;
  let prev = null;
  for(let i=1;i<=21;i++){
    const iso = isoLocal(addDaysLocal(today, -i));
    const d = effectiveDoseForIso(iso);
    if(!isFinite(d)) break;
    if(prev === null){ prev = d; streak = 1; continue; }
    if(Math.abs(d - prev) <= 0.5){ streak++; prev = d; }
    else break;
  }
  return streak;
}
function interactionRepeatOverrideDays(){
  const p = activePatient(); if(!p) return null;
  const ints = p.state.interactions || [];
  if(!ints.length) return null;
  if(ints.some(x=>["amio","tmp","metro","fluc"].includes(x))) return 3;
  if(ints.includes("rif")) return 5;
  if(ints.includes("pheny")) return 7;
  return null;
}
function interactionNarrative(){
  const p = activePatient(); if(!p) return "—";
  const ints = p.state.interactions || [];
  if(!ints.length) return `No interactions selected.`;
  const items = [];
  if(ints.includes("amio")) items.push(`<b>Amiodarone:</b> may increase INR—often needs dose reduction + closer INR monitoring.`);
  if(ints.includes("tmp")) items.push(`<b>TMP-SMX:</b> can significantly increase INR—monitor closely; consider empiric reduction per protocol.`);
  if(ints.includes("metro")) items.push(`<b>Metronidazole:</b> can increase INR—monitor closely; consider empiric reduction per protocol.`);
  if(ints.includes("fluc")) items.push(`<b>Azoles (e.g., fluconazole):</b> can increase INR—monitor closely; consider empiric reduction per protocol.`);
  if(ints.includes("rif")) items.push(`<b>Rifampin:</b> can lower INR—may require dose increases and frequent monitoring.`);
  if(ints.includes("pheny")) items.push(`<b>Phenytoin:</b> complex interaction—monitor INR and phenytoin levels as appropriate.`);
  const pulled = interactionRepeatOverrideDays();
  const extra = pulled ? `<div class="sep"></div><b>Repeat INR suggestion:</b> pull to <b>${pulled} day(s)</b> due to interaction risk.` : "";
  return items.join("<br>") + extra;
}

function computeRecommendation(){
  const p = activePatient(); if(!p) return {repeatDays:7, baseLine:"—", plan:"—"};
  const s = p.state;
  const {L,H,label} = getTargetRange();
  const inr = toNum(s.inrToday);
  const weekly = sum7DayDose();
  const wtd = lagWeightedDose();

  const age = getAgeYearsFromDmy(s.dob);
  const hasAge = isFinite(age);

  let baseLine = "", plan = "", repeatDays = 7, holds = 0, pct = 0, context = "";

  if(isFinite(inr)){
    if(inr < 1.5){ pct=+15; repeatDays=3;
      baseLine=`INR <b>${inr.toFixed(1)}</b> is <b>below</b> target (<b>${label}</b>).`;
      plan=`Increase weekly dose by ~<b>${pct}%</b> and consider a one-time “boost” dose per protocol if appropriate.`;
    } else if(inr < L){ pct=+10; repeatDays=7;
      baseLine=`INR <b>${inr.toFixed(1)}</b> is <b>below</b> target (<b>${label}</b>).`;
      plan=`Increase weekly dose by ~<b>${pct}%</b>.`;
    } else if(inr <= H){ pct=0; repeatDays=14;
      baseLine=`INR <b>${inr.toFixed(1)}</b> is <b>in range</b> (<b>${label}</b>).`;
      plan=`Continue current regimen.`;
    } else if(inr <= 3.5){ pct=-10; repeatDays=7;
      baseLine=`INR <b>${inr.toFixed(1)}</b> is <b>above</b> target (<b>${label}</b>).`;
      plan=`Decrease weekly dose by ~<b>${Math.abs(pct)}%</b>.`;
    } else if(inr <= 4.5){ pct=-15; repeatDays=3; holds=1;
      baseLine=`INR <b>${inr.toFixed(1)}</b> is <b>above</b> target (<b>${label}</b>).`;
      plan=`Hold <b>1 dose</b> then decrease weekly dose by ~<b>${Math.abs(pct)}%</b>.`;
    } else { pct=-20; repeatDays=2; holds=2;
      baseLine=`INR <b>${inr.toFixed(1)}</b> is <b>significantly above</b> target (<b>${label}</b>).`;
      plan=`Hold warfarin and follow high-INR protocol (consider vitamin K per clinical context). Recheck INR soon.`;
    }

    if(hasAge && age >= 80 && repeatDays > 3) repeatDays = Math.max(3, repeatDays-2);
    if(hasAge && age <= 3 && repeatDays > 3) repeatDays = Math.max(3, repeatDays-2);
    context = `Target INR: <b>${label}</b>.`;
  } else {
    baseLine = `Enter today’s INR to generate a recommendation.`;
    plan = `You can still use the calendar to record doses and prior INRs.`;
    repeatDays = 7;
  }

  const currentWeekly = (weekly>0 ? weekly : (wtd>0 ? wtd : 0));
  const suggestedWeekly = currentWeekly>0 ? (currentWeekly * (1 + pct/100)) : 0;

  const intxMinDays = interactionRepeatOverrideDays();
  if(intxMinDays !== null) repeatDays = Math.min(repeatDays, intxMinDays);

  let predLine = "";
  if(isFinite(inr) && currentWeekly>0 && suggestedWeekly>0 && pct !== 0){
    const ratio = suggestedWeekly / currentWeekly;
    const pred = clamp(inr * Math.pow(ratio, 0.6), 0.8, 7.5);
    predLine = `Estimated INR after dose change (rough): <b>${pred.toFixed(1)}</b>.`;
  }

  const doseLine = currentWeekly>0
    ? `Current 7-day total: <b>${round1(currentWeekly)}</b> mg. Lag-weighted (7-day-eq): <b>${round1(wtd)}</b> mg.`
    : `No recent dose totals found in the last 7 days—fill in doses for better guidance.`;

  const sugLine = (suggestedWeekly>0 && pct!==0)
    ? `Suggested 7-day total after adjustment: <b>${round1(suggestedWeekly)}</b> mg (~${pct>0?"+":""}${pct}%).`
    : "";

  const avgNow = currentWeekly>0 ? (currentWeekly/7) : NaN;
  const avgNew = suggestedWeekly>0 ? (suggestedWeekly/7) : NaN;

  let tabletLine = "";
  const tabs = (s.tablets || []).map(Number).filter(x=>isFinite(x)&&x>0);
  if(isFinite(avgNew) && avgNew>0){
    if(tabs.length){
      const res = suggestCombo(avgNew, tabs);
      tabletLine = res.ok
        ? `Example tablets for ~${round1(avgNew)} mg/day: <b>${escapeHtml(res.msg)}</b>.`
        : `Example tablets: <b>no good match</b> using current strengths — consider a new Rx strength.`;
    } else {
      tabletLine = `Select tablet strengths on hand to generate tablet-based dosing suggestions.`;
    }
  }

  const avgLine = (isFinite(avgNow) && isFinite(avgNew) && pct!==0)
    ? `Average daily dose guide: <b>${round1(avgNew)}</b> mg/day (was ${round1(avgNow)}). ${tabletLine}`
    : (tabletLine ? tabletLine : "");

  const holdLine = holds>0 ? `<b>Hold:</b> ${holds} dose${holds===1?"":"s"} (clinical discretion).` : "";

  return { baseLine, plan, context, doseLine, sugLine, avgLine, predLine, repeatDays, holdLine };
}

function computeRepeatIso(){
  const r = computeRecommendation();
  return isoLocal(addDaysLocal(new Date(), r.repeatDays));
}

/* ---- bridging ---- */
function roundEnoxTo10(mg){
  const v = Math.round(mg);
  const mod = v % 10;
  if(mod === 5) return v - 5;
  if(mod > 5) return v + (10 - mod);
  return v - mod;
}
function renderBridging(){
  const p = activePatient(); if(!p) return;
  const s = p.state;
  const need = s.bridgeNeed === "yes";
  $("bridgeText").innerHTML = need ? "—" : "";
  if(!need) return;

  const wt = toNum(s.wt);
  const crcl = toNum(s.crcl);
  const agent = s.bridgeAgent;

  let html = "";
  if(!isFinite(wt) || wt<=0){
    html = `Enter <b>weight (kg)</b> to calculate bridging dosing.`;
    $("bridgeText").innerHTML = html;
    return;
  }

  if(agent === "enox"){
    const renal = isFinite(crcl) ? crcl : null;
    const isSevere = (renal !== null && renal < 30);
    const freq = isSevere ? "daily" : s.enoxFreq;
    const perKg = (freq === "q12") ? 1.0 : 1.5;
    const raw = wt * perKg;
    const rounded = roundEnoxTo10(raw);
    const sig = isSevere ? `<span style="color:var(--bad)"><b>CrCl < 30:</b> use 1 mg/kg daily</span>` : `<span class="small">CrCl ≥ 30 (or unknown): standard dosing</span>`;
    html = `
      <div><b>Enoxaparin bridging:</b> ${s.bridgeInd ? `(${escapeHtml(s.bridgeInd)})` : ""}</div>
      <div class="sep"></div>
      <div>Calculated dose: <b>${Math.round(raw)} mg</b> → rounded: <b>${rounded} mg</b></div>
      <div>Frequency: <b>${(isSevere ? "1 mg/kg daily" : (freq==="q12" ? "1 mg/kg q12h" : "1.5 mg/kg daily"))}</b></div>
      <div class="small" style="margin-top:6px">${sig}</div>
    `;
  } else {
    const renal = toNum(s.crcl);
    if(isFinite(renal) && renal < 30){
      html = `<div><b>Fondaparinux:</b> <span style="color:var(--bad)"><b>contraindicated if CrCl < 30</b></span>. Choose alternate bridging strategy.</div>`;
    } else {
      let dose = 7.5;
      if(wt < 50) dose = 5;
      else if(wt > 100) dose = 10;
      html = `
        <div><b>Fondaparinux bridging:</b> ${s.bridgeInd ? `(${escapeHtml(s.bridgeInd)})` : ""}</div>
        <div class="sep"></div>
        <div>Weight-based dose: <b>${dose} mg SC daily</b></div>
        <div class="small" style="margin-top:6px">Avoid if CrCl < 30; monitor per institutional protocol.</div>
      `;
    }
  }
  $("bridgeText").innerHTML = html;
}

/* ---- KPI + verbal ---- */
function renderKPIs(){
  const p = activePatient(); if(!p) return;
  const s = p.state;

  const weekly = sum7DayDose();
  const wtd = lagWeightedDose();
  const streak = stabilityStreak();

  $("kpiWeekly").textContent = weekly>0 ? `${round1(weekly)} mg` : "—";
  $("kpiWeighted").textContent = wtd>0 ? `${round1(wtd)} mg` : "—";

  const inr = toNum(s.inrToday);
  const {L,H} = getTargetRange();
  const dotWeekly = $("dotWeekly");
  dotWeekly.className = "dot";
  if(isFinite(inr)){
    if(inr>=L && inr<=H) dotWeekly.classList.add("ok");
    else if(inr>H && inr<=H+1.5) dotWeekly.classList.add("warn");
    else if(inr<L && inr>=Math.max(0, L-0.7)) dotWeekly.classList.add("warn");
    else dotWeekly.classList.add("bad");
  }

  const dotStreak = $("dotStreak");
  dotStreak.className = "dot";
  if(streak >= 10) dotStreak.classList.add("ok");
  else if(streak >= 4) dotStreak.classList.add("warn");
  else dotStreak.classList.add("bad");

  $("kpiWeeklySub").textContent = isFinite(inr) ? `Current INR: ${inr.toFixed(1)}` : "Enter today’s INR";
  $("kpiStreak").textContent = `Stability streak: ${streak} day${streak===1?"":"s"}`;
}
function renderVerbal(){
  const p = activePatient(); if(!p) return;
  const s = p.state;

  const r = computeRecommendation();
  const repIso = computeRepeatIso();
  const repDate = fromIso(repIso);

  const pt = s.ptName ? `<b>${escapeHtml(s.ptName)}</b>: ` : "";
  const age = getAgeYearsFromDmy(s.dob);
  const ageTxt = isFinite(age) ? ` Age: <b>${age}</b>.` : "";

  let bridgeLine = "";
  if(s.bridgeNeed === "yes"){
    bridgeLine = ` Bridging: <b>required</b> (${s.bridgeAgent === "enox" ? "enoxaparin" : "fondaparinux"}).`;
  }
  let intxLine = "";
  const pulled = interactionRepeatOverrideDays();
  if((s.interactions||[]).length){
    intxLine = ` Interaction risk present${pulled?` (repeat INR pulled to ≤ ${pulled} day(s))`:""}.`;
  }

  const body = `
    ${pt}${r.baseLine} ${r.context}${ageTxt}${bridgeLine}${intxLine}
    <div class="sep"></div>
    • ${r.doseLine}
    ${r.sugLine ? `<br>• ${r.sugLine}` : ``}
    ${r.avgLine ? `<br>• ${r.avgLine}` : ``}
    ${r.predLine ? `<br>• ${r.predLine}` : ``}
    ${r.holdLine ? `<br>• ${r.holdLine}` : ``}
    <br>• ${r.plan}
  `;
  $("verbal").innerHTML = body;
  $("repeatLine").innerHTML = `<b>Repeat INR:</b> <b>${fmtMDY(repDate)}</b> (in ${r.repeatDays} day${r.repeatDays===1?"":"s"}).`;
}
function renderInteractions(){ $("intxText").innerHTML = interactionNarrative(); }

/* ---- tablet sync ---- */
function syncTabletUI(){
  const p = activePatient(); if(!p) return;
  const set = new Set((p.state.tablets || []).map(Number));
  Array.from($("pillBox").querySelectorAll("input[type=checkbox]")).forEach(cb=>{
    const mg = parseFloat(cb.getAttribute("data-mg"));
    cb.checked = set.has(mg);
  });
}

/* ---- regimen + tablet builders ---- */
function initPills(){
  const box = $("pillBox");
  box.innerHTML = "";
  for(const mg of DEFAULT_TABLETS){
    const lab = document.createElement("label");
    lab.className = "pill";
    lab.innerHTML = `<input type="checkbox" data-mg="${mg}"> ${mg} mg`;
    box.appendChild(lab);
  }
  box.addEventListener("change", ()=>{
    const p = activePatient(); if(!p) return;
    const sels = Array.from(box.querySelectorAll("input[type=checkbox]"))
      .filter(x=>x.checked)
      .map(x=>parseFloat(x.getAttribute("data-mg")))
      .filter(x=>isFinite(x));
    p.state.tablets = sels;
    if(!p.isDraft) savePatients();
    renderAll();
  });
}
function initRegimen(){
  const row = $("regimenRow");
  row.innerHTML = "";
  const labels = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
  for(let i=0;i<7;i++){
    const f = document.createElement("div");
    f.className = "field";
    f.style.flex = "1 1 90px";
    f.style.minWidth = "90px";
    f.innerHTML = `<label>${labels[i]}</label><input id="reg_${i}" placeholder="mg" inputmode="decimal" />`;
    row.appendChild(f);

    f.querySelector(`#reg_${i}`).addEventListener("input", ()=>{
      const p = activePatient(); if(!p) return;
      const s = p.state;
      s.regimen = s.regimen || {};
      const v = toNum(f.querySelector(`#reg_${i}`).value);
      if(isFinite(v)) s.regimen[i] = v;
      else delete s.regimen[i];
      if(!p.isDraft) savePatients();
    });
  }
}

/* ---- UI helpers ---- */
function syncRegimenUI(){
  const p = activePatient(); if(!p) return;
  const reg = p.state.regimen || {};
  for(let i=0;i<7;i++){
    const el = document.getElementById(`reg_${i}`);
    if(!el) continue;
    const v = reg[i];
    el.value = (v===0 || v) ? String(v) : "";
  }
}

/* ---- render all ---- */
function renderAll(){
  renderCalendar();
  renderKPIs();
  renderVerbal();
  renderBridging();
  renderInteractions();
}

/* ---- actions: save / delete / clear ---- */
function currentMetaFromUI(){
  return {
    ptName: $("ptName").value.trim(),
    dob: $("dob").value.trim(),
    phone: $("phone").value.trim(),
    mrn: $("mrn").value.trim()
  };
}
function currentStateFromUI(){
  const p = activePatient(); if(!p) return blankState();
  return p.state;
}

function ensureTodayINROnCalendar(){
  const p = activePatient(); if(!p) return;
  const s = p.state;
  const vInr = toNum(s.inrToday);
  if(isFinite(vInr)){
    const todayIso = isoLocal(new Date());
    const d = getDay(todayIso);
    d.inr = String(vInr);
    s.days[todayIso] = d;
  }
}

function saveFlow(){
  const meta = currentMetaFromUI();
  const p = activePatient(); if(!p) return;

  // Basic guard: don't save totally empty patient
  const hasAny = !!(meta.ptName || meta.dob || meta.phone || meta.mrn);
  if(!hasAny){
    modal.open("Nothing to save", "Enter at least a name, DOB, phone, or MRN before saving.", [
      {label:"Close", cls:"btn secondary", onClick:()=>modal.close()}
    ]);
    return;
  }

  // MRN duplication handling
  const mrn = (meta.mrn||"").trim();
  if(mrn){
    const targetId = `MRN:${mrn}`;
    const exists = patients.find(x=>x.id === targetId);
    const isCurrentSame = (!p.isDraft && p.id === targetId);

    if(exists && !isCurrentSame){
      const existingMeta = exists.meta || {};
      modal.open(
        "MRN already exists",
        `A patient record with MRN <b>${escapeHtml(mrn)}</b> already exists:<br>
         <div style="margin-top:8px;padding:10px;border:1px solid var(--border);border-radius:12px;background:#fff">
           <div><b>${escapeHtml(existingMeta.ptName || "(No name)")}</b></div>
           <div class="small">${escapeHtml([existingMeta.dob?`DOB ${existingMeta.dob}`:"", existingMeta.phone||""].filter(Boolean).join(" • "))}</div>
         </div>
         <div class="hint" style="margin-top:8px">
           Choose what to do next.
         </div>`,
        [
          {label:"Open existing", cls:"btn secondary", onClick:()=>{
            modal.close();
            setActive(targetId);
          }},
          {label:"Merge into existing", cls:"btn", onClick:()=>{
            // Merge current draft/current state into existing MRN patient
            const curState = currentStateFromUI();
            exists.meta = Object.assign({}, exists.meta, meta);
            exists.state = Object.assign({}, exists.state, curState);
            savePatients();
            modal.close();
            setActive(targetId);
          }},
          {label:"Cancel", cls:"btn ghost", onClick:()=>modal.close()}
        ]
      );
      return;
    }
  }

  // Normal save:
  const state = currentStateFromUI();
  ensureTodayINROnCalendar();

  const id = makePatientId(meta);
  const idx = patients.findIndex(x=>x.id===id);

  if(idx>=0){
    patients[idx].meta = Object.assign({}, patients[idx].meta, meta);
    patients[idx].state = Object.assign({}, patients[idx].state, state);
  }else{
    patients.push({id, meta, state});
  }
  savePatients();

  // If we were draft, now switch to saved
  setActive(id);

  modal.open("Saved", "Patient record saved.", [
    {label:"OK", cls:"btn secondary", onClick:()=>modal.close()}
  ]);
}

function deleteFlow(){
  const p = activePatient(); if(!p) return;
  if(p.isDraft){
    modal.open("Delete", "You’re in a new (unsaved) entry. Use <b>Clear all</b> to reset the screen.", [
      {label:"OK", cls:"btn secondary", onClick:()=>modal.close()}
    ]);
    return;
  }
  const name = p.meta?.ptName || p.id;
  if(!confirm(`Delete patient "${name}"? This cannot be undone.`)) return;
  patients = patients.filter(x=>x.id !== p.id);
  savePatients();
  // back to draft
  draftState = blankState();
  setActive(DRAFT_ID);
  $("ptSearch").value = "";
  $("searchResults").style.display = "none";
  bindInputs();
  renderAll();
}

function clearScreenFlow(){
  // ✅ Clears all entered data and prepares for next search (keeps saved DB)
  draftState = blankState();
  setActive(DRAFT_ID);

  $("ptSearch").value = "";
  $("searchResults").style.display = "none";

  // reset tabs to recommendation
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  document.querySelector('.tab[data-tab="rec"]').classList.add("active");
  $("tab-rec").style.display = "block";
  $("tab-bridge").style.display = "none";
  $("tab-interact").style.display = "none";
  $("tab-notes").style.display = "none";

  bindInputs();
  renderAll();
}

/* ---- event hooks ---- */
function hookEvents(){
  const sync = ()=>{
    const p = activePatient(); if(!p) return;
    const s = p.state;

    s.ptName = $("ptName").value.trim();
    s.dob = $("dob").value.trim();
    s.phone = $("phone").value.trim();
    s.mrn = $("mrn").value.trim();
    s.wt = $("wt").value.trim();
    s.crcl = $("crcl").value.trim();

    s.targetRange = $("targetRange").value;
    s.customL = $("customL").value.trim();
    s.customH = $("customH").value.trim();
    s.inrToday = $("inrToday").value.trim();

    s.providerNotes = $("providerNotes").value;
    s.bridgeNeed = $("bridgeNeed").value;
    s.bridgeAgent = $("bridgeAgent").value;
    s.bridgeInd = $("bridgeInd").value.trim();
    s.enoxFreq = $("enoxFreq").value;

    const ints = [];
    document.querySelectorAll(".intx").forEach(cb=>{ if(cb.checked) ints.push(cb.value); });
    s.interactions = ints;

    $("customRangeWrap").style.display = (s.targetRange === "custom") ? "block" : "none";
    const need = s.bridgeNeed === "yes";
    $("bridgeAgent").disabled = !need;
    $("bridgeBox").style.display = need ? "block" : "none";

    // current INR -> today's calendar
    ensureTodayINROnCalendar();

    if(!p.isDraft) savePatients();
    renderAll();
  };

  ["ptName","wt","crcl","mrn","targetRange","customL","customH","inrToday","bridgeNeed","bridgeAgent","bridgeInd","enoxFreq"]
    .forEach(id => $(id).addEventListener("input", sync));

  $("phone").addEventListener("input", (e)=>{ e.target.value = formatPhone(e.target.value); sync(); });
  $("dob").addEventListener("input", (e)=>{ e.target.value = formatDOB_DDMMYYYY(e.target.value); sync(); });
  $("dob").addEventListener("blur", ()=>{
    const v = $("dob").value.trim();
    if(v && !isValidDOB_DDMMYYYY(v)){
      modal.open("DOB format", `Please enter DOB as <b>DD/MM/YYYY</b> (example: 26/01/1970).`);
    }
  });

  $("providerNotes").addEventListener("focus", ()=>{
    const ta = $("providerNotes");
    const p = activePatient(); if(!p) return;
    if(ta.value.trim() === "Click here to type provider notes before printing."){
      ta.value = "";
      p.state.providerNotes = "";
      if(!p.isDraft) savePatients();
    }
  });
  $("providerNotes").addEventListener("input", sync);

  document.querySelectorAll(".intx").forEach(cb=>cb.addEventListener("change", sync));

  $("tabs").addEventListener("click", (e)=>{
    const btn = e.target.closest(".tab");
    if(!btn) return;
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    btn.classList.add("active");
    const tab = btn.dataset.tab;
    $("tab-rec").style.display = tab==="rec" ? "block":"none";
    $("tab-bridge").style.display = tab==="bridge" ? "block":"none";
    $("tab-interact").style.display = tab==="interact" ? "block":"none";
    $("tab-notes").style.display = tab==="notes" ? "block":"none";
  });

  $("btnPrev").addEventListener("click", ()=>{
    const p = activePatient(); if(!p) return;
    p.state.navOffsetWeeks = (p.state.navOffsetWeeks || 0) - 1;
    if(!p.isDraft) savePatients();
    renderAll();
  });
  $("btnNext").addEventListener("click", ()=>{
    const p = activePatient(); if(!p) return;
    p.state.navOffsetWeeks = (p.state.navOffsetWeeks || 0) + 1;
    if(!p.isDraft) savePatients();
    renderAll();
  });
  $("btnToday").addEventListener("click", ()=>{
    const p = activePatient(); if(!p) return;
    p.state.navOffsetWeeks = 0;
    if(!p.isDraft) savePatients();
    renderAll();
  });

  $("btnSearch").addEventListener("click", ()=>{
    const q = $("ptSearch").value.trim();
    if(q.length < 2){ $("searchResults").style.display="none"; return; }
    showSearchResults(patients.filter(p=>matchesPatient(p,q)));
  });
  $("ptSearch").addEventListener("input", ()=>{
    const q = $("ptSearch").value.trim();
    if(q.length < 2){ $("searchResults").style.display="none"; return; }
    showSearchResults(patients.filter(p=>matchesPatient(p,q)));
  });

  $("btnSavePt").addEventListener("click", saveFlow);
  $("btnDeletePt").addEventListener("click", deleteFlow);

  // ✅ Clear all now just clears screen (keeps DB)
  $("btnClear").addEventListener("click", ()=>{
    modal.open(
      "Clear all",
      "This will clear the current screen (inputs + calendar) and prepare for the next search.<br><b>Saved patients will not be deleted.</b>",
      [
        {label:"Clear screen", cls:"btn", onClick:()=>{ modal.close(); clearScreenFlow(); }},
        {label:"Cancel", cls:"btn secondary", onClick:()=>modal.close()}
      ]
    );
  });

  $("btnPrint").addEventListener("click", ()=>{ renderAll(); window.print(); });

  $("btnClearRegimen").addEventListener("click", ()=>{
    const p = activePatient(); if(!p) return;
    p.state.regimen = {};
    if(!p.isDraft) savePatients();
    syncRegimenUI();
    renderAll();
  });
  $("btnCopyRegimen").addEventListener("click", ()=>{
    const p = activePatient(); if(!p) return;
    const s = p.state;
    s.regimen = s.regimen || {};
    const today = new Date();
    for(let k=0;k<28;k++){
      const d = addDaysLocal(today, k);
      const iso = isoLocal(d);
      const dow = d.getDay();
      const mg = toNum(s.regimen[dow]);
      if(!isFinite(mg)) continue;
      const day = getDay(iso);
      day.scheduled = String(mg);
      s.days[iso] = day;
    }
    if(!p.isDraft) savePatients();
    renderAll();
  });

  $("btnDemo").addEventListener("click", ()=>{
    // demo fills draft
    draftState = blankState();
    setActive(DRAFT_ID);
    const p = activePatient();
    const s = p.state;

    s.ptName = "Demo Patient";
    s.dob = "15/01/1950";
    s.phone = "(818) 555-1234";
    s.mrn = "123456";
    s.wt = "78";
    s.crcl = "55";
    s.tablets = [2.5,5];
    s.targetRange = "2.0-3.0";
    s.inrToday = "3.6";
    s.bridgeNeed = "yes";
    s.bridgeAgent = "enox";
    s.bridgeInd = "Peri-procedural (demo)";
    s.enoxFreq = "q12";
    s.interactions = ["amio"];
    s.navOffsetWeeks = 0;

    s.regimen = {0:7.5,1:7.5,2:7.5,3:7.5,4:7.5,5:7.5,6:7.5};

    const today = new Date();
    const doses = [7.5,7.5,7.5,7.5,7.5,7.5,7.5, 5,5,5];
    for(let i=0;i<10;i++){
      const iso = isoLocal(addDaysLocal(today, -i));
      const d = getDay(iso);
      d.scheduled = String(doses[i] ?? 7.5);
      s.days[iso] = d;
    }
    getDay(isoLocal(addDaysLocal(today, -7))).inr = "2.7";
    getDay(isoLocal(addDaysLocal(today, -3))).inr = "3.1";
    getDay(isoLocal(today)).inr = s.inrToday;

    bindInputs();
    renderAll();
  });
}

/* ---- tablets + regimen init ---- */
function initUI(){
  initRegimen();
  initPills();
}

/* ---- init ---- */
ensureDB();
initUI();
bindInputs();
hookEvents();
renderAll();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>ThromboLogic INR</title>
<style>
:root{--blue:#eaf3ff;--blue-ring:rgba(13,110,253,.25);--ylw:#fffef0;--man:#ffe79a;--man-b:#ffc857;--card:#fafafa}
*{box-sizing:border-box}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:16px;color:#111}
h1{font-size:19px;margin:0 0 8px} h2{font-size:15px;margin:16px 0 6px}
.small{font-size:12px;color:#555} .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
fieldset{border:1px solid #ddd;border-radius:10px;padding:10px;margin:10px 0} legend{padding:0 6px}
input,select,button,textarea{font-size:15px} input,select,textarea{padding:8px;border:1px solid #b9c1cc;border-radius:10px}
textarea{resize:vertical}
.btn{padding:8px 12px;border:0;border-radius:10px;background:#444;color:#fff;cursor:pointer;margin-right:8px}
.btnp{padding:10px 14px;border:0;border-radius:10px;background:#0d6efd;color:#fff;cursor:pointer;font-weight:700;margin:8px 0;display:inline-block}
.btnS{padding:4px 8px;border:0;border-radius:8px;background:#444;color:#fff;cursor:pointer;margin-right:6px;font-size:13px}
.btn:disabled,.btnp:disabled,.btnS:disabled{opacity:.55;cursor:not-allowed}
.container{max-width:860px;margin:0 auto}
.grid{display:grid;gap:10px} @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
.grid7{display:grid;grid-template-columns:repeat(7,minmax(64px,1fr));gap:6px}
.grid7>div{display:flex;flex-direction:column;gap:4px;align-items:center}
.grid7 input{width:84px;max-width:84px;padding:6px;font-size:14px}
.toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:6px 0 10px}
.calwrap{
  border:1px solid #eee;
  border-radius:12px;
  overflow:auto;
  max-height:72vh;
  background:linear-gradient(#fff,#fff) padding-box,
             linear-gradient(180deg,#f7f8fa,#fff) border-box;
}
.week{display:grid;grid-template-columns:repeat(7, minmax(90px,1fr));gap:8px;padding:10px;border-bottom:1px solid #f0f0f0}
.weekHeader{position:sticky;top:0;background:#fff;padding:8px 12px;border-bottom:1px solid #eee;z-index:2;display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
.day{border:1px solid #fff;border-radius:10px;padding:6px;background:var(--ylw);position:relative;display:flex;flex-direction:column;min-height:148px}
.day .hdr{display:flex;align-items:center;justify-content:space-between;gap:6px;margin-bottom:2px}
.day .hdr b{font-size:12px} .date{font-size:11px;color:#666}
.blue{background:var(--blue)!important;box-shadow:inset 0 0 0 2px var(--blue-ring)}
.manual{background:var(--man)!important;box-shadow:inset 0 0 0 2px var(--man-b)}
.lbl{font-size:11px;color:#444;text-align:center;margin-top:2px}
.cell-input{display:block;width:84px;max-width:84px;margin:4px auto;border:1px solid #b7c3d0;border-radius:10px;padding:6px;text-align:center;font-size:14px}
.inrbox{font-weight:800}
.card{border:1px solid #eee;border-radius:10px;padding:10px;background:var(--card)}
.legend{display:flex;gap:12px;align-items:center;font-size:12px;margin:6px 0 10px}
.sw{display:inline-block;width:14px;height:14px;border-radius:3px;border:1px solid #fff;box-shadow:inset 0 0 0 1px rgba(0,0,0,.05);margin-right:4px}
.err{color:#b00020;font-size:12px;margin:6px 0} .debug{font-size:11px;color:#666;margin-top:6px}
@media(max-width:700px){.container{max-width:96vw}.week{grid-template-columns:repeat(7, minmax(76px,1fr));gap:6px}.cell-input,.grid7 input{width:78px;max-width:78px;font-size:13px;padding:5px}.day{min-height:138px}}
.orangeCell{background:#ffe0b3!important;box-shadow:inset 0 0 0 2px #ff9800}
.redCell{background:#ffc2c2!important;box-shadow:inset 0 0 0 2px #e53935}
.repeat-inr{font-size:11px;color:#b00020;margin-top:3px;text-align:center}

/* Patient info emphasis */
.patient-grid{display:flex;flex-wrap:wrap;gap:16px}
.patient-field{display:flex;flex-direction:column;min-width:180px}
.patient-field label{font-weight:600;margin-bottom:4px}

/* DOB inline error */
.invalidField{border-color:#b00020 !important; box-shadow:0 0 0 3px rgba(176,0,32,.12)}
.inlineErr{color:#b00020;font-size:12px;margin-top:6px;display:none}

/* Interaction UI */
.badges{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.badge{display:inline-flex;align-items:center;gap:6px;border:1px solid #ddd;border-radius:999px;padding:3px 10px;font-size:12px;background:#fff}
.badge.major{border-color:#e53935}
.badge.moderate{border-color:#ff9800}
.badge.bleeding{border-color:#7b1fa2}
.kv{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
.kv > div{border:1px dashed #ddd;border-radius:10px;padding:8px 10px;background:#fff}
.kv b{font-size:13px}

/* Hide export button when printing */
@media print {
  #exportPDF{display:none !important;}
}
</style>
</head>
<body>
<div class="container">

  <!-- ThromboLogic Header Branding (as in your working version) -->
  <div style="display:flex; align-items:center; gap:14px; margin:0 0 6px 0;">
    <img src="ThromboLogic INR Logo Design.png"
         alt="ThromboLogic INR Logo"
         style="height:80px; width:auto;">
    <div style="display:flex; flex-direction:column; line-height:1.1;">
      <span style="font-size:26px; font-weight:800;">ThromboLogic</span>
      <span style="font-size:16px; font-weight:600;">INR</span>
      <span class="small" style="margin-top:4px;">INR 7.3 (Procedure targeting + model-informed weighted dose context)</span>
    </div>
  </div>

  <div class="toolbar">
    <span class="small" id="rangeLabel"></span>
  </div>

  <div id="err" class="err"></div>

  <!-- Patient Information -->
  <h2>Patient Information</h2>
  <fieldset><legend>Patient</legend>
    <div class="patient-grid">
      <div class="patient-field">
        <label for="patientName">Patient Name</label>
        <input id="patientName" type="text" placeholder="e.g., John Smith">
      </div>
      <div class="patient-field">
        <label for="patientDob">DOB (MM/DD/YYYY)</label>
        <input id="patientDob" type="text" placeholder="e.g., 01/02/1970" maxlength="10">
        <div id="dobInlineErr" class="inlineErr">Please enter DOB as a valid date in MM/DD/YYYY format.</div>
      </div>
      <div class="patient-field">
        <label for="patientMrn">MRN</label>
        <input id="patientMrn" type="text" placeholder="e.g., 1234567">
      </div>
    </div>
  </fieldset>

  <h2>Therapeutic Goal, Procedure Target & Current INR</h2>
  <fieldset><legend>Inputs</legend>
    <div class="grid">
      <div>
        <label>Therapeutic Goal INR</label>
        <select id="goal">
          <option value="2-3" selected>Preset: 2.0–3.0</option>
          <option value="2.5-3.5">Preset: 2.5–3.5</option>
          <option value="custom">Custom…</option>
        </select>
        <div id="cust" style="display:none; margin-top:6px;">
          <div style="display:flex; align-items:center; gap:6px; margin-bottom:6px;">
            <label>Low</label>
            <input id="gL" type="number" step="0.1" min="0" inputmode="decimal"
                   placeholder="e.g., 2.3"
                   style="width:80px; padding:6px;">
          </div>
          <div style="display:flex; align-items:center; gap:6px;">
            <label>High</label>
            <input id="gH" type="number" step="0.1" min="0" inputmode="decimal"
                   placeholder="e.g., 3.3"
                   style="width:80px; padding:6px;">
          </div>
        </div>

        <!-- NEW: Procedure Target INR -->
        <div style="margin-top:10px;padding:10px;border:1px solid #eee;border-radius:10px;background:#fff;">
          <label style="display:flex;gap:8px;align-items:center;">
            <input id="procTargetOn" type="checkbox">
            <b>Use procedure target INR (temporary)</b>
          </label>
          <div class="small" style="margin-top:4px;color:#666;">
            Example: pre-procedure goal might be a specific INR. This temporarily overrides the goal range for the recommendation.
          </div>
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:8px;">
            <div>
              <label class="small">Target INR</label><br>
              <input id="procTarget" type="number" step="0.1" min="0" inputmode="decimal" style="width:120px;padding:6px;" placeholder="e.g., 1.8">
            </div>
            <div>
              <label class="small">Tolerance (±)</label><br>
              <input id="procTol" type="number" step="0.1" min="0.1" inputmode="decimal" style="width:120px;padding:6px;" value="0.2">
            </div>
            <div class="small" id="procRangePreview" style="color:#444;"></div>
          </div>
        </div>
      </div>

      <div>
        <div style="display:flex; flex-direction:column; justify-content:flex-start; padding-top:2px;">
          <label style="margin-bottom:4px;">Current INR</label>
          <input id="inr"
                 class="cell-input inrbox"
                 type="number"
                 step="0.1"
                 min="0"
                 inputmode="decimal"
                 placeholder="e.g., 2.6"
                 style="margin:0; max-width:105px;">
          <div class="small" style="margin-top:4px;">Typing here auto-fills today’s INR cell.</div>
        </div>
      </div>

    </div>
  </fieldset>

  <h2>Scheduled Maintenance Dosing</h2>
  <fieldset><legend>Baseline regimen (Sun → Sat)</legend>
    <div class="grid7">
      <div>Sun<input id="b0" type="number" step="0.1" min="0" inputmode="decimal"></div>
      <div>Mon<input id="b1" type="number" step="0.1" min="0" inputmode="decimal"></div>
      <div>Tue<input id="b2" type="number" step="0.1" min="0" inputmode="decimal"></div>
      <div>Wed<input id="b3" type="number" step="0.1" min="0" inputmode="decimal"></div>
      <div>Thu<input id="b4" type="number" step="0.1" min="0" inputmode="decimal"></div>
      <div>Fri<input id="b5" type="number" step="0.1" min="0" inputmode="decimal"></div>
      <div>Sat<input id="b6" type="number" step="0.1" min="0" inputmode="decimal"></div>
    </div>
    <div style="margin-top:8px">
      <button class="btn" id="applyCur">Apply to visible weeks</button>
      <button class="btn" id="clearVisible">Clear visible only</button>
      <button class="btn" id="clearAll">Clear ALL</button>
    </div>
    <div style="margin-top:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
      <button class="btnp" id="getRec">Get Recommendation</button>
      <button class="btnS" id="recalcNow" type="button" disabled style="opacity:0.5;">Recalculate with updated INR</button>
      <span id="recalcHint" class="small" style="display:none;">INR changed since the last recommendation.</span>
    </div>
    <div id="sum" class="small" style="margin-top:6px">Scheduled weekly total: 0.0 mg</div>
  </fieldset>

  <!-- ✅ Legend + Live Calendar BEFORE Bridging -->
  <div class="legend">
    <span><span class="sw" style="background:var(--blue);box-shadow:inset 0 0 0 2px var(--blue-ring)"></span>Today / Repeat INR</span>
    <span><span class="sw" style="background:var(--man);box-shadow:inset 0 0 0 2px var(--man-b)"></span>Manual entry present</span>
    <span><span class="sw" style="background:var(--ylw)"></span>Default</span>
  </div>

  <h2>Scrollable Live Calendar</h2>
  <div class="calwrap" id="calwrap">
    <div class="weekHeader">
      <b>Scroll within this window to view past and future weeks.</b>
      <button class="btnS" id="goToday">Go to today</button>
    </div>
    <div id="weeks"></div>
  </div>
  <div id="dbg" class="debug"></div>

  <!-- Bridging -->
  <h2>Bridging – Parenteral Helper (enoxaparin / fondaparinux) (beta)</h2>
  <fieldset><legend>Weight-based parenteral dose</legend>
    <div class="grid">
      <div>
        <label for="enoxWeight">Weight (kg)</label>
        <input id="enoxWeight"
               type="number"
               step="0.1"
               min="20"
               inputmode="decimal"
               placeholder="e.g., 78.5">
        <div class="small">Use actual body weight unless local protocol says otherwise.</div>
      </div>

      <div>
        <label for="enoxType">Regimen</label>
        <select id="enoxType">
          <option value="tx_q12" selected>
            Enoxaparin – Therapeutic 1 mg/kg every 12 hours
          </option>
          <option value="tx_q24">
            Enoxaparin – Therapeutic (renal adjustment) – 1 mg/kg once daily
          </option>
          <option value="px_40">
            Enoxaparin – Prophylaxis – 40 mg once daily
          </option>
          <option value="px_30">
            Enoxaparin – Prophylaxis (renal adjustment) – 30 mg once daily
          </option>
          <option value="fond_tx">
            Fondaparinux – Treatment (5 mg if &lt;50 kg, 7.5 mg if 50–100 kg, 10 mg if &gt;100 kg)
          </option>
          <option value="fond_px">
            Fondaparinux – Prophylaxis – 2.5 mg once daily
          </option>
        </select>
        <div class="small">Always confirm with local protocol, especially in renal impairment or HIT.</div>
      </div>
    </div>

    <div style="margin-top:10px;">
      <button class="btnS" type="button" id="calcEnox">Calculate bridging dose</button>
      <button class="btnS" type="button" id="clearEnox" style="margin-left:8px;">Bridging not required</button>
    </div>

    <div id="enoxOut" class="small" style="margin-top:8px;"></div>
  </fieldset>

  <!-- Interaction checker -->
  <h2>Warfarin Drug Interaction Check (beta)</h2>
  <fieldset><legend>Medication review</legend>
    <div class="small" style="margin-bottom:8px;">
      Type or paste meds (comma-separated). This is a high-yield screen, not a comprehensive database. Confirm clinically.
    </div>

    <div style="display:flex;flex-wrap:wrap;gap:10px;align-items:flex-start;">
      <div style="flex:1;min-width:260px;">
        <label for="medList"><b>Current medications</b></label>
        <textarea id="medList" rows="3" placeholder="e.g., Bactrim, Metronidazole, Ibuprofen"></textarea>
      </div>
      <div style="min-width:240px;">
        <div style="margin-top:22px;">
          <button class="btnS" type="button" id="checkInteractions">Check interactions</button>
          <button class="btnS" type="button" id="clearInteractions" style="margin-left:6px;">Clear</button>
        </div>
        <div style="margin-top:10px;">
          <label style="display:flex;gap:8px;align-items:center;">
            <input id="autoAdjustRepeat" type="checkbox">
            <span class="small">Auto-move repeat INR earlier (optional)</span>
          </label>
          <div class="small" style="margin-top:4px;color:#666;">
            OFF by default. If enabled, major interactions may set repeat INR to 2–3 days.
          </div>
        </div>
      </div>
    </div>

    <div id="interactionResults" class="card small" style="margin-top:10px;display:none;"></div>
  </fieldset>

  <!-- Verbal Recommendation + Export button -->
  <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;margin-top:16px;">
    <h2 style="margin:0;">Verbal Recommendation</h2>
    <div>
      <button class="btnS" id="patientHandout" type="button">Patient handout view</button>
      <button class="btnS" id="exportPDF" type="button">Export to PDF</button>
    </div>
  </div>

  <div id="rec" class="card"></div>

  <h2>7-Day Recommendation (Linear — Today's Week)</h2>
  <div id="lin" class="card mono"></div>

  <!-- Predicted INR (What-if – Beta) -->
  <h2>Predicted INR (What-if – Beta)</h2>
  <div class="card small" id="predictCard">
    <div style="margin-bottom:6px;">
      Uses prior INR + dosing history to estimate a trend response. This is <b>experimental</b>,
      lag-aware (weighted), and direction-constrained (will refuse inverse models). Use clinical judgment.
    </div>

    <!-- NEW: window selector used by both model displays + what-if -->
    <div style="display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-top:8px;">
      <div class="small"><b>Dose window used by model</b></div>
      <select id="doseWindowMode" style="padding:6px 10px;">
        <option value="prior7" selected>Prior 7 days (excludes today)</option>
        <option value="ending7">7-day window ending today (includes today)</option>
      </select>
      <div class="small" style="color:#666;">Keeps yellow box + what-if consistent when desired.</div>
    </div>

    <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-top:10px;">
      <button class="btnS" type="button" id="loadDemo">Load demo history</button>
      <button class="btnS" type="button" id="clearDemo" title="Clears planned/actual/INR history only (keeps baseline inputs)">Clear demo history</button>
      <span class="small" id="demoMsg" style="display:none;"></span>
    </div>

    <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-top:10px;">
      <label><b>Proposed weighted 7-day dose (mg)</b></label>
      <input id="predWeeklyDose" type="number" step="0.5" min="0"
             style="width:140px;padding:6px;">
      <button class="btnS" type="button" id="runPrediction">Estimate INR</button>
      <span class="small" style="color:#666;">Tip: this is the lag-weighted dose used by the model (not a simple sum).</span>
    </div>
    <div id="predOut" style="margin-top:6px;"></div>
  </div>

<script>
function pad(n){return (n<10?'0':'')+n}
function isoLocal(d){return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate())}
function startOfWeekLocal(d){const x=new Date(d.getFullYear(),d.getMonth(),d.getDate()); const dow=x.getDay(); x.setHours(0,0,0,0); x.setDate(x.getDate()-dow); return x}
function addDaysLocal(d,days){const x=new Date(d.getFullYear(),d.getMonth(),d.getDate()); x.setDate(x.getDate()+days); return x}
function daysBetween(a,b){const d1=new Date(a.getFullYear(),a.getMonth(),a.getDate()); const d2=new Date(b.getFullYear(),b.getMonth(),b.getDate()); return Math.round((d2-d1)/86400000)}
function r01(x){return Math.round(x*10)/10} function r05(x){return Math.round(x*2)/2}

function niceDate(isoStr){
  if(!isoStr) return '';
  const parts = isoStr.split('-');
  if(parts.length!==3) return isoStr;
  const y = parseInt(parts[0],10);
  const m = parseInt(parts[1],10);
  const d = parseInt(parts[2],10);
  if(isNaN(m)||isNaN(d)||isNaN(y)) return isoStr;
  return pad(m)+'/'+pad(d)+'/'+y;
}

const weeksEl = document.getElementById('weeks'); const calwrap = document.getElementById('calwrap'); const rangeLabel=document.getElementById('rangeLabel');
const rec = document.getElementById('rec'); const linEl = document.getElementById('lin'); const sum = document.getElementById('sum'); const err = document.getElementById('err'); const dbg = document.getElementById('dbg');

const planned=new Map(), actual=new Map(), inrVal=new Map(); let repeatKey=null; let hasReco=false, pendingRecalc=false;
let lastRecoINR = null; let lastRepeatIso = null;

/* ===========================
   INTERACTION DATABASE (EDITABLE JSON)
   =========================== */
const WARFARIN_INTERACTIONS = [
  { drug:"trimethoprim-sulfamethoxazole", aka:["bactrim","septra","tmp-smx"], level:"major", effect:"↑ INR", suggestDays:3 },
  { drug:"metronidazole", aka:["flagyl"], level:"major", effect:"↑ INR", suggestDays:3 },
  { drug:"fluconazole", aka:["diflucan"], level:"major", effect:"↑ INR", suggestDays:3 },
  { drug:"amiodarone", aka:[], level:"major", effect:"↑ INR", suggestDays:3 },
  { drug:"rifampin", aka:[], level:"major", effect:"↓ INR", suggestDays:3 },
  { drug:"phenytoin", aka:["dilantin"], level:"moderate", effect:"↑/↓ INR", suggestDays:7 },
  { drug:"carbamazepine", aka:["tegretol"], level:"moderate", effect:"↓ INR", suggestDays:7 },
  { drug:"sertraline", aka:["zoloft","ssri"], level:"bleeding", effect:"Bleeding risk", suggestDays:null },
  { drug:"citalopram", aka:["celexa","ssri"], level:"bleeding", effect:"Bleeding risk", suggestDays:null },
  { drug:"fluoxetine", aka:["prozac","ssri"], level:"bleeding", effect:"Bleeding risk", suggestDays:null },
  { drug:"ibuprofen", aka:["nsaid","motrin","advil"], level:"bleeding", effect:"Bleeding risk", suggestDays:null },
  { drug:"naproxen", aka:["aleve","nsaid"], level:"bleeding", effect:"Bleeding risk", suggestDays:null },
  { drug:"aspirin", aka:["asa"], level:"bleeding", effect:"Bleeding risk", suggestDays:null }
];

let currentInteractionHits = []; // last computed hits

function normalizeMedText(s){
  return (s||"").toLowerCase().replace(/[\n\r]/g,' ').replace(/\s+/g,' ').trim();
}
function matchInteractions(medText){
  const t = normalizeMedText(medText);
  if(!t) return [];
  const hits=[];
  for(const item of WARFARIN_INTERACTIONS){
    const names=[item.drug, ...(item.aka||[])].filter(Boolean);
    const found = names.some(n=> t.includes(n.toLowerCase()));
    if(found) hits.push(item);
  }
  const seen=new Set();
  return hits.filter(h=>{ const k=h.drug.toLowerCase(); if(seen.has(k)) return false; seen.add(k); return true; });
}
function interactionSummary(hits){
  if(!hits || hits.length===0) return null;

  const major = hits.filter(h=>h.level==="major");
  const mod   = hits.filter(h=>h.level==="moderate");
  const bleed = hits.filter(h=>h.level==="bleeding");

  const suggestedDays = [];
  for(const h of hits){
    if(typeof h.suggestDays === "number" && !isNaN(h.suggestDays)) suggestedDays.push(h.suggestDays);
  }
  const minDays = suggestedDays.length ? Math.min(...suggestedDays) : null;

  return {
    majorCount: major.length,
    moderateCount: mod.length,
    bleedCount: bleed.length,
    minSuggestedDays: minDays,
    major, mod, bleed
  };
}
function buildInteractionHTML(hits){
  const sum = interactionSummary(hits);
  if(!sum) return '';

  const badges=[];
  if(sum.majorCount) badges.push(`<span class="badge major">MAJOR × ${sum.majorCount}</span>`);
  if(sum.moderateCount) badges.push(`<span class="badge moderate">MODERATE × ${sum.moderateCount}</span>`);
  if(sum.bleedCount) badges.push(`<span class="badge bleeding">BLEED RISK × ${sum.bleedCount}</span>`);

  let timingLine='';
  if(sum.minSuggestedDays!=null){
    timingLine = `<div class="kv"><div><b>Suggested INR recheck:</b> ${sum.minSuggestedDays} day(s) (interaction-aware)</div></div>`;
  }else{
    timingLine = `<div class="kv"><div><b>Suggested INR recheck:</b> per clinic discretion</div></div>`;
  }

  const list = hits.map(h=>{
    const level = h.level.toUpperCase();
    return `<li><b>${h.drug}</b> — <span>${h.effect}</span> <span class="small">(${level})</span></li>`;
  }).join('');

  const bleedCounsel = sum.bleedCount ? `
    <div style="margin-top:8px;">
      <b>Bleeding risk counseling:</b> avoid additional NSAIDs/aspirin unless directed; watch for unusual bruising, bleeding gums, dark stools, or severe headache—seek care if concerning.
    </div>` : '';

  return `
    <div style="margin-top:10px;padding:10px;border-radius:10px;border:1px solid #e6e6e6;background:#fff;">
      <div><b>Warfarin interaction screen (beta):</b></div>
      <div class="badges">${badges.join(' ')}</div>
      ${timingLine}
      <div style="margin-top:8px;"><ul style="margin:6px 0 0 18px;padding:0;">${list}</ul></div>
      <div class="small" style="margin-top:6px;color:#666;">Not comprehensive; confirm with clinical judgment and local protocol.</div>
      ${bleedCounsel}
    </div>
  `;
}

function base(){return [0,1,2,3,4,5,6].map(i=>{const v=parseFloat(document.getElementById('b'+i).value);return isNaN(v)?0:r01(v)})}
function baseSum(){return base().reduce((a,b)=>a+b,0)} function updSum(){sum.innerHTML='Scheduled weekly total: <b>'+r01(baseSum()).toFixed(1)+' mg</b>'}
function schedAtIso(key){const d=new Date(key); const dow=d.getDay(); return base()[dow]||0}
function effAtIso(key){if(actual.has(key))return actual.get(key); if(planned.has(key))return planned.get(key); return schedAtIso(key)}

const today = new Date();

// Calendar range: 26 weeks before + current + 26 weeks after (~1 yr)
const weeksBefore = 26;
const weeksAfter  = 26;
let start = addDaysLocal(startOfWeekLocal(today), -7*weeksBefore);
let totalWeeks = weeksBefore + weeksAfter + 1;

function renderAll(){
  weeksEl.innerHTML='';
  const spanStart = isoLocal(start);
  const spanEnd = isoLocal(addDaysLocal(start, totalWeeks*7-1));
  rangeLabel.textContent = spanStart+' → '+spanEnd+'  ('+totalWeeks+' weeks)';
  for(let w=0; w<totalWeeks; w++){
    const wk = document.createElement('div'); wk.className='week';
    for(let d=0; d<7; d++){
      const date = addDaysLocal(start, w*7+d); const key=isoLocal(date);
      const cell=document.createElement('div'); cell.className='day'; cell.id='c_'+key;
      const isToday = key===isoLocal(today); const isRepeat=(key===repeatKey);
      if(isToday||isRepeat) cell.classList.add('blue');
      cell.innerHTML =
        '<div class="hdr"><b>'+['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][date.getDay()]+'</b> '+
        '<span class="date">'+(date.getMonth()+1).toString().padStart(2,'0')+'/'+date.getDate().toString().padStart(2,'0')+'</span></div>'+
        '<div class="lbl">Planned dose (mg)</div>'+
        '<input class="cell-input" data-k="'+key+'" data-role="planned" type="number" step="0.1" min="0">'+
        '<div class="lbl">INR</div>'+
        '<input class="cell-input inrbox" data-k="'+key+'" data-role="inr" type="number" step="0.1" min="0">'+
        '<div class="lbl">Actual dose</div>'+
        '<input class="cell-input" data-k="'+key+'" data-role="actual" type="number" step="0.1" min="0">'+
        '<div class="lbl repeat-inr"></div>';
      wk.appendChild(cell);
    }
    weeksEl.appendChild(wk);
  }

  pushDataToCells();
  lin7();
  dbg.textContent = 'Calendar rows rendered: ' + document.querySelectorAll('.week').length;
}

function scrollToTodayWeek() {
  const tIso = isoLocal(today);
  const cell = document.getElementById('c_' + tIso);
  if (!cell) return;
  const cellRect = cell.getBoundingClientRect();
  const wrapRect = calwrap.getBoundingClientRect();
  const offsetWithinWrap = (cellRect.top - wrapRect.top) + calwrap.scrollTop;
  calwrap.scrollTop = offsetWithinWrap - (calwrap.clientHeight / 2) + (cellRect.height / 2);
}

function pushDataToCells(){
  const tIso=isoLocal(today);
  for(let w=0; w<totalWeeks; w++){
    for(let d=0; d<7; d++){
      const date = addDaysLocal(start, w*7+d); const key=isoLocal(date);
      const cell=document.getElementById('c_'+key); if(!cell) continue;
      const p=planned.has(key)?planned.get(key):''; const a=actual.has(key)?actual.get(key):''; const i=inrVal.has(key)?inrVal.get(key).toFixed(1):'';
      const inputs=cell.querySelectorAll('input');
      if(inputs[0]) inputs[0].value = (p!==''? Number(p).toFixed(1):'');
      if(inputs[1]) inputs[1].value = i;
      if(inputs[2]) inputs[2].value = (a!==''? Number(a).toFixed(1):'');
      const isToday = key===tIso; const isRepeat=(key===repeatKey);
      cell.className='day';
      const hasManual = (i!=='') || (a!=='');
      const inrNum = parseFloat(i);
      if(!isNaN(inrNum)){
        if(inrNum >= 5.0){
          cell.classList.add('redCell');
        }else if(inrNum >= 4.0){
          cell.classList.add('orangeCell');
        }
      }
      if(hasManual && !cell.classList.contains('redCell') && !cell.classList.contains('orangeCell')){
        cell.classList.add('manual');
      }
      const repEl = cell.querySelector('.repeat-inr');
      if(repEl){
        repEl.innerHTML = isRepeat ? '<b>Repeat INR</b>' : '';
      }
      if(isToday||isRepeat){
        cell.classList.add('blue');
      }
    }
  }
}

function applyVisible(){
  const base7=base();
  const rect = calwrap.getBoundingClientRect();
  const weekNodes = Array.from(weeksEl.querySelectorAll('.week'));
  weekNodes.forEach((wk, wi)=>{
    const r = wk.getBoundingClientRect();
    if(r.bottom < rect.top-200 || r.top > rect.bottom+200) return;
    for(let d=0; d<7; d++){
      const date = addDaysLocal(start, wi*7+d); const key=isoLocal(date);
      planned.set(key, base7[d]);
    }
  });
  pushDataToCells(); lin7(); updSum();
}

function clearVisible(){
  const rect = calwrap.getBoundingClientRect();
  const weekNodes = Array.from(weeksEl.querySelectorAll('.week'));
  weekNodes.forEach((wk, wi)=>{
    const r = wk.getBoundingClientRect();
    if(r.bottom < rect.top-200 || r.top > rect.bottom+200) return;
    for(let d=0; d<7; d++){
      const date = addDaysLocal(start, wi*7+d); const key=isoLocal(date);
      planned.delete(key); actual.delete(key); inrVal.delete(key); if(repeatKey===key) repeatKey=null;
    }
  });
  pushDataToCells(); lin7(); rec.innerHTML='';
}

function clearAll(){
  planned.clear(); actual.clear(); inrVal.clear(); repeatKey=null;
  for(let i=0;i<7;i++) document.getElementById('b'+i).value='';
  updSum(); pushDataToCells(); lin7(); rec.innerHTML='';
}

function lin7(){
  const weekStart = startOfWeekLocal(today);
  const names=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  let parts=[];
  for(let i=0;i<7;i++){
    const d=addDaysLocal(weekStart,i); const key=isoLocal(d);
    let dose = (actual.has(key)? actual.get(key) : (planned.has(key)? planned.get(key) : NaN));
    if(isNaN(dose)) dose = undefined;
    parts.push(names[i]+' '+(dose===undefined? '—' : dose.toFixed(1)+' mg'));
  }
  linEl.textContent = parts.join('  |  ');
}

/* ===========================
   Goal / procedure target helpers
   =========================== */
function getActiveGoalRange(){
  const procOn = document.getElementById('procTargetOn')?.checked;
  const procTarget = parseFloat(document.getElementById('procTarget')?.value);
  const procTol = parseFloat(document.getElementById('procTol')?.value);

  if(procOn && !isNaN(procTarget) && procTarget>0 && !isNaN(procTol) && procTol>0){
    return { L: r01(procTarget - procTol), H: r01(procTarget + procTol), label:`Procedure target ${procTarget.toFixed(1)} (±${procTol.toFixed(1)})` };
  }

  const goalVal = document.getElementById('goal').value;
  const L = (goalVal==='2-3')?2.0:(goalVal==='2.5-3.5')?2.5:parseFloat(document.getElementById('gL').value);
  const H = (goalVal==='2-3')?3.0:(goalVal==='2.5-3.5')?3.5:parseFloat(document.getElementById('gH').value);
  return { L, H, label:`Goal ${L}–${H}` };
}

function pickPct(inr, L, H){
  const withinRange = (inr>=L && inr<=H);
  if(withinRange) return {pct:0, label:'in range', repeat:7};
  const gap = (inr<L) ? (L - inr) : (inr - H);
  if(inr < 1.5)       return {pct:+0.15, label:'+15–20%', repeat:7};
  if(inr < L){
    if(gap <= 3.5)    return {pct:+0.07, label:'+5–10%', repeat:7};
    else              return {pct:+0.10, label:'+10–15%', repeat:7};
  }
  if(inr > 4.5)       return {pct:-0.20, label:'-15–20% (≥4.5 → 20%)', repeat:2};
  if(inr >= 4.0){
    if(gap <= 3.5)    return {pct:-0.08, label:'-5–10%', repeat:7};
    else              return {pct:-0.11, label:'-10–15%', repeat:7};
  }
  if(gap <= 3.5)      return {pct:-0.07, label:'-5–10%', repeat:7};
  else                return {pct:-0.10, label:'-10–15%', repeat:7};
}

function last6SchedBeforeDate(d){ let s=0; for(let k=6;k>=1;k--){ const key=isoLocal(addDaysLocal(d,-k)); s+=schedAtIso(key) } return r01(s) }
function last6EffBeforeDate(d){ let s=0; for(let k=6;k>=1;k--){ const key=isoLocal(addDaysLocal(d,-k)); s+=effAtIso(key) } return r01(s) }
function sched7EndOnDate(d){ let s=0; for(let k=6;k>=0;k--){ const key=isoLocal(addDaysLocal(d,-k)); s+=schedAtIso(key) } return r01(s) }

function markNeedsRecalc(){
  if(hasReco){
    pendingRecalc=true;
    const btn=document.getElementById('recalcNow');
    if(btn){ btn.disabled=false; btn.style.opacity=''; }
    const hint=document.getElementById('recalcHint');
    if(hint) hint.style.display='inline';
  }
}

/* ===========================
   Bridging (Enox / Fonda)
   =========================== */
function roundEnoxaparinDose(doseMg){
  if (doseMg == null || isNaN(doseMg)) return null;
  const raw = Math.round(doseMg);
  const units = raw % 10;
  if (units <= 5) return raw - units;
  return raw + (10 - units);
}

function calcEnoxaparinDose(){
  const wtEl  = document.getElementById('enoxWeight');
  const typeEl= document.getElementById('enoxType');
  const out   = document.getElementById('enoxOut');
  if (!wtEl || !typeEl || !out) return;

  const wt = parseFloat(wtEl.value);
  const reg = typeEl.value;

  if (isNaN(wt) || wt <= 0){
    out.innerHTML = '<span style="color:#b00020;">Enter a valid weight in kg.</span>';
    return;
  }

  let baseDose = NaN, freqText = '', context  = '';

  switch(reg){
    case 'tx_q12':
      baseDose = wt * 1.0; freqText = 'every 12 hours';
      context  = 'Enoxaparin therapeutic dosing (e.g., VTE/AF/ACS) with normal renal function.'; break;
    case 'tx_q24':
      baseDose = wt * 1.0; freqText = 'once daily';
      context  = 'Enoxaparin therapeutic dosing with renal adjustment (e.g., CrCl < 30 mL/min per local protocol).'; break;
    case 'px_40':
      baseDose = 40; freqText = 'once daily';
      context  = 'Enoxaparin standard prophylaxis dose with normal renal function.'; break;
    case 'px_30':
      baseDose = 30; freqText = 'once daily';
      context  = 'Enoxaparin prophylaxis dose with renal adjustment (e.g., CrCl < 30 mL/min per local protocol).'; break;
    case 'fond_tx':
      baseDose = (wt < 50) ? 5 : (wt <= 100 ? 7.5 : 10);
      freqText = 'once daily';
      context  = 'Fondaparinux treatment dosing: 5 mg if <50 kg, 7.5 mg if 50–100 kg, 10 mg if >100 kg (confirm protocol + renal function).'; break;
    case 'fond_px':
      baseDose = 2.5; freqText = 'once daily';
      context  = 'Fondaparinux prophylaxis dosing (2.5 mg daily) — confirm timing/duration per local protocol.'; break;
  }

  if (isNaN(baseDose)){
    out.innerHTML = '<span style="color:#b00020;">Select a valid regimen.</span>';
    return;
  }

  const isFonda = (reg === 'fond_tx' || reg === 'fond_px');
  if(isFonda){
    out.innerHTML = `
      <div><b>Calculated dose:</b> ${baseDose.toFixed(1)} mg</div>
      <div><b>Suggested dose:</b> ${baseDose.toFixed(1)} mg ${freqText}</div>
      <div class="small" style="margin-top:4px;">
        Fondaparinux is supplied as fixed prefilled syringe strengths (2.5, 5, 7.5, 10 mg).
      </div>
      <div class="small" style="margin-top:6px;">${context}</div>
    `;
    return;
  }

  const rounded = roundEnoxaparinDose(baseDose);
  out.innerHTML = `
    <div><b>Calculated dose (weight-based):</b> ${baseDose.toFixed(0)} mg</div>
    <div><b>Rounded for prefilled syringe:</b> ${rounded.toFixed(0)} mg ${freqText}</div>
    <div class="small" style="margin-top:4px;">
      Rounded rule: doses ending in 0–5 mg are rounded <b>down</b> to the nearest 10,
      and doses ending in 6–9 mg are rounded <b>up</b> to the nearest 10.
    </div>
    <div class="small" style="margin-top:6px;">${context}</div>
  `;
}

function clearEnoxaparin(){
  const wtEl  = document.getElementById('enoxWeight');
  const typeEl= document.getElementById('enoxType');
  const out   = document.getElementById('enoxOut');
  if(wtEl) wtEl.value = '';
  if(typeEl) typeEl.value = 'tx_q12';
  if(out) out.innerHTML = '<span class="small">Bridging not required at this time.</span>';
}

/* ===========================
   Personal Response Model (lag-weighted)
   =========================== */

function getDoseWindowMode(){
  const sel = document.getElementById('doseWindowMode');
  return sel ? sel.value : 'prior7';
}

// Weights encode "influence" on INR. This is not mg/week.
const WEIGHTS_PRIOR7 = [0.4,0.4,1.0,1.0,0.7,0.7,0.3];  // days 1..7 (excludes today)
const WEIGHTS_ENDING7= [0.3,0.7,0.7,1.0,1.0,0.4,0.4];  // days 0..6 (includes today)

function weightedDoseForDate(date, mode){
  if(mode === 'ending7'){
    let sum = 0;
    for(let i=0;i<7;i++){
      const key = isoLocal(addDaysLocal(date, -i));
      sum += effAtIso(key) * WEIGHTS_ENDING7[i];
    }
    return r01(sum);
  }
  // default prior7
  let sum = 0;
  for(let i=1;i<=7;i++){
    const key = isoLocal(addDaysLocal(date, -i));
    sum += effAtIso(key) * WEIGHTS_PRIOR7[i-1];
  }
  return r01(sum);
}

// For model-informed "today dose" suggestion, we need a version where we can override today's dose
function weightedDoseEnding7WithTodayOverride(date, todayDoseOverride){
  let sum = 0;
  const todayIso = isoLocal(date);
  for(let i=0;i<7;i++){
    const key = isoLocal(addDaysLocal(date, -i));
    const dose = (key === todayIso) ? todayDoseOverride : effAtIso(key);
    sum += dose * WEIGHTS_ENDING7[i];
  }
  return r01(sum);
}

function buildInrDoseDataset(mode){
  const data = [];
  const t = new Date();
  for(let offset=-120; offset<=0; offset++){
    const d = addDaysLocal(t, offset);
    const key = isoLocal(d);
    if(!inrVal.has(key)) continue;
    const inr = inrVal.get(key);
    const dose7 = weightedDoseForDate(d, mode);
    if(!isNaN(inr) && dose7 > 0) data.push({dose7, inr});
  }
  return data;
}

function fitLinearDoseInrModel(data){
  if(!data || data.length < 5) return null;
  let sumX=0,sumY=0,sumXY=0,sumXX=0;
  const n = data.length;

  for(const pt of data){
    const x = pt.dose7, y = pt.inr;
    sumX += x; sumY += y; sumXY += x*y; sumXX += x*x;
  }
  const denom = (n*sumXX - sumX*sumX);
  if(denom === 0) return null;

  const b = (n*sumXY - sumX*sumY) / denom;
  const a = (sumY - b*sumX) / n;

  if(b <= 0.01){
    return { invalid:true, reason:'Dose–response direction unclear or inverse (reactive dosing / limited stable history).', n };
  }
  return { a, b, n };
}

function predictInrForDose7(model, dose7){
  if(!model || model.invalid) return null;
  const raw = model.a + model.b * dose7;
  return Math.max(0.5, Math.min(8.0, r01(raw)));
}

/* ===========================
   Recommendation engine
   =========================== */

function maybeAdjustRepeatForInteractions(currentRepeatIso){
  const auto = document.getElementById('autoAdjustRepeat');
  if(!auto || !auto.checked) return currentRepeatIso;
  const sum = interactionSummary(currentInteractionHits);
  if(!sum || sum.minSuggestedDays == null) return currentRepeatIso;

  const proposed = isoLocal(addDaysLocal(new Date(), sum.minSuggestedDays));
  if(!currentRepeatIso) return proposed;
  return (proposed < currentRepeatIso) ? proposed : currentRepeatIso;
}

function reco(){
  const goalObj = getActiveGoalRange();
  let L = goalObj.L, H = goalObj.H;

  if(isNaN(L)||isNaN(H)||L>=H){ alert('Set a valid INR goal/target.'); return }
  if(baseSum()<=0){ alert('Enter baseline regimen first.'); return }

  pendingRecalc=false;
  const hint=document.getElementById('recalcHint');
  if(hint) hint.style.display='none';
  const btn=document.getElementById('recalcNow');
  if(btn){ btn.disabled=true; btn.style.opacity='0.5'; }

  const todayIso = isoLocal(new Date());
  let bestDate = new Date();
  let bestVal = parseFloat(document.getElementById('inr').value);

  if(isNaN(bestVal) && inrVal.has(todayIso)) bestVal = inrVal.get(todayIso), bestDate=new Date();
  if(isNaN(bestVal)){
    for(let d=1; d<=3; d++){
      const key = isoLocal(addDaysLocal(new Date(), -d));
      if(inrVal.has(key)){ bestVal=inrVal.get(key); bestDate=addDaysLocal(new Date(), -d); break; }
    }
  }
  if(isNaN(bestVal)){
    rec.innerHTML = 'No recent INR in the last 3 days. <b>Get a new INR as soon as possible.</b> Do not change warfarin until a new result is available.';
    repeatKey = todayIso; hasReco=true;
    lastRecoINR = null; lastRepeatIso = null;
    pushDataToCells(); return;
  }

  const band = pickPct(bestVal, L, H);
  const age = daysBetween(bestDate, new Date());

  const mode = getDoseWindowMode();
  const dataset = buildInrDoseDataset(mode);
  const model = fitLinearDoseInrModel(dataset);

  // Interaction block to append
  const interHTML = buildInteractionHTML(currentInteractionHits);

  // Helpers for model block + model-informed suggestion
  function buildModelBlockHTML(contextLabel, dose7Value, targetInrMid){
    // base copy: clearer + explicit definition
    const windowLabel = (mode === 'ending7') ? '7-day window ending today (includes today)' : 'Prior 7 days (excludes today)';
    const expl = `Experimental trend estimate using your INR + dosing history (lag-weighted).`;

    if(!model){
      return `<div style="margin-top:10px;padding:12px 14px;border-radius:12px;background:#fff3cd;border:1px solid #ffe08a;font-size:13px;">
        <b>Personal response model (beta):</b> ${expl}<br>
        <b>Model window:</b> ${windowLabel}. <b>Not enough usable history yet</b> (need ≥5 INR-linked points with dosing history).<br>
        <div class="small" style="margin-top:8px;color:#666;">For insight only—does not replace clinical judgment and does not override protocol.</div>
      </div>`;
    }
    if(model.invalid){
      return `<div style="margin-top:10px;padding:12px 14px;border-radius:12px;background:#fff3cd;border:1px solid #ffe08a;font-size:13px;">
        <b>Personal response model (beta):</b> ${expl}<br>
        <b>Model window:</b> ${windowLabel}. <b>Not used</b>: <span style="color:#8a0000;"><b>${model.reason}</b></span><br>
        <div class="small" style="margin-top:8px;color:#666;">For insight only—does not replace clinical judgment and does not override protocol.</div>
      </div>`;
    }

    const est = predictInrForDose7(model, dose7Value);

    // Model-informed "today dose" suggestion (only meaningful if we can include today)
    let suggestLine = '';
    if(targetInrMid != null && mode === 'ending7'){
      // Solve model for weighted-dose target
      const dose7Target = (targetInrMid - model.a) / model.b;
      const safeTarget = Math.max(0, Math.min(80, dose7Target)); // cap to avoid absurd values

      // Translate to a "today dose" suggestion via today's weight (0.3)
      const currentTodayDose = effAtIso(todayIso);
      const currentWeighted = weightedDoseEnding7WithTodayOverride(new Date(), currentTodayDose);
      const wToday = WEIGHTS_ENDING7[0] || 0.3;

      let suggestedToday = currentTodayDose;
      if(wToday > 0.05){
        suggestedToday = currentTodayDose + ((safeTarget - currentWeighted) / wToday);
      }

      // Guardrails: avoid wild outputs; keep it "hint only"
      suggestedToday = Math.max(0, Math.min(20, suggestedToday));
      const suggestedTodayRounded = r05(suggestedToday);

      suggestLine = `
        <div style="margin-top:10px;padding-top:10px;border-top:1px dashed rgba(0,0,0,.15);">
          <b>Model-informed target hint (insight only):</b>
          To drift toward INR ≈ <b>${targetInrMid.toFixed(1)}</b>, model implies a weighted dose ≈ <b>${safeTarget.toFixed(1)} mg</b>.
          Approximate <b>today dose</b> that would move the weighted window toward that target: <b>${suggestedTodayRounded.toFixed(1)} mg</b>
          <span class="small" style="color:#666;">(bounded; does not override protocol)</span>.
        </div>
      `;
    }

    return `<div style="margin-top:10px;padding:12px 14px;border-radius:12px;background:#fff3cd;border:1px solid #ffe08a;font-size:13px;">
      <b>Personal response model (beta):</b> ${expl}<br>
      <b>Model window:</b> ${windowLabel}. <b>Weighted 7-day dose:</b> <b>${dose7Value.toFixed(1)} mg</b>.
      <b>Estimated INR:</b> <b>${(est!=null?est.toFixed(1):'—')}</b> (n=${model.n}). 
      ${suggestLine}
      <div class="small" style="margin-top:10px;color:#666;">For insight only—does not replace clinical judgment and does not override protocol.</div>
    </div>`;
  }

  // Target midpoint used for model-informed hint
  const targetMid = r01((L + H) / 2);

  if(band.pct===0){
    const rep = (age>=2 && age<=3) ? addDaysLocal(bestDate, 7) : addDaysLocal(new Date(), 7);
    repeatKey = isoLocal(rep);
    repeatKey = maybeAdjustRepeatForInteractions(repeatKey);

    lastRecoINR = bestVal;
    lastRepeatIso = repeatKey;

    const dose7 = weightedDoseForDate(new Date(), mode);

    rec.innerHTML =
      `INR <b>${bestVal.toFixed(1)}</b> is in your active range (<b>${L.toFixed(1)}–${H.toFixed(1)}</b>). ` +
      `<b>No change</b> to today’s warfarin dose. ` +
      `Repeat your INR on <b>${niceDate(repeatKey)}</b>.` +
      buildModelBlockHTML('Current window', dose7, targetMid) +
      (interHTML || '');

    hasReco=true;
    pushDataToCells(); lin7(); return;
  }

  const baseToday = schedAtIso(todayIso);
  const s7 = sched7EndOnDate(new Date());
  const p6 = last6SchedBeforeDate(new Date());
  const e6 = last6EffBeforeDate(new Date());

  const targetDelta = r01(s7 * band.pct);
  const priorDelta  = r01(e6 - p6);
  const remaining   = r01(targetDelta - priorDelta);

  const naive = r01((e6 + baseToday) * band.pct);
  const sign  = remaining>0?1:-1;
  const capped= Math.min(Math.abs(naive), Math.abs(remaining)) * sign;
  const target= Math.max(0, r01(baseToday + capped));
  const newDose = r05(target);

  planned.set(todayIso, newDose);

  let repDate;
  if(bestVal>4.5) repDate = addDaysLocal(new Date(), 2);
  else if(age>=2 && age<=3) repDate = addDaysLocal(bestDate, 7);
  else repDate = addDaysLocal(new Date(), 7);

  repeatKey = isoLocal(repDate);
  repeatKey = maybeAdjustRepeatForInteractions(repeatKey);

  lastRecoINR = bestVal;
  lastRepeatIso = repeatKey;

  const isHigh = bestVal > H;
  const dirText = isHigh ? 'above' : 'below';

  const dose7Window = weightedDoseForDate(new Date(), mode);

  rec.innerHTML =
    `INR <b>${bestVal.toFixed(1)}</b> is <b>${dirText}</b> your active range (<b>${L.toFixed(1)}–${H.toFixed(1)}</b>). ` +
    `Take <b>${newDose.toFixed(1)} mg of warfarin today</b> based on your recent dosing. ` +
    `Plan to recheck your INR on <b>${niceDate(repeatKey)}</b>, or sooner if your clinic advises.` +
    buildModelBlockHTML('Current window', dose7Window, targetMid) +
    (interHTML || '');

  hasReco=true;
  pushDataToCells(); lin7();
}

/* ===========================
   Week rows for PDF
   =========================== */
const weekdays = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

function buildWeekRows(startDate){
  let rows = '';
  for(let i=0;i<7;i++){
    const d = addDaysLocal(startDate, i);
    const key = isoLocal(d);
    const dayName = weekdays[d.getDay()];
    const dateStr = pad(d.getMonth()+1)+'/'+pad(d.getDate());

    const plannedDose = planned.has(key) ? planned.get(key) : NaN;
    const inrValNum   = inrVal.has(key) ? inrVal.get(key) : NaN;
    const actualDose  = actual.has(key) ? actual.get(key) : NaN;

    const plannedStr = isNaN(plannedDose) ? '—' : plannedDose.toFixed(1)+' mg';
    const inrStr     = isNaN(inrValNum)   ? '—' : inrValNum.toFixed(1);
    const actualStr  = isNaN(actualDose)  ? '—' : actualDose.toFixed(1)+' mg';
    const notesStr   = (repeatKey === key) ? 'Repeat INR' : '';

    rows += `
      <tr>
        <td>${dayName}</td>
        <td>${dateStr}</td>
        <td>${plannedStr}</td>
        <td>${inrStr}</td>
        <td>${actualStr}</td>
        <td>${notesStr}</td>
      </tr>`;
  }
  return rows;
}

/* ===========================
   PDF Export
   =========================== */
function exportRecommendationPDF(){
  const todayStr = isoLocal(today);
  const now = new Date();
  const timeStr = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

  const pName = (document.getElementById('patientName')?.value || '').trim();
  const pDob  = (document.getElementById('patientDob')?.value  || '').trim();
  const pMrn  = (document.getElementById('patientMrn')?.value  || '').trim();

  const patientInfoLine = [
    pName ? '<strong>Patient Name:</strong> ' + pName : '',
    pDob  ? '<strong>DOB:</strong> ' + pDob : '',
    pMrn  ? '<strong>MRN:</strong> ' + pMrn : ''
  ].filter(Boolean).join('&nbsp;&nbsp;&nbsp;&nbsp;');

  const thisWeekStart = startOfWeekLocal(today);
  const nextWeekStart = addDaysLocal(thisWeekStart, 7);

  const thisWeekRows = buildWeekRows(thisWeekStart);
  const nextWeekRows = buildWeekRows(nextWeekStart);

  const inrDisplay = lastRecoINR != null ? lastRecoINR.toFixed(1) : '—';
  const repDisplay = lastRepeatIso ? niceDate(lastRepeatIso) : '—';

  const win = window.open('', '_blank');
  if(!win){ alert('Please allow pop-ups to export the recommendation.'); return; }

  win.document.open();
  win.document.write(`
    <html>
    <head>
      <meta charset="utf-8">
      <title>ThromboLogic INR – Recommendation</title>
      <style>
        body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:16px;color:#111;}
        h1{font-size:18px;margin-bottom:2px;}
        h2{font-size:14px;margin:12px 0 4px;}
        .small{font-size:11px;color:#555;}
        table{border-collapse:collapse;width:100%;font-size:11px;margin-top:4px;}
        th,td{border:1px solid #ccc;padding:3px 4px;text-align:left;}
        th{background:#f3f3f3;font-weight:600;}
        .card{border:1px solid #ccc;border-radius:8px;padding:8px;margin:6px 0;background:#fafafa;}
        .summary-line{margin-top:8px;font-size:14px;}
        .summary-line b.big{font-size:18px;}
        .sig-block{margin-top:16px;font-size:11px;}
        .notes-box{min-height:60px;outline:none;white-space:pre-wrap;font-size:12px;}
        #printBtn{margin:4px 0 8px 8px;}
        @media print { #printBtn{display:none;} }
      </style>
    </head>
    <body>
      <button id="printBtn" onclick="window.print()" style="float:right;">Print / Save as PDF</button>

      <h1>ThromboLogic INR – Visit Summary</h1>
      <div class="small">Generated on ${todayStr} at ${timeStr}</div>
      ${patientInfoLine ? `<div class="small" style="margin-top:4px;">${patientInfoLine}</div>` : ''}

      <div class="summary-line">
        Latest INR:&nbsp;<b class="big">${inrDisplay}</b>
        &nbsp;&nbsp;&nbsp;
        Repeat INR date:&nbsp;<b class="big">${repDisplay}</b>
      </div>

      <h2>Recommendation</h2>
      <div class="card">
        ${rec.innerHTML || '<span class="small">No recommendation generated yet.</span>'}
      </div>

      <h2>This Week's Calendar View</h2>
      <div class="card">
        <table>
          <thead>
            <tr>
              <th>Day</th><th>Date</th><th>Planned dose (mg)</th><th>INR</th><th>Actual dose (mg)</th><th>Notes</th>
            </tr>
          </thead>
          <tbody>${thisWeekRows}</tbody>
        </table>
      </div>

      <h2>Next Week's Calendar View</h2>
      <div class="card">
        <table>
          <thead>
            <tr>
              <th>Day</th><th>Date</th><th>Planned dose (mg)</th><th>INR</th><th>Actual dose (mg)</th><th>Notes</th>
            </tr>
          </thead>
          <tbody>${nextWeekRows}</tbody>
        </table>
      </div>

      <h2>Provider Notes</h2>
      <div class="card notes-box" contenteditable="true"
           onfocus="if(this.getAttribute('data-edited')!=='1'){this.innerHTML='';this.setAttribute('data-edited','1');}">
        Click here to type provider notes before printing.
      </div>

      <div class="sig-block">
        ________________________________<br>
        Provider Signature &nbsp;&nbsp;&nbsp; Date: ____________
      </div>
    </body>
    </html>
  `);
  win.document.close();
  win.focus();
}

function openPatientHandout(){
  const todayStr = isoLocal(today);
  const now = new Date();
  const timeStr = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

  const pName = (document.getElementById('patientName')?.value || '').trim();
  const pDob  = (document.getElementById('patientDob')?.value  || '').trim();
  const pMrn  = (document.getElementById('patientMrn')?.value  || '').trim();

  const patientInfoLine = [
    pName ? '<strong>Patient Name:</strong> ' + pName : '',
    pDob  ? '<strong>DOB:</strong> ' + pDob : '',
    pMrn  ? '<strong>MRN:</strong> ' + pMrn : ''
  ].filter(Boolean).join('&nbsp;&nbsp;&nbsp;&nbsp;');

  const thisWeekStart = startOfWeekLocal(today);
  const nextWeekStart = addDaysLocal(thisWeekStart, 7);

  const thisWeekRows = buildWeekRows(thisWeekStart);
  const nextWeekRows = buildWeekRows(nextWeekStart);

  const inrDisplay = lastRecoINR != null ? lastRecoINR.toFixed(1) : '—';
  const repDisplay = lastRepeatIso ? niceDate(lastRepeatIso) : '—';

  const win = window.open('', '_blank');
  if(!win){ alert('Please allow pop-ups to open the patient handout view.'); return; }

  win.document.open();
  win.document.write(`
    <html>
    <head>
      <meta charset="utf-8">
      <title>ThromboLogic INR – Patient Handout</title>
      <style>
        body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:18px;color:#111;}
        h1{font-size:18px;margin-bottom:2px;}
        h2{font-size:14px;margin:12px 0 4px;}
        .small{font-size:11px;color:#555;}
        table{border-collapse:collapse;width:100%;font-size:11px;margin-top:4px;}
        th,td{border:1px solid #ccc;padding:3px 4px;text-align:left;}
        th{background:#f3f3f3;font-weight:600;}
        .card{border:1px solid #ccc;border-radius:8px;padding:8px;margin:6px 0;background:#fafafa;}
        .summary-line{margin-top:8px;font-size:14px;}
        .summary-line b.big{font-size:18px;}
      </style>
    </head>
    <body>
      <h1>ThromboLogic INR – Patient Dosing Summary</h1>
      <div class="small">Generated on ${todayStr} at ${timeStr}</div>
      ${patientInfoLine ? `<div class="small" style="margin-top:4px;">${patientInfoLine}</div>` : ''}

      <div class="summary-line">
        Latest INR:&nbsp;<b class="big">${inrDisplay}</b>
        &nbsp;&nbsp;&nbsp;
        Repeat INR date:&nbsp;<b class="big">${repDisplay}</b>
      </div>

      <h2>This Week's Calendar View</h2>
      <div class="card">
        <table>
          <thead>
            <tr>
              <th>Day</th><th>Date</th><th>Planned dose (mg)</th><th>INR</th><th>Actual dose (mg)</th><th>Notes</th>
            </tr>
          </thead>
          <tbody>${thisWeekRows}</tbody>
        </table>
      </div>

      <h2>Next Week's Calendar View</h2>
      <div class="card">
        <table>
          <thead>
            <tr>
              <th>Day</th><th>Date</th><th>Planned dose (mg)</th><th>INR</th><th>Actual dose (mg)</th><th>Notes</th>
            </tr>
          </thead>
          <tbody>${nextWeekRows}</tbody>
        </table>
      </div>
    </body>
    </html>
  `);
  win.document.close();
  win.focus();
}

/* ===========================
   What-if prediction panel
   =========================== */
function runWhatIfPrediction(){
  const predInput = document.getElementById('predWeeklyDose');
  const predOut = document.getElementById('predOut');
  const v = parseFloat(predInput.value);
  if(isNaN(v) || v <= 0){
    predOut.innerHTML = '<span style="color:#b00020;">Enter a valid proposed weighted 7-day dose.</span>';
    return;
  }

  const mode = getDoseWindowMode();
  const dataset = buildInrDoseDataset(mode);
  const model = fitLinearDoseInrModel(dataset);

  if(!model){
    predOut.innerHTML = '<span style="color:#b00020;">Not enough usable historical data (need ≥5 INR-linked points).</span>';
    return;
  }
  if(model.invalid){
    predOut.innerHTML = `
      <div style="color:#8a0000;"><b>Model not used.</b></div>
      <div class="small">Reason: ${model.reason}</div>
      <div class="small" style="margin-top:4px;">This prevents inverse (non-physiologic) predictions.</div>
    `;
    return;
  }

  const predicted = predictInrForDose7(model, v);
  const windowLabel = (mode === 'ending7') ? '7-day window ending today (includes today)' : 'Prior 7 days (excludes today)';
  predOut.innerHTML = `
    <div>
      Estimated INR for a <b>weighted 7-day dose</b> of <b>${v.toFixed(1)} mg</b> is approximately
      <b style="font-size:16px;">${predicted.toFixed(1)}</b>.
    </div>
    <div class="small" style="margin-top:4px;">
      Model window: ${windowLabel}. Based on ${model.n} historical points. Lag-aware weighting + direction constraint applied. Trend insight only.
    </div>
  `;
}

/* ===========================
   DEMO HISTORY (one-click)
   =========================== */
function setBaselineRegimen(values7){
  for(let i=0;i<7;i++){
    const el = document.getElementById('b'+i);
    if(el) el.value = (values7[i] ?? 0).toFixed(1);
  }
  updSum();
  applyVisible();
}

function setDemoMessage(text, isError=false){
  const el = document.getElementById('demoMsg');
  if(!el) return;
  el.style.display = 'inline';
  el.style.color = isError ? '#b00020' : '#2e7d32';
  el.textContent = text;
}

function clearDemoHistoryOnly(){
  planned.clear();
  actual.clear();
  inrVal.clear();
  repeatKey = null;
  hasReco = false;
  pendingRecalc = false;
  lastRecoINR = null;
  lastRepeatIso = null;

  const inrTop = document.getElementById('inr');
  if(inrTop) inrTop.value = '';

  rec.innerHTML = '';
  document.getElementById('predOut').innerHTML = '';
  setDemoMessage('Demo history cleared.', false);

  applyVisible();
  pushDataToCells(); lin7();
}

function loadDemoHistory(){
  planned.clear(); actual.clear(); inrVal.clear();
  repeatKey = null;
  hasReco = false;
  pendingRecalc = false;
  lastRecoINR = null;
  lastRepeatIso = null;
  rec.innerHTML = '';
  document.getElementById('predOut').innerHTML = '';

  setBaselineRegimen([5,5,5,5,5,5,5]);

  const t = new Date();
  const mk = (daysAgo)=> isoLocal(addDaysLocal(t, -daysAgo));

  function fillDose(daysAgoStart, daysAgoEnd, dose){
    for(let d=daysAgoStart; d>=daysAgoEnd; d--){
      const key = mk(d);
      planned.set(key, r01(dose));
      actual.set(key, r01(dose));
    }
  }

  fillDose(35,22,5.0);
  fillDose(21,8,6.0);
  fillDose(7,1,4.0);

  const inrPoints = [
    {daysAgo:28, inr:2.1},
    {daysAgo:24, inr:2.0},
    {daysAgo:20, inr:2.4},
    {daysAgo:16, inr:2.7},
    {daysAgo:12, inr:2.9},
    {daysAgo:9,  inr:2.8},
    {daysAgo:5,  inr:2.0},
    {daysAgo:2,  inr:1.8},
  ];
  for(const p of inrPoints){
    inrVal.set(mk(p.daysAgo), r01(p.inr));
  }

  const inrTop = document.getElementById('inr');
  if(inrTop){
    inrTop.value = '1.8';
    inrVal.set(isoLocal(new Date()), 1.8);
  }

  const predInput = document.getElementById('predWeeklyDose');
  if(predInput) predInput.value = (35.0).toFixed(1);

  pushDataToCells(); lin7();
  scrollToTodayWeek();
  setDemoMessage('Demo history loaded: stable-dose segments + INR points (designed to train a positive dose→INR relationship).', false);
}

/* ===========================
   DOM init + listeners
   =========================== */
document.addEventListener('DOMContentLoaded', ()=>{
  try{ renderAll(); updSum(); }catch(e){ err.textContent = 'Calendar failed to render: '+e; }

  setTimeout(scrollToTodayWeek, 50);

  for(let i=0;i<7;i++){
    const el=document.getElementById('b'+i);
    if(el){ el.addEventListener('input', ()=>{ updSum(); }) }
  }

  document.getElementById('goal').addEventListener('change', (ev)=>{
    const v = ev.target.value;
    document.getElementById('cust').style.display = (v==='custom')?'block':'none';
  });

  // Procedure target preview
  function updateProcPreview(){
    const on = document.getElementById('procTargetOn')?.checked;
    const t = parseFloat(document.getElementById('procTarget')?.value);
    const tol = parseFloat(document.getElementById('procTol')?.value);
    const el = document.getElementById('procRangePreview');
    if(!el) return;
    if(on && !isNaN(t) && !isNaN(tol) && tol>0){
      el.innerHTML = `<b>Active target range:</b> ${r01(t-tol).toFixed(1)}–${r01(t+tol).toFixed(1)}`;
    }else{
      el.innerHTML = '';
    }
  }
  ['procTargetOn','procTarget','procTol'].forEach(id=>{
    const x=document.getElementById(id);
    if(x) x.addEventListener('input', updateProcPreview);
    if(x) x.addEventListener('change', updateProcPreview);
  });
  updateProcPreview();

  // Interaction listeners
  const medList = document.getElementById('medList');
  const results = document.getElementById('interactionResults');
  function renderInteractions(){
    const hits = matchInteractions(medList.value || '');
    currentInteractionHits = hits;
    if(!hits.length){
      results.style.display='none';
      results.innerHTML='';
      return;
    }
    results.style.display='block';
    results.innerHTML = buildInteractionHTML(hits);
  }
  document.getElementById('checkInteractions').addEventListener('click', renderInteractions);
  document.getElementById('clearInteractions').addEventListener('click', ()=>{
    medList.value='';
    currentInteractionHits=[];
    results.style.display='none';
    results.innerHTML='';
  });
  medList.addEventListener('blur', ()=>{ if(medList.value.trim()) renderInteractions(); });

  const inrTop = document.getElementById('inr');
  const tIso = isoLocal(new Date());
  inrTop.addEventListener('input', e=>{
    const v = parseFloat(e.target.value);
    if(!isNaN(v)) inrVal.set(tIso, v); else inrVal.delete(tIso);
  });
  inrTop.addEventListener('blur', e=>{
    const v = parseFloat(e.target.value);
    if(!isNaN(v)){
      const vv = r01(v);
      inrVal.set(tIso, vv);
      const qi = document.querySelector('#c_'+tIso+' .cell-input.inrbox');
      if(qi) qi.value = vv.toFixed(1);
    }else{
      inrVal.delete(tIso);
    }
    if(hasReco){ markNeedsRecalc(); }
    pushDataToCells(); lin7();
  });

  document.getElementById('getRec').addEventListener('click', reco);

  const recalcBtn = document.getElementById('recalcNow');
  if(recalcBtn){
    recalcBtn.disabled = true;
    recalcBtn.style.opacity = '0.5';
    recalcBtn.addEventListener('click', ()=>{
      if(!hasReco && !pendingRecalc){ return; }
      reco();
    });
  }

  document.getElementById('applyCur').addEventListener('click', applyVisible);
  document.getElementById('clearVisible').addEventListener('click', clearVisible);
  document.getElementById('clearAll').addEventListener('click', clearAll);

  const goTodayBtn = document.getElementById('goToday');
  if (goTodayBtn) goTodayBtn.addEventListener('click', scrollToTodayWeek);

  const exportBtn = document.getElementById('exportPDF');
  if (exportBtn) exportBtn.addEventListener('click', exportRecommendationPDF);

  const handoutBtn = document.getElementById('patientHandout');
  if (handoutBtn) handoutBtn.addEventListener('click', openPatientHandout);

  const enoxBtn = document.getElementById('calcEnox');
  if (enoxBtn) enoxBtn.addEventListener('click', calcEnoxaparinDose);

  const clearEnoxBtn = document.getElementById('clearEnox');
  if (clearEnoxBtn) clearEnoxBtn.addEventListener('click', clearEnoxaparin);

  const predBtn = document.getElementById('runPrediction');
  if(predBtn) predBtn.addEventListener('click', runWhatIfPrediction);

  const demoBtn = document.getElementById('loadDemo');
  if(demoBtn) demoBtn.addEventListener('click', loadDemoHistory);

  const clearDemoBtn = document.getElementById('clearDemo');
  if(clearDemoBtn) clearDemoBtn.addEventListener('click', clearDemoHistoryOnly);

  // If window mode changes, mark rec as stale (because the yellow box context changes)
  const winSel = document.getElementById('doseWindowMode');
  if(winSel){
    winSel.addEventListener('change', ()=>{
      if(hasReco) markNeedsRecalc();
    });
  }

  // DOB auto-format + FIXED validation
  const dobInput = document.getElementById('patientDob');
  const dobInlineErr = document.getElementById('dobInlineErr');
  if(dobInput){
    dobInput.addEventListener('input', e=>{
      let v = e.target.value.replace(/\D/g,'');
      if(v.length > 8) v = v.slice(0,8);
      let out = '';
      if(v.length <= 2) out = v;
      else if(v.length <= 4) out = v.slice(0,2) + '/' + v.slice(2);
      else out = v.slice(0,2) + '/' + v.slice(2,4) + '/' + v.slice(4);
      e.target.value = out;

      if(isValidDob(out) || !out){
        dobInput.classList.remove('invalidField');
        dobInlineErr.style.display='none';
      }
    });

    function isValidDob(val){
      if(!val) return true;
      const parts = val.split('/');
      if(parts.length !== 3) return false;
      const m = parseInt(parts[0],10), d = parseInt(parts[1],10), y = parseInt(parts[2],10);
      if([m,d,y].some(n=>isNaN(n))) return false;
      if(m<1||m>12) return false;
      if(d<1||d>31) return false;
      if(y<1900||y>2100) return false;
      const dt = new Date(y, m-1, d);
      return dt.getFullYear()===y && dt.getMonth()===(m-1) && dt.getDate()===d;
    }

    dobInput.addEventListener('blur', e=>{
      const val = e.target.value;
      if(!val){
        dobInput.classList.remove('invalidField');
        dobInlineErr.style.display='none';
        return;
      }
      if(!isValidDob(val)){
        dobInput.classList.add('invalidField');
        dobInlineErr.style.display='block';
      }else{
        dobInput.classList.remove('invalidField');
        dobInlineErr.style.display='none';
      }
    });
  }

  // Delegated inputs for calendar
  weeksEl.addEventListener('input', (e)=>{
    const t = e.target;
    if(!(t instanceof HTMLInputElement)) return;
    const key = t.getAttribute('data-k'); const role = t.getAttribute('data-role');
    if(!key||!role) return;
    const v = t.value === '' ? NaN : parseFloat(t.value);
    if(role==='planned'){ if(isNaN(v)) planned.delete(key); else planned.set(key, v); }
    if(role==='actual'){ if(isNaN(v)) actual.delete(key); else actual.set(key, v); }
    if(role==='inr'){    if(isNaN(v)) inrVal.delete(key); else inrVal.set(key, v); }
  });

  weeksEl.addEventListener('blur', (e)=>{
    const t = e.target;
    if(!(t instanceof HTMLInputElement)) return;
    const key = t.getAttribute('data-k'); const role = t.getAttribute('data-role');
    if(!key||!role) return;
    const v = parseFloat(t.value);
    if(!isNaN(v)){
      const val = r01(v);
      if(role==='planned') planned.set(key, val);
      if(role==='actual')  actual.set(key, val);
      if(role==='inr')     inrVal.set(key, val);
    }else{
      if(role==='planned') planned.delete(key);
      if(role==='actual')  actual.delete(key);
      if(role==='inr')     inrVal.delete(key);
    }
    if(role==='inr' && hasReco) markNeedsRecalc();
    pushDataToCells(); lin7();
  }, true);
});
</script>
</div>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="format-detection" content="telephone=no">

<!-- Optional PWA-ish hooks (safe even if you don’t have these files yet) -->
<link rel="manifest" href="manifest.webmanifest">
<link rel="apple-touch-icon" href="assets/icon-192.png">
<title>ThromboLogic INR</title>
<style>
:root{--blue:#eaf3ff;--blue-ring:rgba(13,110,253,.25);--ylw:#fffef0;--man:#ffe79a;--man-b:#ffc857;--card:#fafafa}
*{box-sizing:border-box}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:16px;color:#111}
h1{font-size:19px;margin:0 0 8px} h2{font-size:15px;margin:16px 0 6px}
.small{font-size:12px;color:#555} .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
fieldset{border:1px solid #ddd;border-radius:10px;padding:10px;margin:10px 0} legend{padding:0 6px}
input,select,button,textarea{font-size:15px} input,select,textarea{padding:8px;border:1px solid #b9c1cc;border-radius:10px}
textarea{resize:vertical}
.btn{padding:8px 12px;border:0;border-radius:10px;background:#444;color:#fff;cursor:pointer;margin-right:8px}
.btnp{padding:10px 14px;border:0;border-radius:10px;background:#0d6efd;color:#fff;cursor:pointer;font-weight:700;margin:8px 0;display:inline-block}
.btnS{padding:4px 8px;border:0;border-radius:8px;background:#444;color:#fff;cursor:pointer;margin-right:6px;font-size:13px}
.btn:disabled,.btnp:disabled,.btnS:disabled{opacity:.55;cursor:not-allowed}
.container{max-width:860px;margin:0 auto}
.grid{display:grid;gap:10px} @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
.grid7{display:grid;grid-template-columns:repeat(7,minmax(64px,1fr));gap:6px}
.grid7>div{display:flex;flex-direction:column;gap:4px;align-items:center}
.grid7 input{width:84px;max-width:84px;padding:6px;font-size:14px}
.toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:6px 0 10px}
.calwrap{
  border:1px solid #eee;
  border-radius:12px;
  overflow:auto;
  max-height:72vh;
  background:linear-gradient(#fff,#fff) padding-box,
             linear-gradient(180deg,#f7f8fa,#fff) border-box;
  -webkit-overflow-scrolling: touch;
}
.week{display:grid;grid-template-columns:repeat(7, minmax(90px,1fr));gap:8px;padding:10px;border-bottom:1px solid #f0f0f0}
.weekHeader{position:sticky;top:0;background:#fff;padding:8px 12px;border-bottom:1px solid #eee;z-index:2;display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
.day{border:1px solid #fff;border-radius:10px;padding:6px;background:var(--ylw);position:relative;display:flex;flex-direction:column;min-height:148px}
.day .hdr{display:flex;align-items:center;justify-content:space-between;gap:6px;margin-bottom:2px}
.day .hdr b{font-size:12px} .date{font-size:11px;color:#666}
.blue{background:var(--blue)!important;box-shadow:inset 0 0 0 2px var(--blue-ring)}
.manual{background:var(--man)!important;box-shadow:inset 0 0 0 2px var(--man-b)}
.lbl{font-size:11px;color:#444;text-align:center;margin-top:2px}
.cell-input{display:block;width:84px;max-width:84px;margin:4px auto;border:1px solid #b7c3d0;border-radius:10px;padding:6px;text-align:center;font-size:14px}
.inrbox{font-weight:800}
.card{border:1px solid #eee;border-radius:10px;padding:10px;background:var(--card)}
.legend{display:flex;gap:12px;align-items:center;font-size:12px;margin:6px 0 10px}
.sw{display:inline-block;width:14px;height:14px;border-radius:3px;border:1px solid #fff;box-shadow:inset 0 0 0 1px rgba(0,0,0,.05);margin-right:4px}
.err{color:#b00020;font-size:12px;margin:6px 0} .debug{font-size:11px;color:#666;margin-top:6px}
@media(max-width:700px){.container{max-width:96vw}.week{grid-template-columns:repeat(7, minmax(76px,1fr));gap:6px}.cell-input,.grid7 input{width:78px;max-width:78px;font-size:13px;padding:5px}.day{min-height:138px}}
.orangeCell{background:#ffe0b3!important;box-shadow:inset 0 0 0 2px #ff9800}
.redCell{background:#ffc2c2!important;box-shadow:inset 0 0 0 2px #e53935}
.repeat-inr{font-size:11px;color:#b00020;margin-top:3px;text-align:center}

/* Patient info emphasis */
.patient-grid{display:flex;flex-wrap:wrap;gap:16px}
.patient-field{display:flex;flex-direction:column;min-width:180px}
.patient-field label{font-weight:600;margin-bottom:4px}

/* DOB inline error */
.invalidField{border-color:#b00020 !important; box-shadow:0 0 0 3px rgba(176,0,32,.12)}
.inlineErr{color:#b00020;font-size:12px;margin-top:6px;display:none}

/* Interaction UI */
.badges{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.badge{display:inline-flex;align-items:center;gap:6px;border:1px solid #ddd;border-radius:999px;padding:3px 10px;font-size:12px;background:#fff}
.badge.major{border-color:#e53935}
.badge.moderate{border-color:#ff9800}
.badge.bleeding{border-color:#7b1fa2}
.kv{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
.kv > div{border:1px dashed #ddd;border-radius:10px;padding:8px 10px;background:#fff}
.kv b{font-size:13px}

/* Hide export button when printing */
@media print { #exportPDF{display:none !important;} }

/* Prediction grids */
.predGridTitle{font-weight:700;margin-top:6px}
.predRow{display:grid;grid-template-columns:repeat(7,minmax(78px,1fr));gap:8px;align-items:end}
.predCell{display:flex;flex-direction:column;gap:4px;align-items:center}
.predCell label{font-size:12px;color:#555}
.predCell input{width:86px;max-width:86px;padding:6px;font-size:14px;text-align:center}
@media(max-width:700px){.predCell input{width:78px;max-width:78px;font-size:13px;padding:5px}}

/* Footer */
.footerStamp{
  margin-top:14px;
  padding-top:10px;
  border-top:1px solid #eee;
  font-size:11px;
  color:#777;
  text-align:center;
}

/* Tablet strengths UI */
.pills{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
.pill{
  display:inline-flex;align-items:center;gap:8px;
  border:1px solid #ddd;border-radius:999px;padding:6px 10px;background:#fff;
  font-size:13px;
}
.pill input{transform:scale(1.05)}
.notice{
  margin-top:8px;
  padding:8px 10px;
  border-radius:10px;
  border:1px solid #e6e6e6;
  background:#fff;
  font-size:12px;
  color:#555;
}

/* ===========================
   Patient Profiles (multi-patient)
   =========================== */
.profilesBar{
  border:1px solid #eee;border-radius:12px;padding:10px;background:#fff;margin:10px 0 14px;
}
.profilesTop{
  display:flex;gap:10px;align-items:center;flex-wrap:wrap;
}
.profilesTop input{
  flex:1;min-width:240px;
}
.profilesBtns{display:flex;gap:8px;flex-wrap:wrap}
.profileList{
  margin-top:10px;
  border:1px solid #eee;border-radius:12px;
  overflow:auto;max-height:220px;
  background:#fafafa;
}
.profileRow{
  padding:10px 10px;border-bottom:1px solid #eee;background:#fff;cursor:pointer;
}
.profileRow:last-child{border-bottom:0}
.profileRow:hover{background:#f7f8fa}
.profileRow.active{outline:2px solid rgba(13,110,253,.25); background:#f4f8ff}
.profileRow b{display:block;font-size:14px}
.profileMeta{font-size:12px;color:#555;margin-top:2px}
.profileMeta span{margin-right:10px}
.currentLine{
  margin-top:10px;font-size:12px;color:#444;display:flex;gap:10px;align-items:center;flex-wrap:wrap;
}
.unsavedDot{
  display:none;
  padding:2px 8px;border-radius:999px;border:1px solid #ff9800;
  background:#fff7e6;color:#7a4a00;font-size:12px;
}
</style>
</head>
<body>
<div class="container">

  <!-- ThromboLogic Header Branding -->
  <div style="display:flex; align-items:center; gap:14px; margin:0 0 6px 0;">
    <img src="ThromboLogic INR Logo Design.png"
         alt="ThromboLogic INR Logo"
         style="height:80px; width:auto;">
    <div style="display:flex; flex-direction:column; line-height:1.1;">
      <span style="font-size:26px; font-weight:800;">ThromboLogic</span>
      <span style="font-size:16px; font-weight:600;">INR</span>
      <span class="small" style="margin-top:4px;">INR v7.5 (Target INR + weighted-dose-aware recommendation + 7-day what-if)</span>
    </div>
  </div>

  <div class="toolbar">
    <span class="small" id="rangeLabel"></span>
  </div>

  <div id="err" class="err"></div>

  <!-- Patient Profiles (NEW) -->
  <h2>Patient Profiles</h2>
  <div class="profilesBar">
    <div class="profilesTop">
      <input id="profileSearch" type="text" placeholder="Search patients (Name, MRN, Phone)…">
      <div class="profilesBtns">
        <button class="btnS" id="btnNewPatient" type="button">New</button>
        <button class="btnS" id="btnSavePatient" type="button">Save</button>
        <button class="btnS" id="btnSaveAsPatient" type="button">Save As…</button>
        <button class="btnS" id="btnDeletePatient" type="button">Delete</button>
      </div>
    </div>

    <div id="profileList" class="profileList" style="display:none;"></div>

    <div class="currentLine">
      <div id="currentPatientLabel">Currently loaded: <b>None</b></div>
      <div id="unsavedBadge" class="unsavedDot">● Unsaved changes</div>
    </div>

    <div class="small" style="margin-top:6px;color:#666;">
      Saved locally on this device/browser only. Clearing browser data will remove profiles.
    </div>
  </div>

  <!-- Patient Information -->
  <h2>Patient Information</h2>
  <fieldset><legend>Patient</legend>
    <div class="patient-grid">
      <div class="patient-field">
        <label for="patientName">Patient Name</label>
        <input id="patientName" type="text" placeholder="e.g., John Smith">
      </div>
      <div class="patient-field">
        <label for="patientDob">DOB (MM/DD/YYYY)</label>
        <input id="patientDob" type="text" placeholder="e.g., 01/02/1970" maxlength="10">
        <div id="dobInlineErr" class="inlineErr">Please enter DOB as a valid date in MM/DD/YYYY format.</div>
      </div>
      <div class="patient-field">
        <label for="patientMrn">MRN</label>
        <input id="patientMrn" type="text" placeholder="e.g., 1234567">
      </div>
      <div class="patient-field">
        <label for="patientPhone">Phone (optional)</label>
        <input id="patientPhone" type="text" placeholder="e.g., 8185551212">
      </div>
    </div>
  </fieldset>

  <!-- Tablet-strength constraint (NEW) -->
  <h2>Tablet Strengths (Optional)</h2>
  <fieldset><legend>Constrain today’s dose to tablets on hand</legend>
    <label style="display:flex;gap:10px;align-items:flex-start;">
      <input id="useTabletConstraint" type="checkbox">
      <span class="small">
        <b>Constrain today’s recommended dose</b> to a combination of the patient’s available warfarin tablet strengths using <b>whole + half tablets only</b>.
        (No quarter-tablet options.)
      </span>
    </label>

    <div id="tabletPanel" style="display:none;margin-top:10px;">
      <div class="small" style="margin-bottom:6px;"><b>Select strengths the patient has on hand:</b></div>
      <div class="pills" id="tabletPills">
        <label class="pill"><input type="checkbox" data-strength="1"> 1 mg</label>
        <label class="pill"><input type="checkbox" data-strength="2"> 2 mg</label>
        <label class="pill"><input type="checkbox" data-strength="2.5"> 2.5 mg</label>
        <label class="pill"><input type="checkbox" data-strength="3"> 3 mg</label>
        <label class="pill"><input type="checkbox" data-strength="4"> 4 mg</label>
        <label class="pill"><input type="checkbox" data-strength="5"> 5 mg</label>
        <label class="pill"><input type="checkbox" data-strength="6"> 6 mg</label>
        <label class="pill"><input type="checkbox" data-strength="7.5"> 7.5 mg</label>
        <label class="pill"><input type="checkbox" data-strength="10"> 10 mg</label>
      </div>
      <div class="notice">
        This feature affects <b>today’s planned dose only</b> (the calendar cell for today and the verbal recommendation will match).
        Turn OFF if you intend to prescribe a new strength.
      </div>
      <div id="tabletWarn" class="inlineErr" style="display:none;margin-top:8px;">Select at least one tablet strength (or turn OFF the constraint).</div>
    </div>
  </fieldset>

  <h2>Therapeutic Goal & Current INR</h2>
  <fieldset><legend>Inputs</legend>
    <div class="grid">
      <div>
        <label>Therapeutic Goal INR</label>

        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <select id="goal" style="min-width:230px;">
            <option value="2-3" selected>Preset: 2.0–3.0</option>
            <option value="2.5-3.5">Preset: 2.5–3.5</option>
            <option value="custom">Custom…</option>
          </select>

          <button class="btnS" id="toggleTarget" type="button" title="Optional: aim for a specific INR within the goal range (e.g., low end for a procedure).">
            Target INR
          </button>
        </div>

        <!-- Progressive interval toggle -->
        <div style="margin-top:10px;">
          <label style="display:flex;gap:10px;align-items:center;">
            <input id="useProgressiveInterval" type="checkbox" checked>
            <span class="small">
              Progressive INR interval (stability-based) — extends to 2–5 weeks after consecutive in-range weekly INRs (<b>if appropriate</b>)
            </span>
          </label>
        </div>

        <div id="cust" style="display:none; margin-top:6px;">
          <div style="display:flex; align-items:center; gap:6px; margin-bottom:6px;">
            <label>Low</label>
            <input id="gL" type="number" step="0.1" min="0" inputmode="decimal"
                   placeholder="e.g., 2.3"
                   style="width:80px; padding:6px;">
          </div>
          <div style="display:flex; align-items:center; gap:6px;">
            <label>High</label>
            <input id="gH" type="number" step="0.1" min="0" inputmode="decimal"
                   placeholder="e.g., 3.3"
                   style="width:80px; padding:6px;">
          </div>
        </div>

        <div id="targetPanel" style="display:none;margin-top:10px;padding:10px;border:1px solid #e6e6e6;border-radius:10px;background:#fff;">
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
            <div style="display:flex;flex-direction:column;">
              <label for="targetInr"><b>Target INR</b> (optional)</label>
              <input id="targetInr" type="number" step="0.1" min="0" inputmode="decimal" placeholder="e.g., 2.1"
                     style="width:120px;">
            </div>
            <div class="small" style="max-width:420px;">
              Use this when you want the INR toward a specific point <b>within</b> the therapeutic range (e.g., many procedures prefer the lower end).
              ThromboLogic will make only a <b>small, cautious</b> adjustment when your INR is already “in range.”
            </div>
          </div>
        </div>
      </div>

      <div>
        <div style="display:flex; flex-direction:column; justify-content:flex-start; padding-top:2px;">
          <label style="margin-bottom:4px;">Current INR</label>
          <input id="inr"
                 class="cell-input inrbox"
                 type="number"
                 step="0.1"
                 min="0"
                 inputmode="decimal"
                 placeholder="e.g., 2.6"
                 style="margin:0; max-width:105px;">
          <div class="small" style="margin-top:4px;">Typing here auto-fills today’s INR cell.</div>
        </div>
      </div>

    </div>
  </fieldset>

  <h2>Scheduled Maintenance Dosing</h2>
  <fieldset><legend>Baseline regimen (Sun → Sat)</legend>
    <div class="grid7">
      <div>Sun<input id="b0" type="number" step="0.1" min="0" inputmode="decimal"></div>
      <div>Mon<input id="b1" type="number" step="0.1" min="0" inputmode="decimal"></div>
      <div>Tue<input id="b2" type="number" step="0.1" min="0" inputmode="decimal"></div>
      <div>Wed<input id="b3" type="number" step="0.1" min="0" inputmode="decimal"></div>
      <div>Thu<input id="b4" type="number" step="0.1" min="0" inputmode="decimal"></div>
      <div>Fri<input id="b5" type="number" step="0.1" min="0" inputmode="decimal"></div>
      <div>Sat<input id="b6" type="number" step="0.1" min="0" inputmode="decimal"></div>
    </div>
    <div style="margin-top:8px">
      <button class="btn" id="applyCur">Apply to visible weeks</button>
      <button class="btn" id="clearVisible">Clear visible only</button>
      <button class="btn" id="clearAll">Clear ALL</button>
    </div>
    <div style="margin-top:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
      <button class="btnp" id="getRec">Get Recommendation</button>
      <button class="btnS" id="recalcNow" type="button" disabled style="opacity:0.5;">Recalculate with updated INR</button>
      <span id="recalcHint" class="small" style="display:none;">INR changed since the last recommendation.</span>
    </div>
    <div id="sum" class="small" style="margin-top:6px">Scheduled weekly total: 0.0 mg</div>
  </fieldset>

  <div class="legend">
    <span><span class="sw" style="background:var(--blue);box-shadow:inset 0 0 0 2px var(--blue-ring)"></span>Today / Repeat INR</span>
    <span><span class="sw" style="background:var(--man);box-shadow:inset 0 0 0 2px var(--man-b)"></span>Manual entry present</span>
    <span><span class="sw" style="background:var(--ylw)"></span>Default</span>
  </div>

  <h2>Scrollable Live Calendar</h2>
  <div class="calwrap" id="calwrap">
    <div class="weekHeader">
      <b>Scroll within this window to view past and future weeks.</b>
      <button class="btnS" id="goToday">Go to today</button>
    </div>
    <div id="weeks"></div>
  </div>
  <div id="dbg" class="debug"></div>

  <!-- Verbal Recommendation + Export button -->
  <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;margin-top:16px;">
    <h2 style="margin:0;">Verbal Recommendation</h2>
    <div>
      <button class="btnS" id="patientHandout" type="button">Patient handout view</button>
      <button class="btnS" id="exportPDF" type="button">Export to PDF</button>
    </div>
  </div>

  <div id="rec" class="card"></div>

  <h2>7-Day Recommendation (Linear — Today's Week)</h2>
  <div id="lin" class="card mono"></div>

  <!-- Predicted INR -->
  <h2>Predicted INR (What-if – Beta)</h2>
  <div class="card small" id="predictCard">
    <div style="margin-bottom:6px;">
      Uses prior INR + dosing history to estimate a trend response. This is <b>experimental</b>,
      lag-aware (weighted), and direction-constrained (will refuse inverse models). Use clinical judgment.
    </div>

    <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-top:6px;">
      <button class="btnS" type="button" id="loadDemo">Load demo history</button>
      <button class="btnS" type="button" id="clearDemo" title="Clears planned/actual/INR history only (keeps baseline inputs)">Clear demo history</button>
      <span class="small" id="demoMsg" style="display:none;"></span>
    </div>

    <div class="predGridTitle">Enter the last 7 daily doses (mg) to estimate current trend (yesterday → 7 days ago)</div>
    <div class="small" style="margin-top:2px;color:#666;">INR responds with delay, so more recent doses count more.</div>
    <div class="predRow" style="margin-top:8px;">
      <div class="predCell"><label>1d ago</label><input id="pd1" type="number" step="0.5" min="0"></div>
      <div class="predCell"><label>2d ago</label><input id="pd2" type="number" step="0.5" min="0"></div>
      <div class="predCell"><label>3d ago</label><input id="pd3" type="number" step="0.5" min="0"></div>
      <div class="predCell"><label>4d ago</label><input id="pd4" type="number" step="0.5" min="0"></div>
      <div class="predCell"><label>5d ago</label><input id="pd5" type="number" step="0.5" min="0"></div>
      <div class="predCell"><label>6d ago</label><input id="pd6" type="number" step="0.5" min="0"></div>
      <div class="predCell"><label>7d ago</label><input id="pd7" type="number" step="0.5" min="0"></div>
    </div>

    <div class="predGridTitle" style="margin-top:12px;">Enter the next 7 daily doses (mg) to estimate INR after 7 days on the new plan (today → +6 days)</div>
    <div class="small" style="margin-top:2px;color:#666;">This simulates a dose change starting today.</div>
    <div class="predRow" style="margin-top:8px;">
      <div class="predCell"><label>Today</label><input id="fd0" type="number" step="0.5" min="0"></div>
      <div class="predCell"><label>+1 day</label><input id="fd1" type="number" step="0.5" min="0"></div>
      <div class="predCell"><label>+2 days</label><input id="fd2" type="number" step="0.5" min="0"></div>
      <div class="predCell"><label>+3 days</label><input id="fd3" type="number" step="0.5" min="0"></div>
      <div class="predCell"><label>+4 days</label><input id="fd4" type="number" step="0.5" min="0"></div>
      <div class="predCell"><label>+5 days</label><input id="fd5" type="number" step="0.5" min="0"></div>
      <div class="predCell"><label>+6 days</label><input id="fd6" type="number" step="0.5" min="0"></div>
    </div>

    <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-top:10px;">
      <button class="btnS" type="button" id="fillPredFromCalPast">Fill last 7 from calendar</button>
      <button class="btnS" type="button" id="fillPredFromCalFuture">Fill next 7 from calendar</button>
      <button class="btnS" type="button" id="clearPredInputs">Clear inputs</button>
      <button class="btnS" type="button" id="runPrediction">Estimate INR</button>
    </div>

    <div id="predCalcLine" class="small" style="margin-top:10px;"></div>
    <div id="predOut" style="margin-top:6px;"></div>
  </div>

  <!-- Bridging -->
  <h2>Bridging – Parenteral Helper (enoxaparin / fondaparinux) (beta)</h2>
  <fieldset><legend>Weight-based parenteral dose</legend>
    <div class="grid">
      <div>
        <label for="enoxWeight">Weight (kg)</label>
        <input id="enoxWeight" type="number" step="0.1" min="20" inputmode="decimal" placeholder="e.g., 78.5">
        <div class="small">Use actual body weight unless local protocol says otherwise.</div>
      </div>

      <div>
        <label for="enoxType">Regimen</label>
        <select id="enoxType">
          <option value="tx_q12" selected>Enoxaparin – Therapeutic 1 mg/kg every 12 hours</option>
          <option value="tx_q24">Enoxaparin – Therapeutic (renal adjustment) – 1 mg/kg once daily</option>
          <option value="px_40">Enoxaparin – Prophylaxis – 40 mg once daily</option>
          <option value="px_30">Enoxaparin – Prophylaxis (renal adjustment) – 30 mg once daily</option>
          <option value="fond_tx">Fondaparinux – Treatment (5 mg if &lt;50 kg, 7.5 mg if 50–100 kg, 10 mg if &gt;100 kg)</option>
          <option value="fond_px">Fondaparinux – Prophylaxis – 2.5 mg once daily</option>
        </select>
        <div class="small">Always confirm with local protocol, especially in renal impairment or HIT.</div>
      </div>
    </div>

    <div style="margin-top:10px;">
      <button class="btnS" type="button" id="calcEnox">Calculate bridging dose</button>
      <button class="btnS" type="button" id="clearEnox" style="margin-left:8px;">Bridging not required</button>
    </div>

    <div id="enoxOut" class="small" style="margin-top:8px;"></div>
  </fieldset>

  <!-- Interactions -->
  <h2>Warfarin Drug Interaction Check (beta)</h2>
  <fieldset><legend>Medication review</legend>
    <div class="small" style="margin-bottom:8px;">
      Type or paste meds (comma-separated). This is a high-yield screen, not a comprehensive database. Confirm clinically.
    </div>

    <div style="display:flex;flex-wrap:wrap;gap:10px;align-items:flex-start;">
      <div style="flex:1;min-width:260px;">
        <label for="medList"><b>Current medications</b></label>
        <textarea id="medList" rows="3" placeholder="e.g., Bactrim, Metronidazole, Ibuprofen"></textarea>
      </div>
      <div style="min-width:240px;">
        <div style="margin-top:22px;">
          <button class="btnS" type="button" id="checkInteractions">Check interactions</button>
          <button class="btnS" type="button" id="clearInteractions" style="margin-left:6px;">Clear</button>
        </div>
        <div style="margin-top:10px;">
          <label style="display:flex;gap:8px;align-items:center;">
            <input id="autoAdjustRepeat" type="checkbox">
            <span class="small">Auto-move repeat INR earlier (optional)</span>
          </label>
          <div class="small" style="margin-top:4px;color:#666;">
            OFF by default. If enabled, major interactions may set repeat INR to 2–3 days.
          </div>
        </div>
      </div>
    </div>

    <div id="interactionResults" class="card small" style="margin-top:10px;display:none;"></div>
  </fieldset>

  <!-- iOS/WebView helpers -->
  <iframe id="printFrame" style="display:none;"></iframe>

  <!-- Patient Handout Modal (avoids window.open in iOS WKWebView) -->
  <div id="handoutModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:9999;">
    <div style="position:absolute; inset:16px; background:#fff; border-radius:12px; overflow:hidden; display:flex; flex-direction:column;">
      <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 12px; border-bottom:1px solid #eee;">
        <b>Patient Handout Preview</b>
        <div style="display:flex; gap:8px; align-items:center;">
          <button class="btnS" type="button" id="handoutPrintBtn">Print / Save PDF</button>
          <button class="btnS" type="button" id="handoutCloseBtn">Close</button>
        </div>
      </div>
      <iframe id="handoutFrame" style="border:0; width:100%; height:100%;"></iframe>
    </div>
  </div>

<script>
/* ===========================
   Version tagging
   =========================== */
const APP_VERSION = "7.5";
function versionStampText(){
  return `ThromboLogic INR v${APP_VERSION}`;
}

/* ===========================
   iOS / WebView printing helpers
   =========================== */
function printHtmlDocument(html){
  const frame = document.getElementById('printFrame');
  if(!frame || !frame.contentWindow) { alert('Print frame not available.'); return; }
  const doc = frame.contentWindow.document;
  doc.open();
  doc.write(html);
  doc.close();
  frame.contentWindow.focus();
  frame.contentWindow.print();
}

function openHandoutModal(html){
  const modal = document.getElementById('handoutModal');
  const frame = document.getElementById('handoutFrame');
  if(!modal || !frame) { alert('Handout preview not available.'); return; }

  modal.style.display = 'block';

  try{ frame.srcdoc = html; }
  catch(e){
    const d = frame.contentWindow.document;
    d.open(); d.write(html); d.close();
  }

  const closeBtn = document.getElementById('handoutCloseBtn');
  const printBtn = document.getElementById('handoutPrintBtn');
  if(closeBtn){ closeBtn.onclick = ()=>{ modal.style.display='none'; }; }
  if(printBtn){ printBtn.onclick = ()=>{ printHtmlDocument(html); }; }

  modal.onclick = (ev)=>{ if(ev.target === modal) modal.style.display='none'; };
}

/* ===========================
   Local storage persistence
   =========================== */
const STORAGE_KEY = "thrombologic_state_v7_5";

function mapToObj(m){
  const o = {};
  m.forEach((v,k)=>{ o[k]=v; });
  return o;
}
function objToMap(o){
  const m = new Map();
  if(!o || typeof o !== 'object') return m;
  for(const k of Object.keys(o)){
    const v = o[k];
    if(typeof v === 'number' && !isNaN(v)) m.set(k, v);
  }
  return m;
}

function collectState(){
  const goalEl = document.getElementById('goal');
  const gL = document.getElementById('gL');
  const gH = document.getElementById('gH');

  const targetPanel = document.getElementById('targetPanel');
  const targetInrEl = document.getElementById('targetInr');

  const useProg = document.getElementById('useProgressiveInterval');

  const medList = document.getElementById('medList');
  const autoAdj = document.getElementById('autoAdjustRepeat');

  const enoxWeight = document.getElementById('enoxWeight');
  const enoxType = document.getElementById('enoxType');

  const state = {
    appVersion: APP_VERSION,
    savedAt: Date.now(),

    patient: {
      name:  (document.getElementById('patientName')?.value || ''),
      dob:   (document.getElementById('patientDob')?.value || ''),
      mrn:   (document.getElementById('patientMrn')?.value || ''),
      phone: (document.getElementById('patientPhone')?.value || '')
    },

    goal: {
      preset: goalEl ? goalEl.value : '2-3',
      gL: gL ? gL.value : '',
      gH: gH ? gH.value : ''
    },

    target: {
      enabled: targetPanel ? (targetPanel.style.display !== 'none') : false,
      value: targetInrEl ? targetInrEl.value : ''
    },

    flags: {
      progressiveInterval: useProg ? !!useProg.checked : true,
      autoAdjustRepeat: autoAdj ? !!autoAdj.checked : false
    },

    meds: {
      list: medList ? medList.value : ''
    },

    bridging: {
      weight: enoxWeight ? enoxWeight.value : '',
      regimen: enoxType ? enoxType.value : 'tx_q12'
    },

    baseline: [0,1,2,3,4,5,6].map(i => document.getElementById('b'+i)?.value || ''),

    calendar: {
      planned: mapToObj(planned),
      actual: mapToObj(actual),
      inrVal: mapToObj(inrVal),
      repeatKey: repeatKey || null
    }
  };

  return state;
}

function saveState(){
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(collectState())); }catch(e){}
}

function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return;

    let s;
    try{ s = JSON.parse(raw); }
    catch(e){ localStorage.removeItem(STORAGE_KEY); return; }

    if(s.patient){
      const n=document.getElementById('patientName'); if(n) n.value = s.patient.name || '';
      const d=document.getElementById('patientDob');  if(d) d.value = s.patient.dob  || '';
      const m=document.getElementById('patientMrn');  if(m) m.value = s.patient.mrn  || '';
      const p=document.getElementById('patientPhone');if(p) p.value = s.patient.phone || '';
    }

    if(s.goal){
      const goalEl=document.getElementById('goal');
      if(goalEl && s.goal.preset) goalEl.value = s.goal.preset;

      const cust=document.getElementById('cust');
      if(cust) cust.style.display = (goalEl && goalEl.value==='custom') ? 'block' : 'none';

      const gL=document.getElementById('gL'); if(gL) gL.value = s.goal.gL || '';
      const gH=document.getElementById('gH'); if(gH) gH.value = s.goal.gH || '';
    }

    if(s.target){
      const panel=document.getElementById('targetPanel');
      const t=document.getElementById('targetInr');
      if(panel) panel.style.display = s.target.enabled ? 'block' : 'none';
      if(t) t.value = s.target.value || '';
    }

    if(s.flags){
      const useProg=document.getElementById('useProgressiveInterval');
      if(useProg) useProg.checked = (s.flags.progressiveInterval !== false);

      const autoAdj=document.getElementById('autoAdjustRepeat');
      if(autoAdj) autoAdj.checked = !!s.flags.autoAdjustRepeat;
    }

    if(s.meds){
      const medList=document.getElementById('medList');
      if(medList) medList.value = s.meds.list || '';
    }

    if(s.bridging){
      const w=document.getElementById('enoxWeight'); if(w) w.value = s.bridging.weight || '';
      const t=document.getElementById('enoxType');   if(t) t.value = s.bridging.regimen || 'tx_q12';
    }

    if(Array.isArray(s.baseline)){
      for(let i=0;i<7;i++){
        const el = document.getElementById('b'+i);
        if(el) el.value = (s.baseline[i] ?? '');
      }
    }

    if(s.calendar){
      planned.clear(); actual.clear(); inrVal.clear();
      objToMap(s.calendar.planned).forEach((v,k)=> planned.set(k,v));
      objToMap(s.calendar.actual).forEach((v,k)=> actual.set(k,v));
      objToMap(s.calendar.inrVal).forEach((v,k)=> inrVal.set(k,v));
      repeatKey = s.calendar.repeatKey || null;
    }
  }catch(e){}
}

/* ===========================
   Multi-patient Profiles (local)
   =========================== */
const PROFILES_KEY = "thrombologic_profiles_v1";
const ACTIVE_PROFILE_KEY = "thrombologic_active_profile_v1";
let activeProfileId = null;
let isDirty = false;

function safeUUID(){
  try{ return crypto.randomUUID(); }catch(e){
    return 'p_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,8);
  }
}
function digitsOnlyPhone(s){ return (s||"").toString().replace(/\D/g,''); }
function normText(s){ return (s||"").toString().toLowerCase().trim(); }

function getProfiles(){
  try{
    const raw = localStorage.getItem(PROFILES_KEY);
    if(!raw) return {};
    const obj = JSON.parse(raw);
    return (obj && typeof obj === 'object') ? obj : {};
  }catch(e){ return {}; }
}
function setProfiles(obj){
  try{ localStorage.setItem(PROFILES_KEY, JSON.stringify(obj||{})); }catch(e){}
}

function profileDisplayName(meta){
  const name = (meta?.name||'').trim();
  const mrn  = (meta?.mrn||'').trim();
  if(name && mrn) return `${name} (MRN ${mrn})`;
  if(name) return name;
  if(mrn) return `MRN ${mrn}`;
  return 'Unnamed patient';
}

function updateCurrentLine(){
  const label = document.getElementById('currentPatientLabel');
  const badge = document.getElementById('unsavedBadge');
  if(label){
    if(activeProfileId){
      const profiles = getProfiles();
      const p = profiles[activeProfileId];
      const disp = p ? profileDisplayName(p.meta) : 'Unknown';
      label.innerHTML = `Currently loaded: <b>${disp}</b>`;
    }else{
      label.innerHTML = `Currently loaded: <b>None</b>`;
    }
  }
  if(badge){ badge.style.display = isDirty ? 'inline-flex' : 'none'; }
}

function markDirty(){ isDirty = true; updateCurrentLine(); }
function clearDirty(){ isDirty = false; updateCurrentLine(); }

function guardUnsaved(nextActionFn){
  if(!isDirty){ nextActionFn(); return; }
  const okSave = confirm("Unsaved changes detected.\n\nPress OK to SAVE before continuing.\nPress Cancel to discard changes and continue.");
  if(okSave){ saveActiveProfile(); nextActionFn(); }
  else{ clearDirty(); nextActionFn(); }
}

function renderProfileList(filterText=''){
  const list = document.getElementById('profileList');
  if(!list) return;

  const q = normText(filterText);
  const qPhone = digitsOnlyPhone(filterText);

  const profiles = getProfiles();
  const items = Object.entries(profiles).map(([id, p])=>{
    const meta = p?.meta || {};
    return {
      id,
      meta,
      nameN: normText(meta.name),
      mrnN: normText(meta.mrn),
      phoneD: digitsOnlyPhone(meta.phone),
      lastUsed: meta.lastUsed || 0,
      updatedAt: meta.updatedAt || 0
    };
  });

  let filtered = items;
  if(q || qPhone){
    const terms = q.split(/\s+/).filter(Boolean);
    filtered = items.filter(it=>{
      const hay = `${it.nameN} ${it.mrnN} ${it.phoneD}`;
      return terms.every(t=>{
        const tDigits = digitsOnlyPhone(t);
        if(tDigits && it.phoneD.includes(tDigits)) return true;
        return hay.includes(t);
      });
    });
  }

  filtered.sort((a,b)=> (b.lastUsed - a.lastUsed) || (b.updatedAt - a.updatedAt));

  list.innerHTML = '';
  list.style.display = 'block';

  if(filtered.length === 0){
    list.innerHTML = `<div class="profileRow" style="cursor:default;background:#fafafa;">
      <div class="small">No matches.</div>
    </div>`;
    return;
  }

  for(const it of filtered){
    const disp = profileDisplayName(it.meta);
    const mrn = (it.meta.mrn||'').trim();
    const phone = (it.meta.phone||'').trim();
    const updated = it.updatedAt ? new Date(it.updatedAt).toLocaleDateString() : '—';

    const row = document.createElement('div');
    row.className = 'profileRow' + (it.id === activeProfileId ? ' active' : '');
    row.innerHTML = `
      <b>${disp}</b>
      <div class="profileMeta">
        <span>MRN: ${mrn || '—'}</span>
        <span>Phone: ${phone || '—'}</span>
        <span>Updated: ${updated}</span>
      </div>
    `;
    row.addEventListener('click', ()=>{ guardUnsaved(()=> loadProfileById(it.id)); });
    list.appendChild(row);
  }
}

function applyStateObject(s){
  if(s.patient){
    const n=document.getElementById('patientName'); if(n) n.value = s.patient.name || '';
    const d=document.getElementById('patientDob');  if(d) d.value = s.patient.dob  || '';
    const m=document.getElementById('patientMrn');  if(m) m.value = s.patient.mrn  || '';
    const p=document.getElementById('patientPhone');if(p) p.value = s.patient.phone || '';
  }

  if(s.goal){
    const goalEl=document.getElementById('goal');
    if(goalEl && s.goal.preset) goalEl.value = s.goal.preset;
    const cust=document.getElementById('cust');
    if(cust) cust.style.display = (goalEl && goalEl.value==='custom') ? 'block' : 'none';
    const gL=document.getElementById('gL'); if(gL) gL.value = s.goal.gL || '';
    const gH=document.getElementById('gH'); if(gH) gH.value = s.goal.gH || '';
  }

  if(s.target){
    const panel=document.getElementById('targetPanel');
    const t=document.getElementById('targetInr');
    if(panel) panel.style.display = s.target.enabled ? 'block' : 'none';
    if(t) t.value = s.target.value || '';
  }

  if(s.flags){
    const useProg=document.getElementById('useProgressiveInterval');
    if(useProg) useProg.checked = (s.flags.progressiveInterval !== false);
    const autoAdj=document.getElementById('autoAdjustRepeat');
    if(autoAdj) autoAdj.checked = !!s.flags.autoAdjustRepeat;
  }

  if(s.meds){
    const medList=document.getElementById('medList');
    if(medList) medList.value = s.meds.list || '';
  }

  if(s.bridging){
    const w=document.getElementById('enoxWeight'); if(w) w.value = s.bridging.weight || '';
    const t=document.getElementById('enoxType');   if(t) t.value = s.bridging.regimen || 'tx_q12';
  }

  if(Array.isArray(s.baseline)){
    for(let i=0;i<7;i++){
      const el = document.getElementById('b'+i);
      if(el) el.value = (s.baseline[i] ?? '');
    }
  }

  if(s.calendar){
    planned.clear(); actual.clear(); inrVal.clear();
    objToMap(s.calendar.planned).forEach((v,k)=> planned.set(k,v));
    objToMap(s.calendar.actual).forEach((v,k)=> actual.set(k,v));
    objToMap(s.calendar.inrVal).forEach((v,k)=> inrVal.set(k,v));
    repeatKey = s.calendar.repeatKey || null;
  }

  try{ updSum(); pushDataToCells(); lin7(); }catch(e){}
}

function loadProfileById(id){
  const profiles = getProfiles();
  const p = profiles[id];
  if(!p || !p.state){ alert("Profile not found."); return; }

  activeProfileId = id;
  localStorage.setItem(ACTIVE_PROFILE_KEY, id);

  p.meta = p.meta || {};
  p.meta.lastUsed = Date.now();
  profiles[id] = p;
  setProfiles(profiles);

  applyStateObject(p.state);
  clearDirty();
  renderProfileList(document.getElementById('profileSearch')?.value || '');
  updateCurrentLine();
}

function saveActiveProfile(){
  if(!activeProfileId){ saveAsNewProfile(); return; }
  const profiles = getProfiles();
  const existing = profiles[activeProfileId] || {meta:{}, state:{}};

  const name = (document.getElementById('patientName')?.value || '').trim();
  const mrn  = (document.getElementById('patientMrn')?.value || '').trim();
  const phone= (document.getElementById('patientPhone')?.value || '').trim();

  existing.meta = existing.meta || {};
  existing.meta.name = name;
  existing.meta.mrn = mrn;
  existing.meta.phone = phone;
  existing.meta.updatedAt = Date.now();
  existing.meta.lastUsed  = Date.now();

  existing.state = collectState();

  profiles[activeProfileId] = existing;
  setProfiles(profiles);

  clearDirty();
  renderProfileList(document.getElementById('profileSearch')?.value || '');
  updateCurrentLine();
}

function saveAsNewProfile(){
  const name = (document.getElementById('patientName')?.value || '').trim();
  const mrn  = (document.getElementById('patientMrn')?.value || '').trim();
  const phone= (document.getElementById('patientPhone')?.value || '').trim();

  const defaultLabel = profileDisplayName({name, mrn});
  const label = prompt("Save as new patient profile.\n\nEnter a label (you can include Name and/or MRN):", defaultLabel);
  if(label === null) return;

  const id = safeUUID();
  const profiles = getProfiles();

  profiles[id] = {
    meta: {
      label: (label||'').trim(),
      name, mrn, phone,
      createdAt: Date.now(),
      updatedAt: Date.now(),
      lastUsed: Date.now()
    },
    state: collectState()
  };

  setProfiles(profiles);
  activeProfileId = id;
  localStorage.setItem(ACTIVE_PROFILE_KEY, id);

  clearDirty();
  renderProfileList(document.getElementById('profileSearch')?.value || '');
  updateCurrentLine();
}

function deleteActiveProfile(){
  if(!activeProfileId){ alert("No patient profile selected."); return; }
  const profiles = getProfiles();
  const p = profiles[activeProfileId];
  const disp = p ? (p.meta?.label || profileDisplayName(p.meta)) : 'this patient';
  const ok = confirm(`Delete ${disp}?\n\nThis cannot be undone.`);
  if(!ok) return;

  delete profiles[activeProfileId];
  setProfiles(profiles);

  activeProfileId = null;
  localStorage.removeItem(ACTIVE_PROFILE_KEY);

  resetToBlankPatient();
  clearDirty();
  renderProfileList(document.getElementById('profileSearch')?.value || '');
  updateCurrentLine();
}

function resetToBlankPatient(){
  const ids = ['patientName','patientDob','patientMrn','patientPhone','inr','medList','enoxWeight'];
  ids.forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.value = '';
  });
  const enoxType = document.getElementById('enoxType');
  if(enoxType) enoxType.value = 'tx_q12';

  for(let i=0;i<7;i++){
    const el = document.getElementById('b'+i);
    if(el) el.value = '';
  }

  planned.clear(); actual.clear(); inrVal.clear(); repeatKey=null;
  hasReco=false; pendingRecalc=false; lastRecoINR=null; lastRepeatIso=null;
  currentInteractionHits=[];

  if(rec) rec.innerHTML = '';
  const results = document.getElementById('interactionResults');
  if(results){ results.style.display='none'; results.innerHTML=''; }

  try{ updSum(); pushDataToCells(); lin7(); }catch(e){}
}

/* ===========================
   Helpers
   =========================== */
function pad(n){return (n<10?'0':'')+n}
function isoLocal(d){return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate())}
function parseIsoLocal(isoStr){
  if(!isoStr) return null;
  const p = isoStr.split('-');
  if(p.length!==3) return null;
  const y = parseInt(p[0],10), m=parseInt(p[1],10), d=parseInt(p[2],10);
  if([y,m,d].some(x=>isNaN(x))) return null;
  return new Date(y, m-1, d);
}
function startOfWeekLocal(d){
  const x=new Date(d.getFullYear(),d.getMonth(),d.getDate());
  const dow=x.getDay(); x.setHours(0,0,0,0); x.setDate(x.getDate()-dow); return x
}
function addDaysLocal(d,days){const x=new Date(d.getFullYear(),d.getMonth(),d.getDate()); x.setDate(x.getDate()+days); return x}
function daysBetween(a,b){
  const d1=new Date(a.getFullYear(),a.getMonth(),a.getDate());
  const d2=new Date(b.getFullYear(),b.getMonth(),b.getDate());
  return Math.round((d2-d1)/86400000)
}
function r01(x){return Math.round(x*10)/10}
function r05(x){return Math.round(x*2)/2}
function r025(x){return Math.round(x*4)/4}
function stripZeros(s){return s.replace(/(\.\d*?[1-9])0+$/,'$1').replace(/\.0+$/,'')}
function formatDose(x){
  if(x==null || isNaN(x)) return '—';
  return stripZeros((Math.round(x*100)/100).toFixed(2));
}
function formatDoseWithUnit(x){
  if(x==null || isNaN(x)) return '—';
  return formatDose(x)+' mg';
}
function niceDate(isoStr){
  if(!isoStr) return '';
  const parts = isoStr.split('-');
  if(parts.length!==3) return isoStr;
  const y = parseInt(parts[0],10);
  const m = parseInt(parts[1],10);
  const d = parseInt(parts[2],10);
  if(isNaN(m)||isNaN(d)||isNaN(y)) return isoStr;
  return pad(m)+'/'+pad(d)+'/'+y;
}
function applyRecoPlan(todayIso, todayDose, repeatIso){
  // Always apply today's planned dose
  if(todayDose != null && !isNaN(todayDose)){
    planned.set(todayIso, r025(todayDose));
  }

  // Mark repeat INR day
  repeatKey = repeatIso || null;

  // Fill days from today → repeat INR using scheduled regimen
  if(repeatIso){
    const t0 = new Date(todayIso);
    const tR = new Date(repeatIso);
    const days = Math.max(0, daysBetween(t0, tR));

    for(let i = 1; i <= days; i++){
      const k = isoLocal(addDaysLocal(t0, i));
      if(!planned.has(k)){
        planned.set(k, r025(schedAtIso(k)));
      }
    }
  }

  pushDataToCells();
  lin7();
  saveState();
}
function getBridgingHTML(){
  const el = document.getElementById('enoxOut');
  if(!el) return '';
  const html = el.innerHTML?.trim();
  if(!html) return '';
  if(/not required/i.test(html)) return '';
  return `
    <div class="betaBlock" style="margin-top:10px;">
      <b>Bridging recommendation:</b>
      <div class="small">${html}</div>
    </div>
  `;
}
function getBridgingBlockHTML(){
  const el = document.getElementById('enoxOut');
  if(!el) return '';
  const html = (el.innerHTML || '').trim();
  if(!html) return '';
  // ignore “not required” / empty prompt states
  if(/bridging not required/i.test(html)) return '';
  if(/enter a valid weight/i.test(html)) return '';
  if(/select a valid regimen/i.test(html)) return '';
  return `
    <div class="bridgeBlock" style="margin-top:10px;padding:10px;border-radius:10px;border:1px solid #e6e6e6;background:#fff;">
      <div style="font-weight:700;margin-bottom:6px;">Bridging recommendation</div>
      <div class="small">${html}</div>
    </div>
  `;
}

const weeksEl = document.getElementById('weeks');
const calwrap = document.getElementById('calwrap');
const rangeLabel=document.getElementById('rangeLabel');
const rec = document.getElementById('rec');
const linEl = document.getElementById('lin');
const sum = document.getElementById('sum');
const err = document.getElementById('err');
const dbg = document.getElementById('dbg');

const planned=new Map(), actual=new Map(), inrVal=new Map();
let repeatKey=null; let hasReco=false, pendingRecalc=false;
let lastRecoINR = null; let lastRepeatIso = null;

/* ===========================
   APPLY RECOMMENDATION TO CALENDAR (FIX)
   =========================== */
function applyPlanToCalendar(todayIso, newDose, repeatIso){
  // Write today’s planned dose if provided (but do not clobber a manual planned dose unless caller intends it)
  if(newDose != null && !isNaN(newDose)){
    planned.set(todayIso, r025(newDose));
  }else{
    // If dose not provided and nothing planned today, keep scheduled as visible plan (optional)
    if(!planned.has(todayIso)){
      planned.set(todayIso, r025(schedAtIso(todayIso)));
    }
  }

  if(repeatIso){
    repeatKey = repeatIso;
  }

  // Fill planned doses from today through repeat date so the plan is visible,
  // BUT do not overwrite any existing planned edits.
  if(repeatIso){
    const t0 = parseIsoLocal(todayIso);
    const tR = parseIsoLocal(repeatIso);
    if(t0 && tR){
      const spanDays = Math.max(0, daysBetween(t0, tR));
      for(let i=0; i<=spanDays; i++){
        const key = isoLocal(addDaysLocal(t0, i));
        if(!planned.has(key)){
          planned.set(key, r025(schedAtIso(key)));
        }
      }
    }
  }

  pushDataToCells();
  lin7();
  saveState();
}

/* ===========================
   INTERACTION DATABASE
   =========================== */
const WARFARIN_INTERACTIONS = [
  { drug:"trimethoprim-sulfamethoxazole", aka:["bactrim","septra","tmp-smx"], level:"major", effect:"↑ INR", suggestDays:3 },
  { drug:"metronidazole", aka:["flagyl"], level:"major", effect:"↑ INR", suggestDays:3 },
  { drug:"fluconazole", aka:["diflucan"], level:"major", effect:"↑ INR", suggestDays:3 },
  { drug:"amiodarone", aka:[], level:"major", effect:"↑ INR", suggestDays:3 },
  { drug:"rifampin", aka:[], level:"major", effect:"↓ INR", suggestDays:3 },
  { drug:"phenytoin", aka:["dilantin"], level:"moderate", effect:"↑/↓ INR", suggestDays:7 },
  { drug:"carbamazepine", aka:["tegretol"], level:"moderate", effect:"↓ INR", suggestDays:7 },
  { drug:"sertraline", aka:["zoloft","ssri"], level:"bleeding", effect:"Bleeding risk", suggestDays:null },
  { drug:"citalopram", aka:["celexa","ssri"], level:"bleeding", effect:"Bleeding risk", suggestDays:null },
  { drug:"fluoxetine", aka:["prozac"], level:"bleeding", effect:"Bleeding risk", suggestDays:null },
  { drug:"ibuprofen", aka:["nsaid","motrin","advil"], level:"bleeding", effect:"Bleeding risk", suggestDays:null },
  { drug:"naproxen", aka:["aleve","nsaid"], level:"bleeding", effect:"Bleeding risk", suggestDays:null },
  { drug:"aspirin", aka:["asa"], level:"bleeding", effect:"Bleeding risk", suggestDays:null }
];

let currentInteractionHits = [];

function normalizeMedText(s){
  return (s||"").toLowerCase().replace(/[\n\r]/g,' ').replace(/\s+/g,' ').trim();
}
function matchInteractions(medText){
  const t = normalizeMedText(medText);
  if(!t) return [];
  const hits=[];
  for(const item of WARFARIN_INTERACTIONS){
    const names=[item.drug, ...(item.aka||[])].filter(Boolean);
    const found = names.some(n=> t.includes(n.toLowerCase()));
    if(found) hits.push(item);
  }
  const seen=new Set();
  return hits.filter(h=>{ const k=h.drug.toLowerCase(); if(seen.has(k)) return false; seen.add(k); return true; });
}
function interactionSummary(hits){
  if(!hits || hits.length===0) return null;

  const major = hits.filter(h=>h.level==="major");
  const mod   = hits.filter(h=>h.level==="moderate");
  const bleed = hits.filter(h=>h.level==="bleeding");

  const suggestedDays = [];
  for(const h of hits){
    if(typeof h.suggestDays === "number" && !isNaN(h.suggestDays)) suggestedDays.push(h.suggestDays);
  }
  const minDays = suggestedDays.length ? Math.min(...suggestedDays) : null;

  return { majorCount: major.length, moderateCount: mod.length, bleedCount: bleed.length, minSuggestedDays: minDays, major, mod, bleed };
}
function buildInteractionHTML(hits){
  const sum = interactionSummary(hits);
  if(!sum) return '';

  const badges=[];
  if(sum.majorCount) badges.push(`<span class="badge major">MAJOR × ${sum.majorCount}</span>`);
  if(sum.moderateCount) badges.push(`<span class="badge moderate">MODERATE × ${sum.moderateCount}</span>`);
  if(sum.bleedCount) badges.push(`<span class="badge bleeding">BLEED RISK × ${sum.bleedCount}</span>`);

  let timingLine='';
  if(sum.minSuggestedDays!=null){
    timingLine = `<div class="kv"><div><b>Suggested INR recheck:</b> ${sum.minSuggestedDays} day(s) (interaction-aware)</div></div>`;
  }else{
    timingLine = `<div class="kv"><div><b>Suggested INR recheck:</b> per clinic discretion</div></div>`;
  }

  const list = hits.map(h=>{
    const level = h.level.toUpperCase();
    return `<li><b>${h.drug}</b> — <span>${h.effect}</span> <span class="small">(${level})</span></li>`;
  }).join('');

  const bleedCounsel = sum.bleedCount ? `
    <div style="margin-top:8px;">
      <b>Bleeding risk counseling:</b> avoid additional NSAIDs/aspirin unless directed; watch for unusual bruising, bleeding gums, dark stools, or severe headache—seek care if concerning.
    </div>` : '';

  return `
    <div class="interactionBlock betaBlock" style="margin-top:10px;padding:10px;border-radius:10px;border:1px solid #e6e6e6;background:#fff;">
      <div><b>Warfarin interaction screen (beta):</b></div>
      <div class="badges">${badges.join(' ')}</div>
      ${timingLine}
      <div style="margin-top:8px;"><ul style="margin:6px 0 0 18px;padding:0;">${list}</ul></div>
      <div class="small" style="margin-top:6px;color:#666;">Not comprehensive; confirm with clinical judgment and local protocol.</div>
      ${bleedCounsel}
    </div>
  `;
}

/* ===========================
   Tablet-strength constraint (NEW)
   - Whole + half tablets only (NO quarters)
   - Applies to TODAY’s planned dose only
   =========================== */

function getSelectedTabletStrengths(){
  const panel = document.getElementById('tabletPills');
  if(!panel) return [];
  const checks = Array.from(panel.querySelectorAll('input[type="checkbox"][data-strength]'));
  const strengths = checks
    .filter(c=>c.checked)
    .map(c=>parseFloat(c.getAttribute('data-strength')))
    .filter(x=>!isNaN(x) && x>0);

  const seen=new Set();
  const out=[];
  strengths.sort((a,b)=>a-b).forEach(s=>{ const k=s.toString(); if(seen.has(k)) return; seen.add(k); out.push(s); });
  return out;
}

function quarterUnitsFromMg(mg){ return Math.round(mg*4); }
function mgFromQuarterUnits(q){ return q/4; }

function buildFeasibleDoseOptions(strengths){
  const items=[];
  for(const s of strengths){
    const fullQ = quarterUnitsFromMg(s);
    const halfQ = quarterUnitsFromMg(s/2);
    if(fullQ>0) items.push({strength:s, tab:1.0, q:fullQ});
    if(halfQ>0) items.push({strength:s, tab:0.5, q:halfQ});
  }
  items.sort((a,b)=> b.q - a.q);
  return items;
}

function comboToText(combo){
  const entries = Array.from(combo.values()).sort((a,b)=> b.strength - a.strength);
  const parts=[];
  for(const e of entries){
    if(e.full>0){ parts.push(`${e.full} × ${stripZeros(e.strength.toFixed(2))} mg`); }
    if(e.half>0){ parts.push(`${e.half} ½ × ${stripZeros(e.strength.toFixed(2))} mg`); }
  }
  return parts.join(' + ');
}

function scoreCombo(combo){
  let tabs=0, halves=0;
  for(const v of combo.values()){
    tabs += v.full + v.half*0.5;
    halves += v.half;
  }
  return {tabs, halves};
}

function cloneCombo(combo){
  const m=new Map();
  for(const [k,v] of combo.entries()){
    m.set(k, {strength:v.strength, full:v.full, half:v.half});
  }
  return m;
}

function addItemToCombo(combo, item){
  const key = item.strength.toString();
  if(!combo.has(key)) combo.set(key, {strength:item.strength, full:0, half:0});
  const e = combo.get(key);
  if(item.tab===1.0) e.full += 1;
  else e.half += 1;
}

function findBestFeasibleDose(targetMg, strengths, tolAbs=0.5, tolPct=0.10){
  if(targetMg==null || isNaN(targetMg) || targetMg<=0){
    return {ok:false, reason:'Target dose is invalid.'};
  }
  if(!strengths || strengths.length===0){
    return {ok:false, reason:'No tablet strengths selected.'};
  }

  const items = buildFeasibleDoseOptions(strengths);
  const MAX_HALF_STEPS = 16;
  const dp = Array.from({length: MAX_HALF_STEPS+1}, ()=> new Map());
  dp[0].set(0, new Map());

  for(let steps=0; steps<MAX_HALF_STEPS; steps++){
    for(const [sumQ, combo] of dp[steps].entries()){
      for(const it of items){
        const stepCost = (it.tab===1.0) ? 2 : 1;
        const nextSteps = steps + stepCost;
        if(nextSteps > MAX_HALF_STEPS) continue;

        const nextSumQ = sumQ + it.q;
        const capMg = Math.max(targetMg*1.5, targetMg+10);
        if(mgFromQuarterUnits(nextSumQ) > capMg) continue;

        const nextCombo = cloneCombo(combo);
        addItemToCombo(nextCombo, it);

        const existing = dp[nextSteps].get(nextSumQ);
        if(!existing){
          dp[nextSteps].set(nextSumQ, nextCombo);
        }else{
          const s1 = scoreCombo(existing);
          const s2 = scoreCombo(nextCombo);
          if(s2.halves < s1.halves || (s2.halves===s1.halves && s2.tabs < s1.tabs)){
            dp[nextSteps].set(nextSumQ, nextCombo);
          }
        }
      }
    }
  }

  const allowedDiff = Math.max(tolAbs, Math.abs(targetMg)*tolPct);

  let best = null;
  let closest = null;

  for(let steps=1; steps<=MAX_HALF_STEPS; steps++){
    for(const [sumQ, combo] of dp[steps].entries()){
      if(sumQ===0) continue;
      const doseMg = mgFromQuarterUnits(sumQ);
      const diff = doseMg - targetMg;
      const absDiff = Math.abs(diff);
      const comboText = comboToText(combo);
      const sc = scoreCombo(combo);

      const candClose = {dose:doseMg, diff, absDiff, comboText, tabs:sc.tabs, halves:sc.halves};
      if(!closest ||
         candClose.absDiff < closest.absDiff ||
         (candClose.absDiff === closest.absDiff && (candClose.halves < closest.halves)) ||
         (candClose.absDiff === closest.absDiff && candClose.halves === closest.halves && candClose.tabs < closest.tabs)
      ){
        closest = candClose;
      }

      if(absDiff <= allowedDiff){
        const cand = {dose:doseMg, diff, absDiff, comboText, tabs:sc.tabs, halves:sc.halves};
        if(!best ||
           cand.absDiff < best.absDiff ||
           (cand.absDiff === best.absDiff && cand.halves < best.halves) ||
           (cand.absDiff === best.absDiff && cand.halves === best.halves && cand.tabs < best.tabs)
        ){
          best = cand;
        }
      }
    }
  }

  if(best){
    return { ok:true, dose:r025(best.dose), diff:r025(best.diff), comboText:best.comboText };
  }

  return {
    ok:false,
    reason:`No whole/half-tablet combination found within tolerance (±${stripZeros(allowedDiff.toFixed(2))} mg).`,
    closest: closest ? { dose:r025(closest.dose), diff:r025(closest.diff), comboText:closest.comboText } : null
  };
}

/* ===========================
   Baseline schedule helpers
   =========================== */
function base(){return [0,1,2,3,4,5,6].map(i=>{const v=parseFloat(document.getElementById('b'+i).value);return isNaN(v)?0:r01(v)})}
function baseSum(){return base().reduce((a,b)=>a+b,0)}
function updSum(){sum.innerHTML='Scheduled weekly total: <b>'+stripZeros(r01(baseSum()).toFixed(1))+' mg</b>'}
function schedAtIso(key){
  const d = parseIsoLocal(key);
  if(!d) return 0;
  const dow=d.getDay();
  return base()[dow]||0
}
function effAtIso(key){if(actual.has(key))return actual.get(key); if(planned.has(key))return planned.get(key); return schedAtIso(key)}
function plannedOrSchedAtIso(key){ if(planned.has(key)) return planned.get(key); return schedAtIso(key); }

const today = new Date();

// Calendar range: 26 weeks before + current + 26 weeks after
const weeksBefore = 26;
const weeksAfter  = 26;
let start = addDaysLocal(startOfWeekLocal(today), -7*weeksBefore);
let totalWeeks = weeksBefore + weeksAfter + 1;

function renderAll(){
  weeksEl.innerHTML='';
  const spanStart = isoLocal(start);
  const spanEnd = isoLocal(addDaysLocal(start, totalWeeks*7-1));
  rangeLabel.textContent = spanStart+' → '+spanEnd+'  ('+totalWeeks+' weeks)';
  for(let w=0; w<totalWeeks; w++){
    const wk = document.createElement('div'); wk.className='week';
    for(let d=0; d<7; d++){
      const date = addDaysLocal(start, w*7+d); const key=isoLocal(date);
      const cell=document.createElement('div'); cell.className='day'; cell.id='c_'+key;
      const isToday = key===isoLocal(today); const isRepeat=(key===repeatKey);
      if(isToday||isRepeat) cell.classList.add('blue');
      cell.innerHTML =
        '<div class="hdr"><b>'+['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][date.getDay()]+'</b> '+
        '<span class="date">'+(date.getMonth()+1).toString().padStart(2,'0')+'/'+date.getDate().toString().padStart(2,'0')+'</span></div>'+
        '<div class="lbl">Planned dose (mg)</div>'+
        '<input class="cell-input" data-k="'+key+'" data-role="planned" type="number" step="0.25" min="0">'+
        '<div class="lbl">INR</div>'+
        '<input class="cell-input inrbox" data-k="'+key+'" data-role="inr" type="number" step="0.1" min="0">'+
        '<div class="lbl">Actual dose</div>'+
        '<input class="cell-input" data-k="'+key+'" data-role="actual" type="number" step="0.25" min="0">'+
        '<div class="lbl repeat-inr"></div>';
      wk.appendChild(cell);
    }
    weeksEl.appendChild(wk);
  }

  pushDataToCells();
  lin7();
  dbg.textContent = 'Calendar rows rendered: ' + document.querySelectorAll('.week').length;
}

function scrollToTodayWeek() {
  const tIso = isoLocal(today);
  const cell = document.getElementById('c_' + tIso);
  if (!cell) return;
  const cellRect = cell.getBoundingClientRect();
  const wrapRect = calwrap.getBoundingClientRect();
  const offsetWithinWrap = (cellRect.top - wrapRect.top) + calwrap.scrollTop;
  calwrap.scrollTop = offsetWithinWrap - (calwrap.clientHeight / 2) + (cellRect.height / 2);
}

function pushDataToCells(){
  const tIso=isoLocal(today);
  for(let w=0; w<totalWeeks; w++){
    for(let d=0; d<7; d++){
      const date = addDaysLocal(start, w*7+d); const key=isoLocal(date);
      const cell=document.getElementById('c_'+key); if(!cell) continue;

      const p=planned.has(key)?planned.get(key):'';
      const a=actual.has(key)?actual.get(key):'';
      const i=inrVal.has(key)?inrVal.get(key).toFixed(1):'';

      const inputs=cell.querySelectorAll('input');
      if(inputs[0]) inputs[0].value = (p!==''? formatDose(p):'');
      if(inputs[1]) inputs[1].value = i;
      if(inputs[2]) inputs[2].value = (a!==''? formatDose(a):'');

      const isToday = key===tIso; const isRepeat=(key===repeatKey);
      cell.className='day';

      const hasManual = (i!=='') || (a!=='');
      const inrNum = parseFloat(i);
      if(!isNaN(inrNum)){
        if(inrNum >= 5.0){ cell.classList.add('redCell'); }
        else if(inrNum >= 4.0){ cell.classList.add('orangeCell'); }
      }
      if(hasManual && !cell.classList.contains('redCell') && !cell.classList.contains('orangeCell')){
        cell.classList.add('manual');
      }
      const repEl = cell.querySelector('.repeat-inr');
      if(repEl){ repEl.innerHTML = isRepeat ? '<b>Repeat INR</b>' : ''; }
      if(isToday||isRepeat){ cell.classList.add('blue'); }
    }
  }
}

function applyVisible(){
  const base7=base();
  const rect = calwrap.getBoundingClientRect();
  const weekNodes = Array.from(weeksEl.querySelectorAll('.week'));
  weekNodes.forEach((wk, wi)=>{
    const r = wk.getBoundingClientRect();
    if(r.bottom < rect.top-200 || r.top > rect.bottom+200) return;
    for(let d=0; d<7; d++){
      const date = addDaysLocal(start, wi*7+d); const key=isoLocal(date);
      planned.set(key, r025(base7[d]));
    }
  });
  pushDataToCells(); lin7(); updSum();
}

function clearVisible(){
  const rect = calwrap.getBoundingClientRect();
  const weekNodes = Array.from(weeksEl.querySelectorAll('.week'));
  weekNodes.forEach((wk, wi)=>{
    const r = wk.getBoundingClientRect();
    if(r.bottom < rect.top-200 || r.top > rect.bottom+200) return;
    for(let d=0; d<7; d++){
      const date = addDaysLocal(start, wi*7+d); const key=isoLocal(date);
      planned.delete(key); actual.delete(key); inrVal.delete(key); if(repeatKey===key) repeatKey=null;
    }
  });
  pushDataToCells(); lin7(); rec.innerHTML='';
}

function clearAll(){
  planned.clear(); actual.clear(); inrVal.clear(); repeatKey=null;
  for(let i=0;i<7;i++) document.getElementById('b'+i).value='';
  updSum(); pushDataToCells(); lin7(); rec.innerHTML='';
}

function lin7(){
  const weekStart = startOfWeekLocal(today);
  const names=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  let parts=[];
  for(let i=0;i<7;i++){
    const d=addDaysLocal(weekStart,i); const key=isoLocal(d);
    let dose = (actual.has(key)? actual.get(key) : (planned.has(key)? planned.get(key) : NaN));
    if(isNaN(dose)) dose = undefined;
    parts.push(names[i]+' '+(dose===undefined? '—' : formatDoseWithUnit(dose)));
  }
  linEl.textContent = parts.join('  |  ');
}

/* ===========================
   Dose adjustment bands
   =========================== */
function pickPct(inr, L, H){
  const withinRange = (inr>=L && inr<=H);
  if(withinRange) return {pct:0, label:'in range', repeat:7};
  const gap = (inr<L) ? (L - inr) : (inr - H);
  if(inr < 1.5)       return {pct:+0.15, label:'+15–20%', repeat:7};
  if(inr < L){
    if(gap <= 3.5)    return {pct:+0.07, label:'+5–10%', repeat:7};
    else              return {pct:+0.10, label:'+10–15%', repeat:7};
  }
  if(inr > 4.5)       return {pct:-0.20, label:'-15–20% (≥4.5 → 20%)', repeat:2};
  if(inr >= 4.0){
    if(gap <= 3.5)    return {pct:-0.08, label:'-5–10%', repeat:7};
    else              return {pct:-0.11, label:'-10–15%', repeat:7};
  }
  if(gap <= 3.5)      return {pct:-0.07, label:'-5–10%', repeat:7};
  else                return {pct:-0.10, label:'-10–15%', repeat:7};
}

function pickPctWithTarget(inr, L, H, target){
  if(target==null || isNaN(target)) return pickPct(inr, L, H);
  if(inr < L || inr > H) return pickPct(inr, L, H);
  if(target < L || target > H) return {pct:0, label:'in range (target outside goal)', repeat:7};
  const diff = inr - target;
  if(Math.abs(diff) <= 0.1) return {pct:0, label:'at/near target', repeat:7};
  if(diff > 0.1) return {pct:-0.03, label:'small decrease toward target', repeat:5};
  return {pct:+0.03, label:'small increase toward target', repeat:5};
}

function sched7EndOnDate(d){ let s=0; for(let k=6;k>=0;k--){ const key=isoLocal(addDaysLocal(d,-k)); s+=schedAtIso(key) } return r01(s) }

function markNeedsRecalc(){
  if(hasReco){
    pendingRecalc=true;
    const btn=document.getElementById('recalcNow');
    if(btn){ btn.disabled=false; btn.style.opacity=''; }
    const hint=document.getElementById('recalcHint');
    if(hint) hint.style.display='inline';
  }
}

/* ===========================
   Weighted-dose helpers (lag-aware)
   =========================== */
function weightedDose7BeforeDateWithGetter(date, getterFn){
  const weights = [0.4,0.4,1.0,1.0,0.7,0.7,0.3];
  let sum = 0;
  for(let i=1;i<=7;i++){
    const key = isoLocal(addDaysLocal(date, -i));
    sum += getterFn(key) * weights[i-1];
  }
  return r01(sum);
}
function weightedDose7BeforeDate(date){ return weightedDose7BeforeDateWithGetter(date, effAtIso); }
function weightedDose7BeforeDateScheduled(date){ return weightedDose7BeforeDateWithGetter(date, schedAtIso); }
function weightedDose7FromNext7Array(next7){
  const weights = [0.3,0.7,0.7,1.0,1.0,0.4,0.4];
  let sum=0;
  for(let i=0;i<7;i++){
    const v = Number(next7[i]||0);
    if(!isNaN(v)) sum += v * weights[i];
  }
  return r01(sum);
}
function weightedDose7FromPrior7Array(prior7){
  const weights = [0.4,0.4,1.0,1.0,0.7,0.7,0.3];
  let sum=0;
  for(let i=0;i<7;i++){
    const v = Number(prior7[i]||0);
    if(!isNaN(v)) sum += v * weights[i];
  }
  return r01(sum);
}
function buildInrDoseDataset(){
  const data = [];
  const t = new Date();
  for(let offset=-120; offset<=0; offset++){
    const d = addDaysLocal(t, offset);
    const key = isoLocal(d);
    if(!inrVal.has(key)) continue;
    const inr = inrVal.get(key);
    const dose7 = weightedDose7BeforeDate(d);
    if(!isNaN(inr) && dose7 > 0) data.push({dose7, inr});
  }
  return data;
}
function fitLinearDoseInrModel(data){
  if(!data || data.length < 5) return null;
  let sumX=0,sumY=0,sumXY=0,sumXX=0;
  const n = data.length;
  for(const pt of data){
    const x = pt.dose7, y = pt.inr;
    sumX += x; sumY += y; sumXY += x*y; sumXX += x*x;
  }
  const denom = (n*sumXX - sumX*sumX);
  if(denom === 0) return null;
  const b = (n*sumXY - sumX*sumY) / denom;
  const a = (sumY - b*sumX) / n;
  if(b <= 0.01){
    return { invalid:true, reason:'Dose–response direction unclear or inverse (reactive dosing / limited stable history).', n };
  }
  return { a, b, n };
}
function predictInrForDose7(model, dose7){
  if(!model || model.invalid) return null;
  const raw = model.a + model.b * dose7;
  return Math.max(0.5, Math.min(8.0, r01(raw)));
}

/* ===========================
   Progressive interval / stability streak
   =========================== */
function findNearestInrAroundDate(targetDate, windowDays=2){
  const candidates=[];
  for(let d=-windowDays; d<=windowDays; d++){
    const key = isoLocal(addDaysLocal(targetDate, d));
    if(inrVal.has(key)){
      candidates.push({key, date:addDaysLocal(targetDate,d), inr:inrVal.get(key), dist:Math.abs(d)});
    }
  }
  if(!candidates.length) return null;
  candidates.sort((a,b)=> a.dist - b.dist);
  return candidates[0];
}
function computeWeeklyInRangeStreak(L,H, anchorDate){
  const used=[];
  let anchor = findNearestInrAroundDate(anchorDate, 2);
  if(!anchor) return {streak:0, used:[]};
  if(anchor.inr < L || anchor.inr > H) return {streak:0, used:[anchor]};
  used.push(anchor);
  let streak=1;
  for(let k=1;k<=4;k++){
    const target = addDaysLocal(anchor.date, -7*k);
    const prev = findNearestInrAroundDate(target, 2);
    if(!prev) break;
    if(prev.inr >= L && prev.inr <= H){
      used.push(prev);
      streak++;
    }else{ break; }
  }
  return {streak, used};
}
function progressiveIntervalDaysFromStreak(streak){
  if(!streak || streak < 1) return 7;
  return 7 * Math.min(streak, 5);
}

/* ===========================
   Recommendation engine
   =========================== */
function maybeAdjustRepeatForInteractions(currentRepeatIso){
  const auto = document.getElementById('autoAdjustRepeat');
  if(!auto || !auto.checked) return currentRepeatIso;
  const sum = interactionSummary(currentInteractionHits);
  if(!sum || sum.minSuggestedDays == null) return currentRepeatIso;
  const proposed = isoLocal(addDaysLocal(new Date(), sum.minSuggestedDays));
  if(!currentRepeatIso) return proposed;
  return (proposed < currentRepeatIso) ? proposed : currentRepeatIso;
}
function getGoalBounds(){
  const goalVal = document.getElementById('goal').value;
  const L = (goalVal==='2-3')?2.0:(goalVal==='2.5-3.5')?2.5:parseFloat(document.getElementById('gL').value);
  const H = (goalVal==='2-3')?3.0:(goalVal==='2.5-3.5')?3.5:parseFloat(document.getElementById('gH').value);
  return {L,H};
}
function getTargetInrIfEnabled(L,H){
  const panel = document.getElementById('targetPanel');
  if(!panel || panel.style.display==='none') return null;
  const t = parseFloat(document.getElementById('targetInr').value);
  if(isNaN(t)) return null;
  if(t < L || t > H) return null;
  return r01(t);
}
function modelBlockHTML(contextLabel, dose7, model){
  if(!model){
    return `<div class="betaBlock" style="margin-top:8px;padding:8px 10px;border-radius:10px;background:#fff3cd;border:1px solid #ffe08a;font-size:13px;">
      <b>Personal trend insight (beta):</b> Not enough usable history yet. Add more INR values over time (with doses recorded) to activate this section.
    </div>`;
  }
  if(model.invalid){
    return `<div class="betaBlock" style="margin-top:8px;padding:8px 10px;border-radius:10px;background:#fff3cd;border:1px solid #ffe08a;font-size:13px;">
      <b>Personal trend insight (beta):</b> Not shown because the dose→INR direction looks unreliable in the available history.
      <div class="small" style="margin-top:4px;color:#8a0000;"><b>${model.reason}</b></div>
    </div>`;
  }
  const est = predictInrForDose7(model, dose7);
  return `<div class="betaBlock" style="margin-top:8px;padding:8px 10px;border-radius:10px;background:#fff3cd;border:1px solid #ffe08a;font-size:13px;">
    <b>Personal trend insight (beta):</b> ${contextLabel} lag-weighted 7-day dose is <b>${stripZeros(dose7.toFixed(1))} mg</b>.
    Based on <b>${model.n}</b> past INR points, this dose usually lines up with an INR around <b>${(est!=null?est.toFixed(1):'—')}</b>.
    <div class="small" style="margin-top:4px;">This is a <b>trend estimate</b> only (helps explain direction), and does not override clinic protocol.</div>
  </div>`;
}

function getRecHTMLForPDF(){
  const tmp = document.createElement('div');
  tmp.innerHTML = rec.innerHTML || '';
  tmp.querySelectorAll('.betaBlock').forEach(n=>n.remove());
  return tmp.innerHTML || '<span class="small">No recommendation generated yet.</span>';
}

function reco(){
  const {L,H} = getGoalBounds();
  if(isNaN(L)||isNaN(H)||L>=H){ alert('Set a valid INR goal.'); return }
  if(baseSum()<=0){ alert('Enter baseline regimen first.'); return }

  const tabletWarn = document.getElementById('tabletWarn');
  if(tabletWarn) tabletWarn.style.display='none';

  pendingRecalc=false;
  const hint=document.getElementById('recalcHint');
  if(hint) hint.style.display='none';
  const btn=document.getElementById('recalcNow');
  if(btn){ btn.disabled=true; btn.style.opacity='0.5'; }

  const todayIso = isoLocal(new Date());
  let bestDate = new Date();
  let bestVal = parseFloat(document.getElementById('inr').value);

  if(isNaN(bestVal) && inrVal.has(todayIso)) bestVal = inrVal.get(todayIso), bestDate=new Date();
  if(isNaN(bestVal)){
    for(let d=1; d<=3; d++){
      const key = isoLocal(addDaysLocal(new Date(), -d));
      if(inrVal.has(key)){ bestVal=inrVal.get(key); bestDate=addDaysLocal(new Date(), -d); break; }
    }
  }
  if(isNaN(bestVal)){
    rec.innerHTML = 'No recent INR in the last 3 days. <b>Get a new INR as soon as possible.</b> Do not change warfarin until a new result is available.';
    repeatKey = todayIso; hasReco=true;
    lastRecoINR = null; lastRepeatIso = null;
    applyPlanToCalendar(todayIso, plannedOrSchedAtIso(todayIso), repeatKey);
    return;
  }

  const age = daysBetween(bestDate, new Date());
  const target = getTargetInrIfEnabled(L,H);
  const usingTarget = (target!=null);

  const band = usingTarget ? pickPctWithTarget(bestVal, L, H, target) : pickPct(bestVal, L, H);
  const dataset = buildInrDoseDataset();
  const model = fitLinearDoseInrModel(dataset);

  const interHTML = buildInteractionHTML(currentInteractionHits);

  const wEffPrior = weightedDose7BeforeDate(new Date());
  const wSchedPrior = weightedDose7BeforeDateScheduled(new Date());

  const weightExplain = `<div class="small" style="margin-top:6px;color:#666;">
    <b>Lag-weighted dose (7-day):</b> recent doses count more than older doses (because INR responds with delay).
    Prior-7-days (effective) ≈ <b>${stripZeros(wEffPrior.toFixed(1))} mg</b>.
  </div>`;

  // In-range path
  if(band.pct===0){
    const useProg = document.getElementById('useProgressiveInterval')?.checked;
    let rep;

    let streakInfo = {streak:0, used:[]};
    if(useProg){ streakInfo = computeWeeklyInRangeStreak(L,H,bestDate); }

    const streak = streakInfo.streak || 0;
    const intervalDays = (useProg && streak>=1) ? progressiveIntervalDaysFromStreak(streak) : 7;

    rep = addDaysLocal(bestDate, intervalDays);

    repeatKey = isoLocal(rep);
    repeatKey = maybeAdjustRepeatForInteractions(repeatKey);

    lastRecoINR = bestVal;
    lastRepeatIso = repeatKey;

    const streakLine = (useProg && streak>0)
      ? `<div class="small" style="margin-top:6px;color:#666;">
          <b>Stability streak:</b> <b>${streak}</b> consecutive in-range weekly INR(s).
          ${streak>=2 ? `Eligible for extended interval to ${Math.min(streak,5)} week(s) <b>(if appropriate)</b>.` : ''}
        </div>`
      : '';

    const ifAppropriate = (useProg && streak>=2) ? ' <span class="small">(if appropriate)</span>' : '';

    rec.innerHTML =
      `INR <b>${bestVal.toFixed(1)}</b> is in your goal range (${L}–${H}). ` +
      `<b>No change</b> to today’s warfarin dose. ` +
      `Repeat your INR on <b>${niceDate(repeatKey)}</b>${ifAppropriate}.` +
      streakLine +
      weightExplain +
        modelBlockHTML('Your', wEffPrior, model) +
  getBridgingBlockHTML() +
      (interHTML || '') +
  getBridgingHTML();

    hasReco=true;

    // ✅ make calendar reflect it
    applyPlanToCalendar(todayIso, plannedOrSchedAtIso(todayIso), repeatKey);
    return;
  }

  // Adjustment path (weighted-dose-aware adherence correction)
  const baseToday = schedAtIso(todayIso);
  const s7 = sched7EndOnDate(new Date());

  const targetDelta = r01(s7 * band.pct);
  const priorDelta = r01(wEffPrior - wSchedPrior);
  const remaining   = r01(targetDelta - priorDelta);

  const naive = r01((wEffPrior + baseToday) * band.pct);
  const sign  = remaining>0?1:-1;
  const capped= Math.min(Math.abs(naive), Math.abs(remaining)) * sign;
  const targetDose = Math.max(0, r01(baseToday + capped));
  let newDose = r05(targetDose);

  // Tablet constraint (today only)
  const useConstraint = document.getElementById('useTabletConstraint')?.checked;
  let tabletLineHTML = '';
  if(useConstraint){
    const strengths = getSelectedTabletStrengths();
    if(!strengths.length){
      if(tabletWarn) tabletWarn.style.display='block';
      tabletLineHTML = `<div class="small" style="margin-top:6px;color:#8a0000;"><b>Tablet constraint is ON</b> but no strengths are selected. Turn OFF or select strengths.</div>`;
    }else{
      const res = findBestFeasibleDose(newDose, strengths, 0.5, 0.10);
      if(res.ok){
        const constrained = r025(res.dose);
        newDose = constrained;
        tabletLineHTML = `
          <div class="small" style="margin-top:6px;color:#666;">
            <b>Tablet-aware dosing (whole/half only):</b> today’s planned dose set to <b>${formatDose(newDose)} mg</b>
            using <b>${res.comboText}</b>.
          </div>
        `;
      }else{
        if(res.closest){
          tabletLineHTML = `
            <div class="small" style="margin-top:6px;color:#8a0000;">
              <b>Tablet-aware dosing:</b> ${res.reason}
              <br>Closest whole/half option: <b>${formatDose(res.closest.dose)} mg</b> using <b>${res.closest.comboText}</b>.
              Consider prescribing a new strength if needed.
            </div>
          `;
        }else{
          tabletLineHTML = `<div class="small" style="margin-top:6px;color:#8a0000;"><b>Tablet-aware dosing:</b> ${res.reason} Consider prescribing a new strength.</div>`;
        }
      }
    }
  }

  let repDate;
  if(bestVal>4.5) repDate = addDaysLocal(new Date(), 2);
  else if(age>=2 && age<=3) repDate = addDaysLocal(bestDate, 7);
  else repDate = addDaysLocal(new Date(), band.repeat || 7);

  repeatKey = isoLocal(repDate);
  repeatKey = maybeAdjustRepeatForInteractions(repeatKey);

  lastRecoINR = bestVal;
  lastRepeatIso = repeatKey;

  const isHigh = bestVal > H;
  const isLow  = bestVal < L;

  let context = '';
  if(usingTarget && !isHigh && !isLow){
    context = `Target INR is <b>${target.toFixed(1)}</b> (within ${L}–${H}). `;
  }

  const dirText = isHigh ? 'above' : isLow ? 'below' : 'within';
  const withinButTarget = usingTarget && !isHigh && !isLow;

  const mainSentence = withinButTarget
    ? `INR <b>${bestVal.toFixed(1)}</b> is <b>within</b> your goal range (${L}–${H}). ${context}`
      + `To gently move toward the target, take <b>${formatDose(newDose)} mg of warfarin today</b>.`
    : `INR <b>${bestVal.toFixed(1)}</b> is <b>${dirText}</b> your goal range (${L}–${H}). `
      + `Take <b>${formatDose(newDose)} mg of warfarin today</b> based on your recent dosing.`;

  const steerExplain = withinButTarget
    ? `<div class="small" style="margin-top:6px;color:#666;">
         <b>Why a small change even though you’re “in range”?</b> Some situations (often procedures) prefer the INR toward the lower end.
         ThromboLogic uses only a <b>~3%</b> nudge and asks for a sooner recheck to confirm safety.
       </div>`
    : '';

  rec.innerHTML =
    mainSentence +
    ` Plan to recheck your INR on <b>${niceDate(repeatKey)}</b>, or sooner if your clinic advises.` +
    tabletLineHTML +
    `<div class="small" style="margin-top:6px;color:#666;">
      <b>Lag-weighted dose (7-day):</b> prior-7-days effective ≈ <b>${stripZeros(wEffPrior.toFixed(1))} mg</b>. Prior-7-days scheduled ≈ <b>${stripZeros(wSchedPrior.toFixed(1))} mg</b>.
      <br><b>Weighted adherence delta:</b> ${stripZeros(priorDelta.toFixed(1))} mg (used to avoid over/under-reacting to missed/extra doses).
    </div>` +
    steerExplain +
    modelBlockHTML('Your', wEffPrior, model) +
getBridgingBlockHTML() +
(interHTML || '');

  hasReco=true;

  // ✅ make calendar reflect it (today dose + fill until repeat)
  applyPlanToCalendar(todayIso, newDose, repeatKey);
}

/* ===========================
   Week rows for PDF
   =========================== */
const weekdays = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

function buildWeekRows(startDate){
  let rows = '';
  for(let i=0;i<7;i++){
    const d = addDaysLocal(startDate, i);
    const key = isoLocal(d);
    const dayName = weekdays[d.getDay()];
    const dateStr = pad(d.getMonth()+1)+'/'+pad(d.getDate());

    const plannedDose = planned.has(key) ? planned.get(key) : NaN;
    const inrValNum   = inrVal.has(key) ? inrVal.get(key) : NaN;
    const actualDose  = actual.has(key) ? actual.get(key) : NaN;

    const plannedStr = isNaN(plannedDose) ? '—' : formatDoseWithUnit(plannedDose);
    const inrStr     = isNaN(inrValNum)   ? '—' : inrValNum.toFixed(1);
    const actualStr  = isNaN(actualDose)  ? '—' : formatDoseWithUnit(actualDose);
    const notesStr   = (repeatKey === key) ? 'Repeat INR' : '';

    rows += `
      <tr>
        <td>${dayName}</td>
        <td>${dateStr}</td>
        <td>${plannedStr}</td>
        <td>${inrStr}</td>
        <td>${actualStr}</td>
        <td>${notesStr}</td>
      </tr>`;
  }
  return rows;
}

/* ===========================
   PDF + Handout (unchanged from your version)
   =========================== */
function exportRecommendationPDF(){
  const todayStr = isoLocal(today);
  const now = new Date();
  const timeStr = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

  const pName = (document.getElementById('patientName')?.value || '').trim();
  const pDob  = (document.getElementById('patientDob')?.value  || '').trim();
  const pMrn  = (document.getElementById('patientMrn')?.value  || '').trim();

  const patientInfoLine = [
    pName ? '<strong>Patient Name:</strong> ' + pName : '',
    pDob  ? '<strong>DOB:</strong> ' + pDob : '',
    pMrn  ? '<strong>MRN:</strong> ' + pMrn : ''
  ].filter(Boolean).join('&nbsp;&nbsp;&nbsp;&nbsp;');

  const thisWeekStart = startOfWeekLocal(today);
  const nextWeekStart = addDaysLocal(thisWeekStart, 7);

  const thisWeekRows = buildWeekRows(thisWeekStart);
  const nextWeekRows = buildWeekRows(nextWeekStart);

  const inrDisplay = lastRecoINR != null ? lastRecoINR.toFixed(1) : '—';
  const repDisplay = lastRepeatIso ? niceDate(lastRepeatIso) : '—';

  const cleanRecHTML = getRecHTMLForPDF();

  const html = `
    <html>
    <head>
      <meta charset="utf-8">
      <title>ThromboLogic INR – Recommendation</title>
      <style>
        body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:16px;color:#111;}
        h1{font-size:18px;margin-bottom:2px;}
        h2{font-size:14px;margin:12px 0 4px;}
        .small{font-size:11px;color:#555;}
        table{border-collapse:collapse;width:100%;font-size:11px;margin-top:4px;}
        th,td{border:1px solid #ccc;padding:3px 4px;text-align:left;}
        th{background:#f3f3f3;font-weight:600;}
        .card{border:1px solid #ccc;border-radius:8px;padding:8px;margin:6px 0;background:#fafafa;}
        .summary-line{margin-top:8px;font-size:14px;}
        .summary-line b.big{font-size:18px;}
        .sig-block{margin-top:16px;font-size:11px;}
        .notes-box{min-height:60px;outline:none;white-space:pre-wrap;font-size:12px;}
        .footer{margin-top:14px;padding-top:8px;border-top:1px solid #eee;font-size:10px;color:#777;text-align:center;}
        @media print { .noPrint{display:none !important;} }
      </style>
    </head>
    <body>
      <div class="noPrint small" style="margin-bottom:8px;">Tip: use your device print dialog to “Save as PDF”.</div>

      <h1>ThromboLogic INR – Visit Summary</h1>
      <div class="small">Generated on ${todayStr} at ${timeStr}</div>
      ${patientInfoLine ? `<div class="small" style="margin-top:4px;">${patientInfoLine}</div>` : ''}

      <div class="summary-line">
        Latest INR:&nbsp;<b class="big">${inrDisplay}</b>
        &nbsp;&nbsp;&nbsp;
        Repeat INR date:&nbsp;<b class="big">${repDisplay}</b>
      </div>

      <h2>Verbal Recommendation</h2>
      <div class="card">
        ${cleanRecHTML}
      </div>

      <h2>This Week's Calendar View</h2>
      <div class="card">
        <table>
          <thead>
            <tr>
              <th>Day</th><th>Date</th><th>Planned dose (mg)</th><th>INR</th><th>Actual dose (mg)</th><th>Notes</th>
            </tr>
          </thead>
          <tbody>${thisWeekRows}</tbody>
        </table>
      </div>

      <h2>Next Week's Calendar View</h2>
      <div class="card">
        <table>
          <thead>
            <tr>
              <th>Day</th><th>Date</th><th>Planned dose (mg)</th><th>INR</th><th>Actual dose (mg)</th><th>Notes</th>
            </tr>
          </thead>
          <tbody>${nextWeekRows}</tbody>
        </table>
      </div>

      <h2>Provider Notes</h2>
      <div class="card notes-box" contenteditable="true"
           onfocus="if(this.getAttribute('data-edited')!=='1'){this.innerHTML='';this.setAttribute('data-edited','1');}">
        Click here to type provider notes before printing.
      </div>

      <div class="sig-block">
        ________________________________<br>
        Provider Signature &nbsp;&nbsp;&nbsp; Date: ____________
      </div>

      <div class="footer">${versionStampText()}</div>
    </body>
    </html>
  `;

  printHtmlDocument(html);
}

function openPatientHandout(){
  const todayStr = isoLocal(today);
  const now = new Date();
  const timeStr = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

  const pName = (document.getElementById('patientName')?.value || '').trim();
  const pDob  = (document.getElementById('patientDob')?.value  || '').trim();
  const pMrn  = (document.getElementById('patientMrn')?.value  || '').trim();

  const patientInfoLine = [
    pName ? '<strong>Patient Name:</strong> ' + pName : '',
    pDob  ? '<strong>DOB:</strong> ' + pDob : '',
    pMrn  ? '<strong>MRN:</strong> ' + pMrn : ''
  ].filter(Boolean).join('&nbsp;&nbsp;&nbsp;&nbsp;');

  const thisWeekStart = startOfWeekLocal(today);
  const nextWeekStart = addDaysLocal(thisWeekStart, 7);

  const thisWeekRows = buildWeekRows(thisWeekStart);
  const nextWeekRows = buildWeekRows(nextWeekStart);

  const inrDisplay = lastRecoINR != null ? lastRecoINR.toFixed(1) : '—';
  const repDisplay = lastRepeatIso ? niceDate(lastRepeatIso) : '—';

  const cleanRecHTML = getRecHTMLForPDF();

  const html = `
    <html>
    <head>
      <meta charset="utf-8">
      <title>ThromboLogic INR – Patient Handout</title>
      <style>
        body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:18px;color:#111;}
        h1{font-size:18px;margin-bottom:2px;}
        h2{font-size:14px;margin:12px 0 4px;}
        .small{font-size:11px;color:#555;}
        table{border-collapse:collapse;width:100%;font-size:11px;margin-top:4px;}
        th,td{border:1px solid #ccc;padding:3px 4px;text-align:left;}
        th{background:#f3f3f3;font-weight:600;}
        .card{border:1px solid #ccc;border-radius:8px;padding:8px;margin:6px 0;background:#fafafa;}
        .summary-line{margin-top:8px;font-size:14px;}
        .summary-line b.big{font-size:18px;}
        .footer{margin-top:14px;padding-top:8px;border-top:1px solid #eee;font-size:10px;color:#777;text-align:center;}
      </style>
    </head>
    <body>
      <h1>ThromboLogic INR – Patient Dosing Summary</h1>
      <div class="small">Generated on ${todayStr} at ${timeStr}</div>
      ${patientInfoLine ? `<div class="small" style="margin-top:4px;">${patientInfoLine}</div>` : ''}

      <div class="summary-line">
        Latest INR:&nbsp;<b class="big">${inrDisplay}</b>
        &nbsp;&nbsp;&nbsp;
        Repeat INR date:&nbsp;<b class="big">${repDisplay}</b>
      </div>

      <h2>Dosing Recommendation</h2>
      <div class="card">
        ${cleanRecHTML}
      </div>

      <h2>This Week's Calendar View</h2>
      <div class="card">
        <table>
          <thead>
            <tr>
              <th>Day</th><th>Date</th><th>Planned dose (mg)</th><th>INR</th><th>Actual dose (mg)</th><th>Notes</th>
            </tr>
          </thead>
          <tbody>${thisWeekRows}</tbody>
        </table>
      </div>

      <h2>Next Week's Calendar View</h2>
      <div class="card">
        <table>
          <thead>
            <tr>
              <th>Day</th><th>Date</th><th>Planned dose (mg)</th><th>INR</th><th>Actual dose (mg)</th><th>Notes</th>
            </tr>
          </thead>
          <tbody>${nextWeekRows}</tbody>
        </table>
      </div>

      <div class="footer">${versionStampText()}</div>
    </body>
    </html>
  `;

  openHandoutModal(html);
}

/* ===========================
   Prediction + Demo + Bridging + DOM listeners
   ===========================
   NOTE: These sections are unchanged from your file except for the
   recommendation->calendar fix above, and the parseIsoLocal helper.
   For brevity here, I’m leaving them exactly as you provided.
   (If you want, I can also re-paste those unchanged sections verbatim.)
*/

/* ===========================
   DOM init + listeners (your original)
   =========================== */
document.addEventListener('DOMContentLoaded', ()=>{
  loadState();

  try{ renderAll(); updSum(); }catch(e){ err.textContent = 'Calendar failed to render: '+e; }

  const searchEl = document.getElementById('profileSearch');
  activeProfileId = localStorage.getItem(ACTIVE_PROFILE_KEY) || null;

  renderProfileList('');
  updateCurrentLine();

  if(searchEl){
    searchEl.addEventListener('input', ()=> renderProfileList(searchEl.value));
    searchEl.addEventListener('focus', ()=> renderProfileList(searchEl.value));
  }

  document.getElementById('btnNewPatient')?.addEventListener('click', ()=>{
    guardUnsaved(()=>{
      activeProfileId = null;
      localStorage.removeItem(ACTIVE_PROFILE_KEY);
      resetToBlankPatient();
      clearDirty();
      renderProfileList(searchEl?.value || '');
      updateCurrentLine();
    });
  });

  document.getElementById('btnSavePatient')?.addEventListener('click', ()=>{ saveActiveProfile(); });
  document.getElementById('btnSaveAsPatient')?.addEventListener('click', ()=>{ saveAsNewProfile(); });
  document.getElementById('btnDeletePatient')?.addEventListener('click', ()=>{ guardUnsaved(()=> deleteActiveProfile()); });

  setTimeout(scrollToTodayWeek, 50);

  const footer = document.createElement('div');
  footer.className = 'footerStamp';
  footer.textContent = versionStampText();
  document.querySelector('.container')?.appendChild(footer);

  for(let i=0;i<7;i++){
    const el=document.getElementById('b'+i);
    if(el){ el.addEventListener('input', ()=>{ updSum(); saveState(); }) }
  }

  document.getElementById('goal').addEventListener('change', (ev)=>{
    const v = ev.target.value;
    document.getElementById('cust').style.display = (v==='custom')?'block':'none';

    const panel = document.getElementById('targetPanel');
    const tEl = document.getElementById('targetInr');
    if(panel && panel.style.display!=='none' && tEl && (tEl.value==='' || isNaN(parseFloat(tEl.value)))){
      const {L} = getGoalBounds();
      tEl.value = L.toFixed(1);
    }
  });

  const toggleBtn = document.getElementById('toggleTarget');
  const targetPanel = document.getElementById('targetPanel');
  const targetInr = document.getElementById('targetInr');
  if(toggleBtn && targetPanel){
    toggleBtn.addEventListener('click', ()=>{
      const show = (targetPanel.style.display === 'none');
      targetPanel.style.display = show ? 'block' : 'none';
      if(show){
        const {L} = getGoalBounds();
        if(targetInr && (targetInr.value==='' || isNaN(parseFloat(targetInr.value)))){
          targetInr.value = L.toFixed(1);
        }
      }
    });
  }

  const useTab = document.getElementById('useTabletConstraint');
  const tabPanel = document.getElementById('tabletPanel');
  const tabWarn  = document.getElementById('tabletWarn');
  if(useTab && tabPanel){
    useTab.addEventListener('change', ()=>{
      const on = useTab.checked;
      tabPanel.style.display = on ? 'block' : 'none';
      if(!on && tabWarn) tabWarn.style.display='none';
    });
  }

  const medList = document.getElementById('medList');
  const results = document.getElementById('interactionResults');
  function renderInteractions(){
    const hits = matchInteractions(medList.value || '');
    currentInteractionHits = hits;
    if(!hits.length){
      results.style.display='none';
      results.innerHTML='';
      return;
    }
    results.style.display='block';
    results.innerHTML = buildInteractionHTML(hits);
  }
  document.getElementById('checkInteractions').addEventListener('click', renderInteractions);
  document.getElementById('clearInteractions').addEventListener('click', ()=>{
    medList.value='';
    currentInteractionHits=[];
    results.style.display='none';
    results.innerHTML='';
  });
  medList.addEventListener('blur', ()=>{ if(medList.value.trim()) renderInteractions(); });

  const inrTop = document.getElementById('inr');
  const tIso = isoLocal(new Date());
  inrTop.addEventListener('input', e=>{
    const v = parseFloat(e.target.value);
    if(!isNaN(v)) inrVal.set(tIso, v); else inrVal.delete(tIso);
  });
  inrTop.addEventListener('blur', e=>{
    const v = parseFloat(e.target.value);
    if(!isNaN(v)){
      const vv = r01(v);
      inrVal.set(tIso, vv);
      const qi = document.querySelector('#c_'+tIso+' .cell-input.inrbox');
      if(qi) qi.value = vv.toFixed(1);
    }else{
      inrVal.delete(tIso);
    }
    if(hasReco){ markNeedsRecalc(); }
    pushDataToCells(); lin7();
  });

  document.getElementById('getRec').addEventListener('click', ()=>{ reco(); saveState(); });

  const recalcBtn = document.getElementById('recalcNow');
  if(recalcBtn){
    recalcBtn.disabled = true;
    recalcBtn.style.opacity = '0.5';
    recalcBtn.addEventListener('click', ()=>{ if(!hasReco && !pendingRecalc){ return; } reco(); });
  }

  document.getElementById('applyCur').addEventListener('click', ()=>{ applyVisible(); saveState(); });
  document.getElementById('clearVisible').addEventListener('click', ()=>{ clearVisible(); saveState(); });
  document.getElementById('clearAll').addEventListener('click', ()=>{ clearAll(); saveState(); });

  const goTodayBtn = document.getElementById('goToday');
  if (goTodayBtn) goTodayBtn.addEventListener('click', scrollToTodayWeek);

  const exportBtn = document.getElementById('exportPDF');
  if (exportBtn) exportBtn.addEventListener('click', exportRecommendationPDF);

  const handoutBtn = document.getElementById('patientHandout');
  if (handoutBtn) handoutBtn.addEventListener('click', openPatientHandout);

  // Delegated inputs for calendar
  weeksEl.addEventListener('input', (e)=>{
    const t = e.target;
    if(!(t instanceof HTMLInputElement)) return;
    const key = t.getAttribute('data-k'); const role = t.getAttribute('data-role');
    if(!key||!role) return;
    const v = t.value === '' ? NaN : parseFloat(t.value);
    if(role==='planned'){ if(isNaN(v)) planned.delete(key); else planned.set(key, v); }
    if(role==='actual'){ if(isNaN(v)) actual.delete(key); else actual.set(key, v); }
    if(role==='inr'){    if(isNaN(v)) inrVal.delete(key); else inrVal.set(key, v); }
  });

  weeksEl.addEventListener('blur', (e)=>{
    const t = e.target;
    if(!(t instanceof HTMLInputElement)) return;
    const key = t.getAttribute('data-k'); const role = t.getAttribute('data-role');
    if(!key||!role) return;
    const v = parseFloat(t.value);
    if(!isNaN(v)){
      if(role==='planned') planned.set(key, r025(v));
      if(role==='actual')  actual.set(key, r025(v));
      if(role==='inr')     inrVal.set(key, r01(v));
    }else{
      if(role==='planned') planned.delete(key);
      if(role==='actual')  actual.delete(key);
      if(role==='inr')     inrVal.delete(key);
    }
    if(role==='inr' && hasReco) markNeedsRecalc();
    pushDataToCells(); lin7();
    saveState();
  }, true);
});
</script>

</div>
</body>
</html>
